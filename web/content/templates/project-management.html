<!doctype html>
<html class="no-js" lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
    <title>Foundation Accelerator</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/custom.css" />
    <link rel="stylesheet" href="css/motion-ui.css" />
    <link rel="stylesheet" href="css/project-management.css" />
    <link rel="stylesheet" href="css/wickedpicker.css" />
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <link href='css/fullcalendar.css' rel='stylesheet' />
    <link href='css/scheduler.css' rel='stylesheet' />
    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
    <script src="js/jquery.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src='js/moment.min.js'></script>
    <script src='js/fullcalendar.min.js'></script>
    <script src='js/scheduler.min.js'></script>
    <script src='js/jquery.tablesorter.min.js'></script>
    <script src='js/map.js'></script>
    <script src='js/setup-progress.js'></script>
    <script src='js/zen.js'></script>
    <script src='js/wickedpicker.js'></script>
   
    <script>
    
        var evalMap = null;

        function initializeMap() {

            if ($('.fc-toolbar').length > 0) {
                var locations = $('#calendar').fullCalendar('clientEvents');
                var sD = $('#currentDate').val().split('-');
                var start = new Date(sD[0], sD[1] - 1, sD[2]);
                //var end = new Date(sD[0], sD[1] - 1, sD[2], 23, 59, 59, 999);
                var end = new Date(start.getTime() + 86400000);

                setMapLocations(locations, start, end);
            } else {
                //var date = (new Date()).toLocaleDateString();
                var date = new Date();
                var start = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
                var end = new Date(start.getTime() + 86400000);
                var timezone = null;
                var callback = null;

                getEvents(moment(start).format("YYYY/MM/DD"), moment(end).format("YYYY/MM/DD"), timezone, callback);
            }
        }

        function setMapLocations(locations, start, end) {
            if (evalMap == null || $('#calendarMap *').length == 0) {
                companyLatitude = "<?php echo $companyLatitude; ?>";  //FXLRATR-258
                companyLongitude = "<?php echo $companyLongitude; ?>"; //FXLRATR-258
                companyAddress1 = "<?php echo $companyAddress1; ?>"; //FXLRATR-258
                companyAddress2 = "<?php echo $companyAddress2; ?>"; //FXLRATR-258
                companyCity = "<?php echo $companyCity; ?>"; //FXLRATR-258
                companyZip = "<?php echo $companyZip; ?>"; //FXLRATR-258
                companyState = "<?php echo $companyState; ?>"; //FXLRATR-258
                companyFullAddress=""; //FXLRATR-258
                evalMap = new MapSet(document.getElementById('calendarMap'), '<?php echo $companyLatitude; ?>', '<?php echo $companyLongitude; ?>'); //FXLRATR-258.  
            
            }
            if (typeof (start) == "string")
                start = moment(start, "YYYY MM DD");
            if (typeof (end) == "string")
                end = moment(end, "YYYY MM DD");
            evalMap.SetMapLocations(locations, start, end);

            var propLatLng = { lat: parseFloat($('#latitude').text()), lng: parseFloat($('#longitude').text()) };
            if (isNaN(propLatLng.lat) || isNaN(propLatLng.lng) || (propLatLng.lat == 0 && propLatLng.lng == 0)) {
                evalMap.MapAddress($('#address').text(), $('#city').text(), $('#state').text(), $('#zip').text(), 'useAddress', null);
                // evalMap.MapAddress(companyFullAddress, companyCity, companyState, companyZip, "useAddress", null);
            }
            else {
                evalMap.MapLocation($('#latitude').text(), $('#longitude').text(), $('#address').text());
            }
        }

        function clearMap() {
            if (map != null) map.RemoveMapLocations();
        }

        function getProjectDocuments(){
            //Get Project Documents
            $.ajax({
                url: 'getProjectDocuments.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: $('#projectID').attr('value')
                },
                success: function (response) {
                    if (!response == '') {
                         $('#generalDocuments').append('<div id="projectDoc"><p class="no-margin">Additional Documents' + '<ul></ul></p></div>');

                        $.each(response, function (i, item) {;
                            $('#generalDocuments #projectDoc ul').append('<li><a target="_blank" href="image.php?cid=<?php echo $companyID;  ?>' +'&pid=' + item.projectID + '&type=projectdoc' + '&name=' + encodeURI(item.name) + '">' + item.description + '</a> <span><a desc="' + item.description + '" name="' + item.name + '" pid="' + item.projectID + '" documentID="' + item.projectDocumentID + '" class="deleteProjectDocument" target="_blank">(Delete)</a></span></li>');

                        });
                    }

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });
        }

        var sortGeneralBilling = function (evaluationID) {
            $('ul#' + evaluationID + ' li').sort(sort_li).appendTo('ul#' + evaluationID);
            function sort_li(a, b){
                return ($(b).attr('sort')) < ($(a).attr('sort')) ? 1 : -1;    
            }
        }

        var populateBillingInfo = function(){

            if (!$('#loading-image.billing').is(':visible')) {
                var quickbooksInvoiceComplete;
                var evaluationInvoiceComplete;


                $('#loading-image.billing').show();
                $("#billingTable > tbody").empty();
                $("#billingTable > tbody").hide();
                $('#generalBilling').empty();
                $('#generalBilling').append('<strong>Billing</strong>');
                $('#generalDocuments').empty();
                $('#generalDocuments').append('<strong>Documents</strong>');

                if ('<?php echo $qbConnectionStatus; ?>' == 'connected'){
                    
                    $.ajax({
                        url: 'getQuickbooksCustomerInvoices.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "GET",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            quickbooksID: '<?php echo $quickbooksID; ?>'
                        },
                        success: function (response) {
                            if (response != '') {
                                runQuickbooksInvoices(response);
                            } else {
                                quickbooksInvoiceComplete = true;
                                displayInvoiceTable();
                            }
                            
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });
                          

                } else {
                    quickbooksInvoiceComplete = true;
                    displayInvoiceTable();
                }
                
                $.ajax({
                    url: 'getEvaluationInvoices.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        projectID: $('#projectID').attr('value')
                    },
                    success: function (response) {
                        //console.log(response);
                        if (response != null) {
                            $('#viewStatementButton').show();
                        } else {
                            $('#viewStatementButton').hide();
                        }

                        runEvaluationInvoices(response);
                       
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                });
               
                
                function runEvaluationInvoices(evaluationInvoices){
                    if (!evaluationInvoices == '') {
                        $.each(evaluationInvoices, function (i, item) {
                            if ($('ul#' + item.evaluationID).length == 0){
                                //if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                    $('#generalBilling').append('<p class="no-margin">' + item.evaluationDescription + ' <span>Bid Total: $' + item.bidTotal + '</span></p><ul id="' + item.evaluationID + '"></ul>');
                                //}
                            }

                            if ($('p[evalID="' + item.evaluationID + '"]').length == 0){
                                $('#generalDocuments').append('<p evalID="' + item.evaluationID + '" class="no-margin">' + item.evaluationDescription + '<ul><li><a target="_blank" href="bid-accept-email.php?id=' + this.bidID + '&contractor=true">Customer Bid</a> <span></span></li></ul></p>');
                            }

                            var isCustom;
                            if (item.customEvaluation == null){
                                isCustom = 0;
                            }
                            else{
                                isCustom = 1;
                            }
                        
                            if  (item.invoiceType == 1 || item.invoiceType == 2){
                                // We need to check for null / empty because any bids done before the
                                // addition of the bidAcceptanceName / ProjectCompleteName will automatically
                                // have null.  
                                if(item.bidAcceptanceName == null || item.bidAcceptanceName == ''){
                                    item.bidAcceptanceName = "Bid Acceptance";
                                }

                                if(item.bidAcceptanceNumber == null){
                                    item.bidAcceptanceNumber = "";
                                }

                                //Should we check if bidAcceptanceQuickbooks == 1 and not connected to quickbooks? 

                                if ('<?php echo $qbConnectionStatus; ?>' == 'connected' && item.bidAcceptanceQuickbooks == 1) {
                                    var invoiceDisplay = '<a target="_blank" href="viewQuickbooksInvoice.php?invoice=' + item.bidAcceptanceNumber+'&project=<?php echo $projectID; ?>&name='+item.bidAcceptanceName+'">View Invoice</a>';

                                } else {
                                    var invoiceDisplay = '<a target="_blank" href="invoice.php?custom=' + isCustom + '&eid=' + item.evaluationID + '&invoice=accept">View</a> | <a target="_blank" href="invoice.php?custom=' + isCustom + '&eid=' + item.evaluationID + '&invoice=accept&email=send">Send</a>';
                                }

                                $('#billingTable tbody').append(
                                    '<tr id="' + item.evaluationID + '">' + 
                                        '<td>' + item.bidFirstSent + '</td>' +
                                        '<td>' + item.evaluationDescription + '</td>' +
                                        '<td>' + item.bidAcceptanceName + '</td>' + 
                                        '<td>' + item.bidAcceptanceNumber + '</td>' + 
                                        '<td>' + item.bidAcceptanceSplit + '%</td>' +
                                        '<td>$' + item.bidAcceptanceAmount + '</td>' +
                                        '<td>$' + item.bidTotal + '</td>' + 
                                        '<td>' + invoiceDisplay + '</td>' + 
                                        '<td>' + '<input type="checkbox" isCustom="' + isCustom + '" name="invoicePaid" invoiceType="accept" eid="' + item.evaluationID + '" sort="' + '0' + '">'+  
                                        '</td>' + 
                                    '</tr>'); 
                                if (item.invoicePaidAccept == '1'){
                                    $('input[type=checkbox][eid=' + item.evaluationID + '][invoiceType=' + 'accept' + ']').prop('checked', true);
                                }

                                $('ul#'+ item.evaluationID).append('<li sort="0">' + item.bidAcceptanceName + '<span> Total: $' + item.bidAcceptanceAmount + '</span></li></ul>');

                            } else if (item.invoiceType == 3){
                                if(item.invoiceNumber == null){
                                    item.invoiceNumber = "";
                                }

                                //Should we check if isQuickbooks == 1 and not connected to quickbooks? 

                                if ('<?php echo $qbConnectionStatus; ?>' == 'connected' && item.isQuickbooks == 1) {
                                    var invoiceDisplay = '<a target="_blank" href="viewQuickbooksInvoice.php?invoice=' + item.invoiceNumber+'&project=<?php echo $projectID; ?>&name='+item.invoiceName+'">View Invoice</a>';

                                } else {
                                    var invoiceDisplay = '<a target="_blank" href="invoice.php?custom=' + isCustom + '&eid=' + item.evaluationID + '&invoice='+ item.invoiceSort + '">View</a> | <a target="_blank" href="invoice.php?custom=' + isCustom + '&eid=' + item.evaluationID + '&invoice='+ item.invoiceSort + '&email=send">Send</a>';
                                }
                                

                                $('#billingTable tbody').append(
                                    '<tr id="' + item.evaluationID + '"></td>' + 
                                        '<td>' + item.bidFirstSent + '</td>' + 
                                        '<td>' + item.evaluationDescription + '</td>' + 
                                        '<td>' + item.invoiceName + '</td>' + 
                                        '<td>' + item.invoiceNumber + '</td>' + 
                                        '<td>' + item.invoiceSplit + '%</td>' + 
                                        '<td>$' + item.invoiceAmount + '</td>' + 
                                        '<td>$' + item.bidTotal + '</td>' + 
                                        '<td>' + invoiceDisplay + '</td>' + 
                                        '<td>' + '<input type="checkbox" name="invoicePaid" isCustom="' + isCustom + '" invoiceType="custom" eid="' + item.evaluationID + '" sort="' + item.invoiceSort + '">'+ '</td>'+ 
                                    '</tr>');

                                if (item.invoicePaid == '1'){
                                    $('input[type=checkbox][eid=' + item.evaluationID + '][sort=' + item.invoiceSort + ']').prop('checked', true);
                                }

                                $('ul#'+ item.evaluationID).append('<li sort="' + item.invoiceSort + '">' + item.invoiceName + '<span> Total: $' + item.invoiceAmount + '</span></li></ul>');

                            } else if (item.invoiceType == 4 || item.invoiceType == 5){
                                if(item.projectCompleteName == null || item.projectCompleteName == ''){
                                    item.projectCompleteName = "Project Complete";
                                }

                                if(item.projectCompleteNumber == null){
                                    item.projectCompleteNumber = "";
                                }

                                 //Should we check if projectCompleteQuickbooks == 1 and not connected to quickbooks? 

                                if ('<?php echo $qbConnectionStatus; ?>' == 'connected' && item.projectCompleteQuickbooks == 1) {
                                    var invoiceDisplay = '<a target="_blank" href="viewQuickbooksInvoice.php?invoice=' + item.projectCompleteNumber+'&project=<?php echo $projectID; ?>&name='+item.projectCompleteName+'">View Invoice</a>';

                                } else {
                                    var invoiceDisplay = '<a target="_blank" href="invoice.php?custom=' + isCustom + '&eid=' + item.evaluationID + '&invoice=complete">View</a> | <a target="_blank" href="invoice.php?custom=' + isCustom + '&eid=' + item.evaluationID + '&invoice=complete&email=send">Send</a>';
                                }

                                $('#billingTable tbody').append(
                                '<tr id="' + item.evaluationID + '">' + 
                                    '<td>' + item.bidFirstSent + '</td>' + 
                                    '<td>' + item.evaluationDescription + '</td>' +
                                    '<td>' + item.projectCompleteName + '</td>' +
                                    '<td>' + item.projectCompleteNumber + '</td>' +
                                    '<td>' + item.projectCompleteSplit + '%</td>' + 
                                    '<td>$' + item.projectCompleteAmount + '</td>' + 
                                    '<td>$' + item.bidTotal + '</td>' + 
                                    '<td>' + invoiceDisplay +  '</td>' + 
                                    '<td>' + '<input type="checkbox" name="invoicePaid" isCustom="' + isCustom + '" invoiceType="complete" eid="' + item.evaluationID + '" sort="' + '99' + '">'+ '</td>' + 
                                '</tr>');

                                if (item.invoicePaidComplete == '1'){
                                    $('input[type=checkbox][eid=' + item.evaluationID + '][invoiceType=' + 'complete' + ']').prop('checked', true);
                                }

                                $('ul#'+ item.evaluationID).append('<li sort ="99">' + item.projectCompleteName+ '<span> Total: $' + item.projectCompleteAmount + '</span></li></ul>');

                           } else if (item.invoiceType == 6 || item.invoiceType == 7){
                                if (item.bidScopeChangeType == 0){
                                    var bidScopeChangeName = 'Scope Change Invoice';
                                } else if (item.bidScopeChangeType == 1){
                                    var bidScopeChangeName = 'Scope Change Credit Memo';
                                }
                            
                                //Should we check if bidScopeChangeQuickbooks == 1 and not connected to quickbooks? 

                                if ('<?php echo $qbConnectionStatus; ?>' == 'connected' && item.bidScopeChangeQuickbooks == 1){
                                    if (item.bidScopeChangeType == 0) {
                                        var invoiceDisplay = '<a target="_blank" href="viewQuickbooksInvoice.php?invoice=' + item.bidScopeChangeNumber+'&project=<?php echo $projectID; ?>&name='+bidScopeChangeName+'">View Invoice</a>';
                                        var hideCheckbox = '';
                                    } else if (item.bidScopeChangeType == 1) {
                                        // var invoiceDisplay = '<a target="_blank" href="viewQuickbooksCreditMemo.php?creditMemo=' + item.bidScopeChangeNumber+'&project=<?php echo $projectID; ?>&name='+bidScopeChangeName+'">View Credit Memo</a>';
                                         var invoiceDisplay = '<a target="_blank" href="scope-change.php?custom=' + isCustom + '&eid=' + item.evaluationID + '">View Credit Memo</a>';
                                         var hideCheckbox = 'style="display:none;"';
                                    }
                                } else {
                                   

                                    if (item.bidScopeChangeType == 0) {
                                         var invoiceDisplay = '<a target="_blank" href="scope-change.php?custom=' + isCustom + '&eid=' + item.evaluationID + '">View Invoice</a>';
                                        var hideCheckbox = '';
                                    } else if (item.bidScopeChangeType == 1) {
                                         var invoiceDisplay = '<a target="_blank" href="scope-change.php?custom=' + isCustom + '&eid=' + item.evaluationID + '">View Credit Memo</a>';
                                        var hideCheckbox = 'style="display:none;"';
                                    }
                                }

                                $('#billingTable tbody').append(
                                '<tr id="' + item.evaluationID + '">' + 
                                    '<td>' + item.bidFirstSent + '</td>' + 
                                    '<td>' + item.evaluationDescription + '</td>' +
                                    '<td>' + bidScopeChangeName + '</td>' +
                                    '<td>' + item.bidScopeChangeNumber + '</td>' +
                                    '<td> </td>' + 
                                    '<td>$' + item.bidScopeChangeTotal + '</td>' + 
                                    '<td>$' + item.bidTotal + '</td>' + 
                                    '<td>' + invoiceDisplay +  '</td>' + 
                                    '<td>' + '<input '+hideCheckbox+' type="checkbox" name="invoicePaid" isCustom="' + isCustom + '" invoiceType="complete" eid="' + item.evaluationID + '" sort="' + '9999' + '">'+ '</td>' + 
                                '</tr>');

                                // if (item.invoicePaidComplete == '1'){
                                //     $('input[type=checkbox][eid=' + item.evaluationID + '][invoiceType=' + 'complete' + ']').prop('checked', true);
                                // }

                                // $('ul#'+ item.evaluationID).append('<li sort ="9999">' + item.projectCompleteName+ '<span> Total: $' + item.projectCompleteAmount + '</span></li></ul>');
                                
                            } else{
                                // console.log("no invoice type");
                            }

                            sortGeneralBilling(item.evaluationID);
                        });
                    }
                    sortTable();
                    evaluationInvoiceComplete = true;
                    displayInvoiceTable();
                    // $('#billingTable .header:contains("Evaluation Description")').click();
                    getProjectDocuments();
                }

                function runQuickbooksInvoices(quickbooksInvoices){
                    if (!quickbooksInvoices == '') {
                        $.each(quickbooksInvoices, function (i, item) {
                            $('#billingTable tbody tr').each(function(){
                                var rowInvoiceNumber = $(this).find('td').eq(3).text();
                                //console.log(rowInvoiceNumber);

                                if (rowInvoiceNumber == item.invoiceNumber) {
                                    if (item.paid == 1) {
                                        $(this).find('td').eq(8).find('input').prop({"checked": true, "disabled": true});  
                                    } else {
                                        $(this).find('td').eq(8).find('input').prop({"disabled": true});  
                                    }
                                    
                                }   
                            });
                        });

                        quickbooksInvoiceComplete = true;
                        displayInvoiceTable();
                    }
                }


                function displayInvoiceTable() {
                    if (quickbooksInvoiceComplete == true && evaluationInvoiceComplete == true) {
                        $("#billingTable > tbody").show();
                        $('#loading-image.billing').hide();
                    } 
                }
            }     
           
        };

        var decodeEntities = function (encodedString) {
            var textArea = document.createElement('textarea');
            textArea.innerHTML = encodedString;
            return textArea.value;
        }

        var today = new Date("<?php echo $todaysDateMDY;  ?>");

        var deleteProjectDocument = function(idToDelete, fileName, fileDescription){
            var projectID = $('#projectID').val();

            $.ajax({
                url: 'project-document-delete.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: projectID,
                    projectDocumentID: idToDelete,
                    fileName: fileName
                },
                success: function (response) {
                    //console.log(response);
                    $("#projectDoc").remove();
                    getProjectDocuments();
                    $('#deleteProjectDocumentModal').foundation('close');

                    $('#deleteSuccessModal p#modalMessage').text('Your file \'' + fileDescription + '\' has been deleted.');
                    $('#deleteSuccessModal').foundation('open');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        }

        $(document).ready(function () {
            populateBillingInfo();
            getMarketingTypes();

            var pageHeight = $( window ).height() * .85;
            $('#editCustomerModal').css('height',pageHeight);  

            $.ajax({
                url: 'getResources.php',
                dataType: 'json',
                contentType: 'application/json',
                type: 'GET',
                contentType: 'application/x-www-form-urlencoded',
                data: {
                    filter: 'sales'
                },
                success: function (response) {
                    if (response != null) {
                        $.each(response, function (i, item) {
                            $('#editCustomerModal select[name="projectSalesperson"]').append('<option value="' + item.id + '">' + item.title + '</option>');
                        });
                    }

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });

        //needed for Zendesk Help Ticket
        userInfo = {
            name: "<?php echo $userFirstName;  ?>" + " <?php echo $userLastName;  ?>",
            email: "<?php echo $userEmail;  ?>"
            }

        $('body').on('click', '.deleteProjectDocument', function() {
            var projectDocumentID = $(this).attr('documentid');
            var fileName = $(this).attr('name');
            var fileDescription = $(this).attr('desc');

            $('#deleteProjectDocumentModal #idToDelete').val(projectDocumentID);
            $('#deleteProjectDocumentModal #fileName').val(fileName);
            $('#deleteProjectDocumentModal #fileDescription').val(fileDescription);

            $('#deleteProjectDocumentModal').foundation('open');
        });

        $('#yesDeleteDocument').click(function (){
            var idToDelete = $('#deleteProjectDocumentModal #idToDelete').val();
            var fileName = $('#deleteProjectDocumentModal #fileName').val();
            var fileDescription = $('#deleteProjectDocumentModal #fileDescription').val();

            deleteProjectDocument(idToDelete, fileName, fileDescription);
        });

         //stops the iPad / Android Keybaord from popping up on the date picker
        $('#scheduledEndDate').prop('readonly', 'readonly');
        $('#scheduledStartDate').prop('readonly', 'readonly');
        $('input[name="scheduledStartTime"]').prop('readonly', 'readonly');
        $('input[name="scheduledEndTime"]').prop('readonly', 'readonly');

        if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ) {
            //change the input types for time to 
            //html 5 "time" so that we don't have
            //interface issues
            $('#scheduledStartTime').removeClass('timepicker');
            $('#scheduledEndTime').removeClass('timepicker');

            $('#scheduledStartTime').prop('type','time');
            $('#scheduledEndTime').prop('type', 'time');
        }

        $('#scheduledStartTime').focus(function(event){
            if( /iPhone|iPad|iPod/i.test(navigator.userAgent)){
                //without this, the time controls lost focus and made data entry impossible. 
                $(window).scrollTop(0);
            }
        });

        $('#scheduledEndTime').focus(function(event){
            if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ){
            //without this, the time controls lost focus and made data entry impossible.
                 $(window).scrollTop(0);
            } 
        });

        $('#scheduledStartDate').focus(function(event){
            if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ){
                //without this, the time controls lost focus and made data entry impossible. 
                // $('#modalFocuser').focus();
                $(window).scrollTop(0);
            }
        });

        $('#scheduledEndDate').focus(function(event){
            if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ){
                //without this, the time controls lost focus and made data entry impossible. 
                // $('#modalFocuser').focus();

                $(window).scrollTop(0);
            }
        });

        $('#scheduleSalesperson').focus(function(event){
            if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ){
            //without this, the time controls lost focus and made data entry impossible. 
            // $('#modalFocuser').focus();
                $(window).scrollTop(0);
            }
        });

        //show warning if scheduling date in past
        $('#scheduledStartDate').on('change', function(){
            $('.callout.small.alert').remove();
            if (new Date($('#scheduledStartDate').val()) < today || new Date($('#scheduledEndDate').val()) < today) {
                if ($('.callout.small.alert').length < 1){
                    $('#addEvent').append('<div class="callout small alert"><p>Please note that one of the selected dates is in the past.</p></div>');
                    $('#scheduledEndDate').trigger("change");
                }
            }
        });

        $('#scheduledEndDate').on('change', function(){
            $('.callout.small.alert').remove();
            if (new Date($('#scheduledStartDate').val()) < today|| new Date($('#scheduledEndDate').val()) < today) {
                if ($('.callout.small.alert').length < 1){
                    $('#addEvent').append('<div class="callout small alert"><p>Please note that one of the selected dates is in the past.</p></div>');
                }
            }
        });

        var link_tab = window.location.hash.substr(1);
           
            if(link_tab){
                $('[data-tabs]').eq(0).foundation('selectTab', $('#'+link_tab));
        
            }

            if (link_tab == 'billing') {
                populateBillingInfo();
            }

        $('#project-tabs').on('change.zf.tabs', function() {
         if($('#customer:visible').length){
            history.pushState(null, null, '#customer');
         }

          if($('#general:visible').length){
            history.pushState(null, null, '#general');
          }

          if($('#schedule:visible').length){
            history.pushState(null, null, '#schedule');
          }

          if($('#evaluation:visible').length){
            history.pushState(null, null, '#evaluation');
          }

          if($('#billing:visible').length){
            history.pushState(null, null, '#billing');
          }

          if($('#notes:visible').length){
            history.pushState(null, null, '#notes');
          }

          if($('#history:visible').length){
            history.pushState(null, null, '#history');
          }
        });
            $(function () {
                $(".datepickerFrom").datepicker({
                    defaultDate: "+1w",
                    changeMonth: true,
                    numberOfMonths: 1,
                    onClose: function (selectedDate) {
                        $(".datepickerTo").datepicker("option", "minDate", selectedDate);
                        $('#scheduledEndDate').trigger('change');
                    }
                });
                $(".datepickerTo").datepicker({
                    defaultDate: "+1w",
                    changeMonth: true,
                    numberOfMonths: 1,
                    onClose: function (selectedDate) {
                        $(".datepickerFrom").datepicker("option", "maxDate", selectedDate);
                    }
                });
            });

            //Enable/Disable Email Field On Click
            $('#editCustomerModal input[name="noEmailRequired"]').change(function (){
                if ($('#editCustomerModal input[name="noEmailRequired"]:checked').length > 0){
                    $('#editCustomerModal input[name="email"]').prop('disabled', true);
                    $('#editCustomerModal input[name="email"]').val('');
                    $('#editCustomerModal input[name="email"]').removeClass('customerRequired');
                    $('#editCustomerModal input[name="email"]').parent().removeClass('is-invalid-label');
                    $('#editCustomerModal input[name="email"]').removeClass('is-invalid-input');
                    $('#editCustomerModal input[name="email"]').parent().find('.form-error').removeClass('is-visible');
                } else {
                    $('#editCustomerModal input[name="email"]').prop('disabled', false);
                    $('#editCustomerModal input[name="email"]').val($('#fetchedEmail').text());
                    $('#editCustomerModal input[name="email"]').addClass('customerRequired');
                }
            });

            $('#continueWithoutEmail').click(function() {
                storeInvoiceData();
                $('#emailWontSendModal').foundation('close');
                $('#invoiceModal .invoiceTable tbody tr').not(':first').remove();

                $('#invoiceModal .invoiceTable').attr('id', '');

                $('input[name="invoiceSplitBidAcceptance"]').val('<?php echo $invoiceSplitBidAcceptance;  ?>');
                $('input[name="bidAcceptanceTotal"]').val('');

                $('#invoiceSplitProjectComplete').text('<?php echo $invoiceSplitProjectComplete;  ?>');
                $('#projectCompleteTotal').text('');

                $('#evaluationList').empty();

                //Get Project Evaluations
                projectEvaluations();

                // //Get Billing info
                // populateBillingInfo();
            });


            $('#continueWithoutEmailSchedule').click(function() {
                confirmAppointment();
                $('#emailWontSendModalSchedule').foundation('close');
            });

            //Add Email Row on Click
            $('#emailTable .addEmail').click(addEmailRow);

            //Add Phone Row on Click
            $('#phoneTable .addPhone').click(addPhoneRow);

            //Show Setup Modal if Clicked in Top Nav
            $('#showSetup').click(showSetupModal);

            //Show Setup Modal On Page Load if it Hasn't Been Viewed Since Yesterday
            showSetupModal('true');

            //Update Last Viewed When Modal Opens
            $('#setupModal').on('open.zf.reveal', function() {
                $.ajax({
                    url: 'setupProgressUpdate.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        updateSetupNotice: 'true'
                    },
                    success: function (response) {
                        //console.log(response);
                        // if (response == 'true') {
                        // }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                });

            });

            $('input[required], select[required], input[name="projectCompleteName"], input[name="bidAcceptanceName"], input[name="bidNumber"], textarea[name="note"]').change(function(){
                if ($(this).val().trim() == ''){
                    $(this).parent().addClass('is-invalid-label');
                    $(this).addClass('is-invalid-input');
                    $(this).parent().find('.form-error').addClass('is-visible');
                } else {
                    $(this).parent().removeClass('is-invalid-label');
                    $(this).removeClass('is-invalid-input');
                    $(this).parent().find('.form-error').removeClass('is-visible');
                }
            });

            //Update Checkmarks When Clicked
            $('img.setupProgressCheckmark').click(updateChecks);

            //Stop Showing Setup Modal
            $('#setupComplete').click(setupComplete);


            $('input[name="scheduledStartTimeAllDay"]').click(function () {
                if ($(this).is(':checked')) {
                    $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').attr('disabled', 'disabled');
                    $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').css('background-color:#909090;');

                    var oldStartTime = $('input[name="scheduledStartTime"]').val();
                    var oldEndTime = $('input[name="scheduledEndTime"]').val();

                    $('div#scheduledStartTimeHidden').text(oldStartTime);
                    $('div#scheduledEndTimeHidden').text(oldEndTime);


                    if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ){
                        $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').val('00:00');
                    }else{
                        $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').val('12 : 00 AM');

                    }

                } else {
                    $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').removeAttr('disabled');
                    $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').css("background-color:white;");

                    var oldStartTime = $('div#scheduledStartTimeHidden').text();
                    var oldEndTime = $('div#scheduledEndTimeHidden').text();

                    $('input[name="scheduledStartTime"]').val(oldStartTime);
                    $('input[name="scheduledEndTime"]').val(oldEndTime);
                }
            });

            //Get Billing info
            $('#billing-label').click(function(){
                populateBillingInfo();
            });


            //Reopen Project Function
            $('#yesReopenProject').click(yesReopenProject);

            //Cancel Project Function
            $('#yesCancelProject').click(yesCancelProject);

            //Complete Project Function
            $('#yesCompleteProject').click(yesCompleteProject);

            //Add Additional Contacts Modal
            $('#addContacts').click(addContacts);

            //Edit Customer Modal
            $('#editProjectInfo').click(editCustomer);

            //Close Customer Modal
            $('#closeEditCustomerModal').click(closeEditCustomer);

            //Save Customer Modal
            $('#saveEditCustomerModal').click(saveEditCustomer);

            //Close Project Contacts Modal
            $('#closeProjectContacts').click(closeProjectContacts);

            //Save Project Contacts Modal
            $('#saveProjectContacts').click(saveProjectContacts);

            //Save Edit Evaluation Name Modal
            $('#saveEvaluationName').click(saveEvaluationName);

            //Close Edit Evaluation Name Modal 
            $('#closeEditEvaluationModal').click(closeEditEvaluationModal);

            //Add Note
            $('#newNote').click(addNote);

            //Save New Note
            $('#addNewNote').click(addNewNote);

            //Close Add Note Modal
            $('#closeAddNoteModal').click(closeAddNoteModal);

            //Save Edit Note Modal
            $('#saveNote').click(saveEditNote);

            //Close Edit Note Modal 
            $('#closeEditNoteModal').click(closeEditNoteModal);

            //Open Delete Note Modal 
            $('#deleteNote').click(deleteNote);

            //Yes Delete Note
            $('#yesDeleteNote').click(yesDeleteNote);

            //Close Delete Note Modal 
            $('#closeDeleteNoteModal').click(closeDeleteNoteModal);


            //Remove Edit Modal on Change
            $('#editCustomerModal input.customerRequired').change(function () {
                 if ($(this).val() == '') {
                    $(this).parent().addClass('is-invalid-label');
                    $(this).addClass('is-invalid-input');
                    $(this).parent().find('.form-error').addClass('is-visible');
                } else {
                    $(this).parent().removeClass('is-invalid-label');
                    $(this).removeClass('is-invalid-input');
                    $(this).parent().find('.form-error').removeClass('is-visible');
                }

            });

            //Project Contact Name Validation
            $('body').on('change', '#addContactsModal input[name="name"]', function() {
                var name = $(this).val().trim()
                if (name == '') {
                    $(this).parent().addClass('is-invalid-label');
                    $(this).addClass('is-invalid-input');
                    $(this).parent().find('.form-error').addClass('is-visible');
                    $('small.contactName').addClass('is-visible');
                } 
                else {
                    $(this).parent().removeClass('is-invalid-label');
                    $(this).removeClass('is-invalid-input');
                    $(this).parent().find('.form-error').removeClass('is-visible');
                    $('small.contactName').removeClass('is-visible');
                }
            });

            //Project Contact Email Validation
            $('body').on('change', '#addContactsModal input[name="contactEmail"]', function() {
                var email = $(this).val()
                if (email == '' || !isEmail(email)) {
                    $(this).parent().addClass('is-invalid-label');
                    $(this).addClass('is-invalid-input');
                    $(this).parent().find('.form-error').addClass('is-visible');
                    $('small.contactEmail').addClass('is-visible');
                } 
                else {
                    $(this).parent().removeClass('is-invalid-label');
                    $(this).removeClass('is-invalid-input');
                    $(this).parent().find('.form-error').removeClass('is-visible');
                    $('small.contactEmail').removeClass('is-visible');
                }
            });

            var onload = "true";

            //Get Project Evaluations
            projectEvaluations(onload);

            //Get Project Schedule
            // projectSchedule();

             //Get Project History
            projectHistory();

            //Get Project Notes
            projectNotes();

            //Open Upload Project Document Modal
            $('#openProjectDocumentsModal').click(function () {
                //$('#uploadDocument input[name="documentDescription"]').val('<?php echo $projectDescription; ?>');

                $('#uploadDocument').foundation('open');
            });

             //Close Upload Project Document Modal
            $('#cancelDocument').click(function () {

                $('#uploadDocument').foundation('close');
            });

            //Add A Document
            $('#addDocument').click(function () {
                
                var projectID = $('#projectID').attr('value');
                var description = $('#uploadDocument input[name="documentDescription"]').val();

                var customFile = $('#uploadDocument input[name="document"]').val();

                var formdata = new FormData();
                formdata.append('projectID', projectID);
                formdata.append('description', description);
                formdata.append('file', $('#uploadDocument input[name="document"]')[0].files[0]);
                if (description == '' || customFile == '') {
                    $('#uploadDocument input[name="documentDescription"]').addClass('is-invalid-input');
                    $('#uploadDocument input[name="documentDescription"]').parent().addClass('is-invalid-label');
                    $('#uploadDocument input[name="documentDescription"]').parent().find('.form-error').addClass('is-visible');

                    $('#uploadDocument input[name="document"]').addClass('is-invalid-input');
                    $('#uploadDocument input[name="document"]').parent().addClass('is-invalid-label');
                    $('#uploadDocument input[name="document"]').parent().find('.form-error').addClass('is-visible');
                } else {
                    $('#loading-image').show();
                    $.ajax({
                        url: 'project-document-add.php',
                        type: "POST",
                        data: formdata,
                        processData: false,  // tell jQuery not to process the data
                        contentType: false,  // tell jQuery not to set contentType
                        success: function (response) {

                            //$('#invoiceModal .invoiceTable').attr('id', response);

                            //$('#evaluationList').empty();

                            //Get Project Evaluations
                            //projectEvaluations();

                            $('#uploadDocument input[name="documentDescription"]').val('');
                            $('#uploadDocument input[name="document"]').val('');

                            $('#uploadDocument').foundation('close');
                            $("#projectDoc").remove();
                            getProjectDocuments();

                            // //Open Invoice Modal
                            // $('#bidTotalModal').foundation('open');
                            
                            $('#loading-image').hide();
                        }, error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }

                    });
                }
               
            });


            //Open New Evaluation Modal
             $('#openNewEvaluationModal').click(function () {

                //$('#newEvaluation input[name="evaluationDescription"]').val(decodeEntities('<?php echo $projectDescription; ?>'));

                $('#newEvaluation').foundation('open');
             });

             //Open Custom Evaluation Modal
             $('#openCustomEvaluationModal').click(function () {

                //$('#uploadEvaluation input[name="evaluationDescription"]').val('<?php echo $projectDescription; ?>');

                $('#uploadEvaluation').foundation('open');
             });

             //Cancel Add On Items
            $('#cancelScopeChange').click(function () {
                $('#scopeChangeModal .scopeChangeItemTable tbody tr').not(':first').remove();

                $('#scopeChangeModal').foundation('close');
            });
             
            //Save Add On Items
            $('#saveScopeChange').click(saveScopeChange);
             
             

            //Remove Errors On Change for Evaluation Description
            $('input[name="evaluationDescription"]').change(function () {
                $('input[name="evaluationDescription"]').removeClass('is-invalid-input');
                $('input[name="evaluationDescription"]').parent().removeClass('is-invalid-label');
                $('input[name="evaluationDescription"]').parent().find('.form-error').removeClass('is-visible');
            });

            //Remove Errors On Change for Custom Evaluation Upload
            $('input[name="customEvaluation"]').change(function () {
                $('input[name="customEvaluation"]').removeClass('is-invalid-input');
                $('input[name="customEvaluation"]').parent().removeClass('is-invalid-label');
                $('input[name="customEvaluation"]').parent().find('.form-error').removeClass('is-visible');
            });

            //Remove Errors On Change for Copy Evaluation Dropdown
            $('#copyEvaluationSelectModal select').change(function () {
                $('#copyEvaluationSelectModal select').removeClass('is-invalid-input');
                $('#copyEvaluationSelectModal select').parent().removeClass('is-invalid-label');
                $('#copyEvaluationSelectModal select').parent().find('.form-error').removeClass('is-visible');
            });

             //Remove Errors On Change for Document Description
             $('input[name="documentDescription"]').change(function () {
                $('input[name="documentDescription"]').removeClass('is-invalid-input');
                $('input[name="documentDescription"]').parent().removeClass('is-invalid-label');
                $('input[name="documentDescription"]').parent().find('.form-error').removeClass('is-visible');
            });

             //Remove Errors On Change for Document Description
             $('input[name="documentDescription"]').change(function () {
                $('input[name="documentDescription"]').removeClass('is-invalid-input');
                $('input[name="documentDescription"]').parent().removeClass('is-invalid-label');
                $('input[name="documentDescription"]').parent().find('.form-error').removeClass('is-visible');
            });

             //Remove Errors On Change for Document Upload
             $('input[name="document"]').change(function () {
                $('input[name="document"]').removeClass('is-invalid-input');
                $('input[name="document"]').parent().removeClass('is-invalid-label');
                $('input[name="document"]').parent().find('.form-error').removeClass('is-visible');
            });
            

            //Cancel Adding A Custom Evaluation Modal
            $('#cancelCustomEvaluation').click(function () {
                $('#uploadEvaluation input[name="evaluationDescription"]').removeClass('is-invalid-input');
                $('#uploadEvaluation input[name="evaluationDescription"]').parent().removeClass('is-invalid-label');
                $('#uploadEvaluation input[name="evaluationDescription"]').parent().find('.form-error').removeClass('is-visible');
                $('#uploadEvaluation input[name="customEvaluation"]').removeClass('is-invalid-input');
                $('#uploadEvaluation input[name="customEvaluation"]').parent().removeClass('is-invalid-label');
                $('#uploadEvaluation input[name="customEvaluation"]').parent().find('.form-error').removeClass('is-visible');

                $('#uploadEvaluation input[name="evaluationDescription"]').val('');
                $('#uploadEvaluation input[name="customEvaluation"]').val('');

                $('#uploadEvaluation').foundation('close');
            });

            //Add A Custom Evaluation
            $('#addCustomEvaluation').click(function () {

                $('#loading-image').show();
                var projectID = $('#projectID').attr('value');
                var description = $('#uploadEvaluation input[name="evaluationDescription"]').val();

                var customFile = $('#uploadEvaluation input[name="customEvaluation"]').val();

                var formdata = new FormData();
                formdata.append('projectID', projectID);
                formdata.append('description', description);
                formdata.append('file', $('#uploadEvaluation input[name="customEvaluation"]')[0].files[0]);

                if (description == '' || customFile == '') {
                    $('#uploadEvaluation input[name="evaluationDescription"]').addClass('is-invalid-input');
                    $('#uploadEvaluation input[name="evaluationDescription"]').parent().addClass('is-invalid-label');
                    $('#uploadEvaluation input[name="evaluationDescription"]').parent().find('.form-error').addClass('is-visible');

                    $('#uploadEvaluation input[name="customEvaluation"]').addClass('is-invalid-input');
                    $('#uploadEvaluation input[name="customEvaluation"]').parent().addClass('is-invalid-label');
                    $('#uploadEvaluation input[name="customEvaluation"]').parent().find('.form-error').addClass('is-visible');
                } else {
                   
                    $.ajax({
                        url: 'custom-evaluation-add.php',
                        type: "POST",
                        data: formdata,
                        processData: false,  // tell jQuery not to process the data
                        contentType: false,  // tell jQuery not to set contentType
                        success: function (response) {

                            $('#invoiceModal .invoiceTable').attr('id', response);

                            $('#evaluationList').empty();

                            //Get Project Evaluations
                            projectEvaluations();

                            $('#uploadEvaluation input[name="evaluationDescription"]').val('');
                            $('#uploadEvaluation input[name="customEvaluation"]').val('');

                            $('#uploadEvaluation').foundation('close');

                            //Open Invoice Modal
                            $('#bidTotalModal').foundation('open');

                            $('#loading-image').hide();


                        }, error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);

                        }

                    });
                }

            });

            //Cancel Adding A New Evaluation Modal
            $('#closeNewEvaluationModal').click(function () {
                $('#newEvaluation input[name="evaluationDescription"]').removeClass('is-invalid-input');
                $('#newEvaluation input[name="evaluationDescription"]').parent().removeClass('is-invalid-label');
                $('#newEvaluation input[name="evaluationDescription"]').parent().find('.form-error').removeClass('is-visible');
                $('#newEvaluation input[name="evaluationDescription"]').val('');
                $('#newEvaluation').foundation('close');
            });

            //Add A New Evaluation
            $('#startNewEvaluation').click(function () {
                var projectID = $('#projectID').attr('value');
                var description = $('#newEvaluation input[name="evaluationDescription"]').val();

                if (description == '') {
                    $('#newEvaluation input[name="evaluationDescription"]').addClass('is-invalid-input');
                    $('#newEvaluation input[name="evaluationDescription"]').parent().addClass('is-invalid-label');
                    $('#newEvaluation input[name="evaluationDescription"]').parent().find('.form-error').addClass('is-visible');

                } else {

                    $.ajax({
                        url: 'new-evaluation-add.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            projectID: projectID,
                            description: description
                        },
                        success: function (response) {
                            $('#newEvaluation').foundation('close');

                            $('#newEvaluation input[name="evaluationDescription"]').val('');

                            window.location.href = "evaluation-wizard.php?eid=" + response + "";

                        }, error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }

                    });
                }

            });

            //Close Adding A Copied Evaluation Modal
            $('#closeCopiedEvaluationModal').click(function () {
                $('#copyEvaluationModal input[name="evaluationDescription"]').removeClass('is-invalid-input');
                $('#copyEvaluationModal input[name="evaluationDescription"]').parent().removeClass('is-invalid-label');
                $('#copyEvaluationModal input[name="evaluationDescription"]').parent().find('.form-error').removeClass('is-visible');
                $('#copyEvaluationModal #idToCopy').val('');
                $('#copyEvaluationModal input[name="evaluationDescription"]').val('');
                $('#copyEvaluationModal').foundation('close');
            });

            //Add Copied Evaluation
            $('#startCopiedEvaluation').click(function () {
                var projectID = $('#projectID').attr('value');
                var description = $('#copyEvaluationModal input[name="evaluationDescription"]').val();
                var idToCopy = $('#copyEvaluationModal #idToCopy').val();

                if (description == '') {
                    $('#copyEvaluationModal input[name="evaluationDescription"]').addClass('is-invalid-input');
                    $('#copyEvaluationModal input[name="evaluationDescription"]').parent().addClass('is-invalid-label');
                    $('#copyEvaluationModal input[name="evaluationDescription"]').parent().find('.form-error').addClass('is-visible');

                } else {

                    $.ajax({
                        url: 'copied-evaluation-add.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            projectID: projectID,
                            evaluationID: idToCopy,
                            description: description
                        },
                        success: function (response) {
                            $('#copyEvaluationModal').foundation('close');

                            $('#copyEvaluationModal input[name="evaluationDescription"]').val('');

                            window.location.href = "evaluation-wizard.php?eid=" + response + "";

                        }, error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }

                    });
                }

            });


            //Add Custom Copied Evaluation
            $('#startCustomCopiedEvaluation').click(function () {
                var projectID = $('#projectID').attr('value');
                var description = $('#copyCustomEvaluationModal input[name="evaluationDescription"]').val();
                var idToCopy = $('#copyCustomEvaluationModal #idToCopy').val();

                if (description == '') {
                    $('#copyCustomEvaluationModal input[name="evaluationDescription"]').addClass('is-invalid-input');
                    $('#copyCustomEvaluationModal input[name="evaluationDescription"]').parent().addClass('is-invalid-label');
                    $('#copyCustomEvaluationModal input[name="evaluationDescription"]').parent().find('.form-error').addClass('is-visible');

                } else {

                    $.ajax({
                        url: 'copied-custom-evaluation-add.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            projectID: projectID,
                            evaluationID: idToCopy,
                            description: description
                        },
                        success: function (response) {
                            $('#invoiceModal .invoiceTable').attr('id', response);

                            $('#evaluationList').empty();

                            //Get Project Evaluations
                            projectEvaluations();

                            $('#copyCustomEvaluationModal input[name="evaluationDescription"]').val('');

                            $('#copyCustomEvaluationModal').foundation('close');

                            //Open Invoice Modal
                            $('#bidTotalModal').foundation('open');


                        }, error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }

                    });
                }

            });


             //Close Adding A Custom Copied Evaluation Modal
            $('#closeCopiedCustomEvaluationModal').click(function () {
                $('#copyCustomEvaluationModal input[name="evaluationDescription"]').removeClass('is-invalid-input');
                $('#copyCustomEvaluationModal input[name="evaluationDescription"]').parent().removeClass('is-invalid-label');
                $('#copyCustomEvaluationModal input[name="evaluationDescription"]').parent().find('.form-error').removeClass('is-visible');
                $('#copyCustomEvaluationModal #idToCopy').val('');
                $('#copyCustomEvaluationModal input[name="evaluationDescription"]').val('');
                $('#copyCustomEvaluationModal').foundation('close');
            });

            //Close Select An Existing Evaluation To Copy Modal
            $('#closeCopyEvaluationSelectModal').click(function () {
                $('#copyEvaluationSelectModal select').removeClass('is-invalid-input');
                $('#copyEvaluationSelectModal select').parent().removeClass('is-invalid-label');
                $('#copyEvaluationSelectModal select').parent().find('.form-error').removeClass('is-visible');
                $('#copyEvaluationSelectModal select').val('');
                $('#copyEvaluationSelectModal').foundation('close');
            });

            //Select An Existing Evaluation To Copy
            $('#selectCopyEvaluationSelectModal').click(function () {
                var idToCopy = $('#copyEvaluationSelectModal select').val();

                if (idToCopy == '') {
                    $('#copyEvaluationSelectModal select').addClass('is-invalid-input');
                    $('#copyEvaluationSelectModal select').parent().addClass('is-invalid-label');
                    $('#copyEvaluationSelectModal select').parent().find('.form-error').addClass('is-visible');
                } else {
                    $('#copyEvaluationModal #idToCopy').val(idToCopy);
                    $('#copyEvaluationModal').foundation('open');
                    $('#copyEvaluationSelectModal select').val('');
                }
            });


            //Close Cancel Evaluation Modal
            $('#closeCancelEvaluationModal').click(function () {
                $('#cancelEvaluationModal #idToCancel').val('');
                $('#cancelEvaluationModal').foundation('close');
            });


            //Cancel Evaluation
            $('#cancelEvaluation').click(function () {
                var projectID = $('#projectID').attr('value');
                var idToCancel = $('#cancelEvaluationModal #idToCancel').val();

                $.ajax({
                    url: 'evaluation-cancel.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        projectID: projectID,
                        evaluationID: idToCancel
                    },
                    success: function (response) {
                        $('#evaluationList').empty();

                        //Get Project Evaluations
                        projectEvaluations();

                        $('#cancelEvaluationModal').foundation('close');

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            });

            //View Streetview Image On Button Click
            $('#viewStreetView').click(function () {
                $('#propertyLocationMap').hide();
                $('#propertyLocationStreetview').show();
                $('#viewMap').removeClass('active');
                $('#viewStreetView').addClass('active');
                initMap();
            });

            //View Map On Button Click
            $('#viewMap').click(function () {
                $('#propertyLocationStreetview').hide();
                $('#propertyLocationMap').show();
                $('#viewStreetView').removeClass('active');
                $('#viewMap').addClass('active');
                initMap();
            });

            //Changed Invoice Paid Status Function
            $('#billingTable').on('change', '[type=checkbox]', function () {
                var evaluationID = $(this).attr("eid");
                var invoiceSort = $(this).attr("sort");
                var invoiceType = $(this).attr("invoiceType");
                var isCustom = $(this).attr("isCustom");
                var invoicePaid = 0;

                if ($(this).is(":checked")){
                    invoicePaid = 1;
                }

                //console.log("evaluationID: " + evaluationID + " sort: " + invoiceSort + " paid: " + invoicePaid);

                if (invoiceType == "custom"){
                    $.ajax({
                        url: 'invoice-paid.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            evaluationID: evaluationID,
                            invoiceSort: invoiceSort,
                            invoicePaid: invoicePaid,
                            isCustom: isCustom
                        },
                        success: function (response) {
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });
                }
                else if (invoiceType == 'accept'){
                    $.ajax({
                        url: 'invoice-paid-evaluation-bid-accept.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            evaluationID: evaluationID,
                            invoicePaid: invoicePaid,
                            invoiceType: invoiceType,
                            isCustom: isCustom
                        },
                        success: function (response) {
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });
                } 
                else{
                    $.ajax({
                        url: 'invoice-paid-evaluation-bid-complete.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            evaluationID: evaluationID,
                            invoicePaid: invoicePaid,
                            invoiceType: invoiceType,
                            isCustom: isCustom
                        },
                        success: function (response) {
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });
            }  

        });

            

            $("#billingTable .header").click(sortTable);


            //Calendar Button Clicks
            $('#today').click(function () {
                $('#calendar').fullCalendar('today')
            });
            $('#dailyView').click(function () {
                $('#weeklyView, #monthlyView').removeClass('active');
                $('#dailyView').addClass('active');
                $('#calendar').fullCalendar('changeView', 'timelineDay')
            });
            $('#weeklyView').click(function () {
                $('#dailyView, #monthlyView').removeClass('active');
                $('#weeklyView').addClass('active');
                $('#calendar').fullCalendar('changeView', 'agendaWeek')
            });
            $('#monthlyView').click(function () {
                $('#dailyView, #weeklyView').removeClass('active');
                $('#monthlyView').addClass('active');
                $('#calendar').fullCalendar('changeView', 'month')
            });
            $('#previous').click(function () {
                $('#calendar').fullCalendar('prev')
            });
            $('#next').click(function () {
                $('#calendar').fullCalendar('next')
            });


            //Reload Calendar When the Filter is Changed
            $('select#filterResources').change(filterCalendar);

            //Add Changed Class to Event Add Modal
            $('input.evaluationData, select.evaluationData').change(function () {
                $(this).addClass('changed');
            });

            //Click on the Schedule Tab at the Top of the Page
            $('#scheduleTab').click(function () {
                //Remove Calendar and Display Schedule and Map
                $('#scheduleEvaluationButton').empty();
                $('#evaluationSchedule').empty();
                $('#scheduleInstallationButton').empty();
                $('#installationSchedule').empty();
                $('#generalEvaluationSchedule').empty();
                $('#generalInstallationSchedule').empty();
                $('input[name="projectScheduleID"]').val('');

                $('#scheduleList, #scheduleMap').show();
                $('#scheduleCalendar').hide();
                $('#cancelScheduleButton').remove();
                $('#calendar').empty();
                if ($('#scheduleMap #calendarMap').length <= 0) {
                    $('#scheduleMap').append('<div id="calendarMap"></div>');
                    initializeMap();
                }

                //Get New Project Schedule
                projectSchedule();
            });


            //Get Resources for the Calendar
            $.ajax({
                url: 'getResources.php',
                dataType: "json",
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    filter: ''
                },
                success: function (response) {

                    $('#filterSelect').append('<select id="filterResources"><option value="">View All</option><option value="sales">Sales</option><option value="installation">Installation</option></select>');

                    if (response != null) {
                        $.each(response, function (i, item) {
                            $('select#filterResources').append('<option value="' + item.id + '">' + item.title + '</option>');
                            $('#scheduleModalDD select').append('<option value="' + item.id + '">' + item.title + '</option>');
                        });
                    }

                    $('select#filterResources').change(function () {

                        var view = $('#calendar').fullCalendar('getView');

                        var defaultView = view.name;
                        filterCalendar(defaultView);

                    });

                    //filterCalendar('timelineDay');

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });


            //Get Invoices
            if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                $('#generalBilling').empty();
                $('#generalBilling').append('<strong>Billing</strong>');
                //populateBillingInfo();
            }

            // Click Cancel on Appointment Modal
            $('#confirmAppointmentNo').click(function () {

                $('#startDateErr').hide();
                    $('input[name="scheduledStartDate"]').removeClass("required");
                    $('input[name="scheduledStartDate"]').removeClass("is-invalid-input");
                    $('#startTimeErr').hide();
                    $('input[name="scheduledStartTime"]').removeClass("required");
                    $('input[name="scheduledStartTime"]').removeClass("is-invalid-input");
                    $('#endDateErr').hide();
                    $('input[name="scheduledEndDate"]').removeClass("required");
                    $('input[name="scheduledEndDate"]').removeClass("is-invalid-input");
                    $('#endTimeErr').hide();
                    $('input[name="scheduledEndTime"]').removeClass("required");
                    $('input[name="scheduledEndTime"]').removeClass("is-invalid-input");

                //Get Temporary ID
                var tempID = $('input[name="tempID"]').val();

                var allEvents = $('#calendar').fullCalendar('clientEvents');

                allEvents = allEvents.filter(function (el) {
                    return el._id !== tempID;
                });

                //Remove Last Rendered Event
                $('#calendar').fullCalendar('removeEvents', tempID);

                //Unselect Event on Calendar
                $('#calendar').fullCalendar('unselect');

                //Remove Temp ID from form
                $('input[name="tempID"]').val('');

                $('input[name="scheduledStartTimeAllDay"]').removeAttr('checked');
                $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').removeAttr('disabled');
                $('div#scheduledStartTimeHidden, div#scheduledEndTimeHidden').empty();

                //Unselect Resource from Dropdown
                $('select[name="salesperson"]').find("option").attr('selected', false);

                //Close Modal
                $('#addEvent').foundation('close');
            });
        
            

            $('input[name="scheduledStartTime"]').focusout(function(){
                if($('input[name="scheduledStartTime"]').val()!=''){
                    $('#startTimeErr').hide();
                    $('input[name="scheduledStartTime"]').removeClass("required");
                    $('input[name="scheduledStartTime"]').removeClass("is-invalid-input");
                    
                }else{
                    $('#startTimeErr').show();
                    $('input[name="scheduledStartTime"]').addClass("required");
                    $('input[name="scheduledStartTime"]').addClass("is-invalid-input");
                }
            });

              $('input[name="scheduledEndTime"]').focusout(function(){
                if($('input[name="scheduledEndTime"]').val()!=''){
                    $('#endTimeErr').hide();
                    $('input[name="scheduledEndTime"]').removeClass("required");
                    $('input[name="scheduledEndTime"]').removeClass("is-invalid-input");
                }else{
                    $('#endTimeErr').show();
                    $('input[name="scheduledEndTime"]').addClass("required");
                    $('input[name="scheduledEndTime"]').addClass("is-invalid-input");
                }
            });

            // Click Save on Appointment Modal
            $('#confirmAppointmentYes').click(function () {
                if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                    confirmAppointment();
                }
                else{
                    if ($('#noEmailRequiredStatus').text() == "1"){
                        var text = 'no email.';
                    }
                    if ($('#unsubscribedStatus').text() == "1"){
                        var text = 'unsubscribed from emails.';
                    }

                    $('#emailWontSendModalSchedule').foundation('open');
                    $('#emailWontSendModalSchedule p').text('Email will not be sent because the customer has ' + text + ' Continue?');
                }
            });

            $('#dontContinueWithoutEmail').click(function () {
                $('#startDateErr').hide();
                    $('input[name="scheduledStartDate"]').removeClass("required");
                    $('input[name="scheduledStartDate"]').removeClass("is-invalid-input");
                    $('#startTimeErr').hide();
                    $('input[name="scheduledStartTime"]').removeClass("required");
                    $('input[name="scheduledStartTime"]').removeClass("is-invalid-input");
                    $('#endDateErr').hide();
                    $('input[name="scheduledEndDate"]').removeClass("required");
                    $('input[name="scheduledEndDate"]').removeClass("is-invalid-input");
                    $('#endTimeErr').hide();
                    $('input[name="scheduledEndTime"]').removeClass("required");
                    $('input[name="scheduledEndTime"]').removeClass("is-invalid-input");

                //Get Temporary ID
                var tempID = $('input[name="tempID"]').val();

                var allEvents = $('#calendar').fullCalendar('clientEvents');

                allEvents = allEvents.filter(function (el) {
                    return el._id !== tempID;
                });

                //Remove Last Rendered Event
                $('#calendar').fullCalendar('removeEvents', tempID);

                //Unselect Event on Calendar
                $('#calendar').fullCalendar('unselect');

                //Remove Temp ID from form
                $('input[name="tempID"]').val('');

                $('input[name="scheduledStartTimeAllDay"]').removeAttr('checked');
                $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').removeAttr('disabled');
                $('div#scheduledStartTimeHidden, div#scheduledEndTimeHidden').empty();

                //Unselect Resource from Dropdown
                $('select[name="salesperson"]').find("option").attr('selected', false);

                //Close Modal
                $('#emailWontSendModalSchedule').foundation('close');
            });

            //Click Cancel on Custom Eval Invoice Modal
            $("#cancelInvoice").click(function(){
                $('#invoiceModal .invoiceTable tbody tr').not(':first').remove();

                $('#invoiceModal .invoiceTable').attr('id', '');

                $('input[name="invoiceSplitBidAcceptance"]').val('<?php echo $invoiceSplitBidAcceptance;  ?>');
                $('input[name="bidAcceptanceTotal"]').val('');

                $('#invoiceSplitProjectComplete').text('<?php echo $invoiceSplitProjectComplete;  ?>');
                $('#projectCompleteTotal').text('');

                //Close Invoice Modal
                $('#invoiceModal').foundation('close');
            }); 

            //Click Cancel on Custom Eval Invoice Modal
            $("#cancelContinueWithoutEmail").click(function(){
                $('#invoiceModal .invoiceTable tbody tr').not(':first').remove();

                $('#invoiceModal .invoiceTable').attr('id', '');

                $('input[name="invoiceSplitBidAcceptance"]').val('<?php echo $invoiceSplitBidAcceptance;  ?>');
                $('input[name="bidAcceptanceTotal"]').val('');

                $('#invoiceSplitProjectComplete').text('<?php echo $invoiceSplitProjectComplete;  ?>');
                $('#projectCompleteTotal').text('');

                //Close Invoice Modal
                $('#emailWontSendModal').foundation('close');
            }); 

            //Click Cancel on Bid Total Modal
            $("#cancelBidTotal").click(function(){
                
                $('#bidTotalModal input[name="customBidTotal"]').val('');

                //Close Invoice Modal
                $('#bidTotalModal').foundation('close');
            }); 

            //Calculate Invoice Percentage And Mount
            $(".changeInvoiceAmount").change(addInvoiceTotalAmount);
            $(".changeInvoicePercent").change(addInvoiceTotalPercent);


            //Add Row for Invoice on Click +/-
            $(".button.numberInvoices").on("click", function () {

                var $button = $(this);
                var oldValue = $('#invoiceModal .invoiceTable tbody > tr:last-child td input').attr("sort");

                var oldInputCount = $('#invoiceModal .invoiceTable tbody tr:not(:first-child)').length;
                

                if ($button.text() == "+") {
                    $('.invoiceTable input').removeClass('is-invalid-input');
                    $('.invoiceTable input').parent().find('.form-error').removeClass('is-visible');

                    var newVal = parseFloat(oldValue) + 1;
                    $('#invoiceModal .invoiceTable tbody').append($('#invoiceModal .invoiceTable tbody tr:first').clone().css('display', ''));
                    $('#invoiceModal .invoiceTable tbody > tr:last-child td input').attr("sort", "" + (newVal) + "");
                    $('#invoiceModal .invoiceTable tbody > tr:last-child td input.changeInvoiceAmount').change(addInvoiceTotalAmount);
                    $('#invoiceModal .invoiceTable tbody > tr:last-child td input.changeInvoicePercent').change(addInvoiceTotalPercent);

                }
                else if ($button.text() == "-") {
                    $('.invoiceTable input').removeClass('is-invalid-input');
                    $('.invoiceTable input').parent().find('.form-error').removeClass('is-visible');

                    // Don't allow decrementing below default
                    if (oldInputCount > 0) {
                        var newVal = parseFloat(oldValue) - 1;
                        if ($('#invoiceModal .invoiceTable tbody tr:last-child td input.changeInvoicePercent').val() == '' && $('#invoiceModal .invoiceTable tbody tr:last-child td input.changeInvoiceAmount').val() == '') {
                            $('#invoiceModal .invoiceTable tbody tr:last-child').remove();
                        } else {
                            $('#invoiceModal .invoiceTable tbody tr:last-child').remove();
                            addInvoiceTotalAmount();
                        }

                    } else {
                        newVal = 2;
                    }
                }

                var newInputCount = $('#invoiceModal .invoiceTable tbody tr:not(:first-child)').length; 
                newInputCount = newInputCount + 2;

                $button.parent().siblings(".invoiceCountInput").children(".invoiceCount").val(newInputCount);
            });
            //End Add Row for Invoice on Click


            //Send Custom Bid
            $("#invoiceApprove").click(function() {
            
                invoiceApproveCustomBid();
               
            });

            $("#bidTotalNext").click(finalizeCustomBid);

            //remove required if no email is required
            if ('<?php echo $noEmailRequired; ?>' == 1){
                $('#editCustomerModal input[name="email"]').removeClass('customerRequired');
            }
        });
        //End of Document Ready

        //Sort Table on Header Click
        var sortTable = function() {
            $("#billingTable").tablesorter();
        };

         var validateDates = function(){


                if($('input[name="scheduledStartDate"]').val()==''){
                    //add class required
                    $('#startDateErr').show();
                    $('input[name="scheduledStartDate"]').addClass("required");
                    $('input[name="scheduledStartDate"]').addClass("is-invalid-input");
                    return false;
                }else{
                    $('#startDateErr').hide();
                    $('input[name="scheduledStartDate"]').removeClass("required");
                    $('input[name="scheduledStartDate"]').removeClass("is-invalid-input");
                }


                // if($('input[name="scheduledStartTime"]').val()==''){
                if($('input[name="scheduledStartTime"]').wickedpicker('time')==''){
                    //add class required
                    $('#startTimeErr').show();
                    $('input[name="scheduledStartTime"]').addClass("required");
                    $('input[name="scheduledStartTime"]').addClass("is-invalid-input");
                    return false;
                }else{
                    $('#startTimeErr').hide();
                    $('input[name="scheduledStartTime"]').removeClass("required");
                    $('input[name="scheduledStartTime"]').removeClass("is-invalid-input");
                }

                if($('input[name="scheduledEndDate"]').val() ==''){
                    $('#endDateErr').show();
                    $('input[name="scheduledEndDate"]').addClass("required");
                    $('input[name="scheduledEndDate"]').addClass("is-invalid-input");
                    return false;
                }else{
                    $('#endDateErr').hide();
                    $('input[name="scheduledEndDate"]').removeClass("required");
                    $('input[name="scheduledEndDate"]').removeClass("is-invalid-input");

                }

                // if($('input[name="scheduledEndTime"]').val()==''){
                if($('input[name="scheduledEndTime"]').val()==''){
                    $('#endTimeErr').show();
                    $('input[name="scheduledEndTime"]').addClass("required");
                    $('input[name="scheduledEndTime"]').addClass("is-invalid-input");
                    return false;
                }else{
                    $('#endTimeErr').hide();
                    $('input[name="scheduledEndTime"]').removeClass("required");
                    $('input[name="scheduledEndTime"]').removeClass("is-invalid-input");
                };

                    return true;

            };

        var confirmAppointment = function(){
                //Make sure there are no empty input fields for date / time

                if (validateDates() ==true){
                
                
                $('#calendar').fullCalendar('unselect');

                $('#addEvent').foundation('close');

                if ($('input[name="scheduledStartTimeAllDay"]').is(':checked')) {
                    var startTimeAllDay = 1;
                    $('#')
                } else {
                    var startTimeAllDay = 0;
                }



                $('#loading-image').show();


                if(/iPhone|iPad|iPod/i.test(navigator.userAgent)){
                    var userStartTime = $('input[name="scheduledStartTime"]').val();
                    var userEndTime = $('input[name="scheduledEndTime"]').val(); 

                } else{
                    var userStartTime = $('input[name="scheduledStartTime"]').wickedpicker('time').toString();
                    var userEndTime = $('input[name="scheduledEndTime"]').wickedpicker('time').toString();

                    var startHours = userStartTime.split(':')[0];
                    var startMinutes = userStartTime.split(':')[1];
                    startMinutes = startMinutes.slice(0, -2)
                    var startSuffix = userStartTime.split(' ')[3];

                    startHours = startHours.trim();
                    startMinutes = startMinutes.trim();
                    startSuffix = startSuffix.trim();

                    if (startSuffix == 'pm' || startSuffix == 'PM') {
                        startHours = startHours != '12' ? parseInt(startHours) + parseInt(12) : startHours;
                    }

                    userStartTime = startHours + ":" + startMinutes + ":" + "00";

                    var endHours = userEndTime.split(':')[0];
                    var endMinutes = userEndTime.split(':')[1];
                    endMinutes = endMinutes.slice(0, -2)
                    var endSuffix = userEndTime.split(' ')[3];

                    endHours = endHours.trim();
                    endMinutes = endMinutes.trim();
                    endSuffix = endSuffix.trim();

                    if (endSuffix == 'pm' || endSuffix == 'PM') {
                        endHours = endHours != '12' ? parseInt(endHours) + parseInt(12) : endHours;
                    }

                    userEndTime = endHours + ":" + endMinutes + ":" +"00";

                }


                if ($('input[name="projectScheduleID"]').val() == '') {

                    //Add New Event to DB
                    $.ajax({
                        url: 'event-add.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            projectID: $('#projectID').attr('value'),
                            startDate: $('input[name="scheduledStartDate"]').val(),
                            startTime: userStartTime,
                            startTimeAllDay: startTimeAllDay,
                            endDate: $('input[name="scheduledEndDate"]').val(),
                            endTime: userEndTime,
                            scheduleType: $('#eventType').val(),
                            scheduledUserID: $('select[name="salesperson"]').val()
                        },
                        success: function (response) {
                            if (response == 'true') {
                                //Remove Schedule Modal Inputs
                                $('select[name="salesperson"]').val('');
                                $('input[name="scheduledStartDate"]').val('');
                                $('input[name="scheduledStartTime"]').val('');
                                $('input[name="scheduledStartTimeAllDay"]').removeAttr('checked');
                                $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').removeAttr('disabled');
                                $('div#scheduledStartTimeHidden, div#scheduledEndTimeHidden').empty();
                                $('input[name="scheduledEndDate"]').val('');
                                $('input[name="scheduledEndTime"]').val('');
                                $('input[name="projectScheduleID"]').val('');


                                //Remove Calendar and Display Map
                                $('#scheduleEvaluationButton').empty();
                                $('#evaluationSchedule').empty();
                                $('#scheduleInstallationButton').empty();
                                $('#installationSchedule').empty();
                                $('#generalEvaluationSchedule').empty();
                                $('#generalInstallationSchedule').empty();
                                $('#scheduleList, #scheduleMap').show();
                                $('#scheduleCalendar').hide();
                                $('#cancelScheduleButton').remove();
                                $('#calendar').empty();
                                if ($('#scheduleMap #calendarMap').length == 0) {
                                    $('#scheduleMap').append('<div id="calendarMap"></div>');

                                }
                                initializeMap();

                                //Get New Project Schedule
                                projectSchedule();
                                $('#loading-image').hide();
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });
                } else {
                    //Update Existing Event
                    $.ajax({
                        url: 'event-edit.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            projectScheduleID: $('input[name="projectScheduleID"]').val(),
                            projectID: $('#projectID').attr('value'),
                            startDate: $('input[name="scheduledStartDate"]').val(),
                            startTime: userStartTime,
                            startTimeAllDay: startTimeAllDay,
                            endDate: $('input[name="scheduledEndDate"]').val(),
                            endTime: userEndTime,
                            scheduleType: $('#eventType').val(),
                            scheduledUserID: $('select[name="salesperson"]').val()
                        },
                        success: function (response) {
                            if (response == 'true') {
                                //Remove Schedule Modal Inputs
                                $('select[name="salesperson"]').val('');
                                $('input[name="scheduledStartDate"]').val('');
                                $('input[name="scheduledStartTime"]').val('');
                                $('input[name="scheduledStartTimeAllDay"]').removeAttr('checked');
                                $('input[name="scheduledStartTime"], input[name="scheduledEndTime"]').removeAttr('disabled');
                                $('div#scheduledStartTimeHidden, div#scheduledEndTimeHidden').empty();
                                $('input[name="scheduledEndDate"]').val('');
                                $('input[name="scheduledEndTime"]').val('');
                                $('input[name="projectScheduleID"]').val('');


                                //Remove Calendar and Display Map
                                $('#scheduleEvaluationButton').empty();
                                $('#evaluationSchedule').empty();
                                $('#scheduleInstallationButton').empty();
                                $('#installationSchedule').empty();
                                $('#generalEvaluationSchedule').empty();
                                $('#generalInstallationSchedule').empty();
                                $('#scheduleList, #scheduleMap').show();
                                $('#scheduleCalendar').hide();
                                $('#cancelScheduleButton').remove();
                                $('#calendar').empty();
                                if ($('#scheduleMap #calendarMap').length == 0) {
                                    $('#scheduleMap').append('<div id="calendarMap"></div>');

                                }
                                initializeMap();

                                //Get New Project Schedule
                                projectSchedule();
                                $('#loading-image').hide();
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });
                }
            }else{
                // alert("issues");
                return false;
            }
        };
            

        //Open Cancel Evaluation Modal
        var openCancelModal = function () {
            var idToCancel = $(this).parent().parent().parent().attr('id');
            $('#cancelEvaluationModal #idToCancel').val(idToCancel);
            $('#cancelEvaluationModal').foundation('open');
        };

        //Open Copy Evaluation Modal
        var openCopyModal = function () {
            var idToCopy = $(this).parent().parent().parent().attr('id');
            $('#copyEvaluationModal #idToCopy').val(idToCopy);
            $('#copyEvaluationModal').foundation('open');
        };

        //Open Custom Copy Evaluation Modal
        var openCustomCopyModal = function () {
            var idToCopy = $(this).parent().parent().parent().attr('id');
            $('#copyCustomEvaluationModal #idToCopy').val(idToCopy);
            $('#copyCustomEvaluationModal').foundation('open');
        };

        //Reopen Project
        var yesReopenProject = function () {
            $.ajax({
                url: 'project-reopen.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: $('#projectID').attr('value')
                },
                success: function (response) {
                    $('#projectName').html('<strong>Project</strong><br/><?php echo $projectDescription; ?><br/>');
                    $('#projectButtons button[data-open="reopenModal"]').remove();
                    $('#projectButtons').html('<button data-open="projectCompleteModal" class="button">Project Complete</button> <button data-open="cancelModal" class="button secondary">Cancel Project</button>');

                    //Close Reopen Modal
                    $('#reopenModal').foundation('close');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        };

       
        //Cancel Project
        var yesCancelProject = function () {
            $.ajax({
                url: 'project-cancel.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: $('#projectID').attr('value')
                },
                success: function (response) {
                    if (!response == '') {
                        $.each(response, function (i, item) {
                            $('#projectName').html('<strong>Project</strong><br/><?php echo $projectDescription; ?><br/><span style="color:red;">Cancelled By ' + this.cancelledFirstName + ' ' + this.cancelledLastName + ' on ' + this.projectCancelled + '</span>');
                            $('#projectButtons button[data-open="cancelModal"]').remove();
                            $('#projectButtons').html('<button data-open="reopenModal" class="button secondary">Reopen Project</button>');
                        });
                    }

                    //Remove Calendar and Display Map
                    $('#evaluationSchedule').empty();
                    $('#installationSchedule').empty();
                    $('#calendarMap').remove();
                    $('#scheduleMap').append('<div id="calendarMap"></div>');
                    initializeMap();
                    $('#generalEvaluationSchedule').empty();
                    $('#generalInstallationSchedule').empty();


                    //Get New Project Schedule
                    projectSchedule();

                    $('#evaluationList').empty();

                    //Get Project Evaluations
                    projectEvaluations();

                    //Close Cancel Modal
                    $('#cancelModal').foundation('close');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        };

        //Complete Project
        var yesCompleteProject = function () {
            $.ajax({
                url: 'project-complete.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: $('#projectID').attr('value')
                },
                success: function (response) {
                    //console.log(response);
                    if (!response == '') {
                        $.each(response, function (i, item) {
                            //$('#projectName').html('<strong>Project</strong><br/><?php echo $projectDescription; ?><br/><span style="color:red;">Cancelled By ' + this.cancelledFirstName + ' ' + this.cancelledLastName + ' on ' + this.projectCancelled + '</span>');
                            $('#projectButtons').remove();
                        });
                        $('#projectComplete').addClass('active');
                    }

                    //Close Cancel Modal
                    $('#projectCompleteModal').foundation('close');
                    $('#projectCompleteSuccessModal').foundation('open');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        };

         //Add On Items
        var scopeChange = function() {
            // console.log('clicked');
            var evaluationID = $(this).parent().parent().parent().attr('id');

            $('#scopeChangeModal .scopeChangeItemTable').attr('id', evaluationID);

            $.ajax({
                url: 'getScopeChanges.php',
                dataType: "json",
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    evaluationID: evaluationID
                },
                success: function (response) {
                    
                    if (response != null) {

                        $.each(response, function (i, item) {

                            $cloneRow = $('#scopeChangeModal .scopeChangeItemTable tbody tr:first').clone().css('display', '');

                            $cloneRow.addClass('dbRow');

                            $cloneRow.find('input[name="changeID"]').val(item.scopeChangeItemID);
                            $cloneRow.find('input.ChangeDate').val(item.date);
                            $cloneRow.find('textarea.ChangeItem').val(item.item);
                            $cloneRow.find('input.ChangePrice').val(item.price);

                            $cloneRow.find('.button-group .button').removeClass('active'); 

                            if (item.type == 0) {
                                $cloneRow.find('button#charge').addClass('active');
                            } else if (item.type == 1) {
                                $cloneRow.find('button#credit').addClass('active');
                            }
                            
                            $cloneRow.find('input.ChangeDate').attr('sort', item.sort);
                            $cloneRow.find('textarea.ChangeItem').attr('sort', item.sort);
                            $cloneRow.find('input.ChangePrice').attr('sort', item.sort);

                            $('#scopeChangeModal .scopeChangeItemTable tbody').append($cloneRow);
                            $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.datepicker').mouseenter(pickDate);
                            $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea').change(addRowScopeChange);
                            $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child .delete a').click(deleteRowScopeChange);
                            $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child button').click(changeScopeType);
                            $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').change(changeScopeTotal);
                            autosize($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea'));

                        });

                        changeScopeTotal();
                        $('#scopeChangeModal').foundation('open');

                            $(document).find('#scopeChangeModal .scopeChangeItemTable textarea').each(function () {
                                var $this = $(this);
                                autosize.update($this);
                            });    

                        var oldValue = $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input').attr('sort');
                        var newVal = parseFloat(oldValue) + 1;

                        $cloneBlankRow = $('#scopeChangeModal .scopeChangeItemTable tbody tr:first').clone().css('display', '');
                        $('#scopeChangeModal .scopeChangeItemTable tbody').append($cloneBlankRow);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td textarea').attr('sort',newVal);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.datepicker').mouseenter(pickDate);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea').change(addRowScopeChange);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child .delete a').click(deleteRowScopeChange);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child button').click(changeScopeType);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').change(changeScopeTotal);
                        autosize($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea'));

                    } else {

                        $('#scopeChangeModal').foundation('open');
                        
                        var oldValue = $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input').attr('sort');
                        var newVal = parseFloat(oldValue) + 1;

                        $cloneBlankRow = $('#scopeChangeModal .scopeChangeItemTable tbody tr:first').clone().css('display', '');
                        $('#scopeChangeModal .scopeChangeItemTable tbody').append($cloneBlankRow);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td textarea').attr('sort',newVal);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.datepicker').mouseenter(pickDate);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea').change(addRowScopeChange);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child .delete a').click(deleteRowScopeChange);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child button').click(changeScopeType);
                        $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').change(changeScopeTotal);
                        autosize($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea'));
                    }

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);

                    var oldValue = $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input').attr('sort');
                    var newVal = parseFloat(oldValue) + 1;

                    $cloneBlankRow = $('#scopeChangeModal .scopeChangeItemTable tbody tr:first').clone().css('display', '');
                    $('#scopeChangeModal .scopeChangeItemTable tbody').append($cloneBlankRow);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td textarea').attr('sort',newVal);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.datepicker').mouseenter(pickDate);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea').change(addRowScopeChange);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child .delete a').click(deleteRowScopeChange);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child button').click(changeScopeType);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').change(changeScopeTotal);
                    autosize($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea'));
                }

            });
        };

        var addRowScopeChange = function () {

            if ($('#scopeChangeModal .scopeChangeItemTable tbody').children().length == 1) {
                var oldValue = $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child:visible input').attr('sort');
                if (oldValue >= 1) {
                    var newVal = parseFloat(oldValue) + 1;
                   
                } else {
                     var newVal = parseFloat(0) + 1;
                }

                $cloneBlankRow = $('#scopeChangeModal .scopeChangeItemTable tbody tr:first').clone().css('display', '');
                $('#scopeChangeModal .scopeChangeItemTable tbody').append($cloneBlankRow);
                $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td textarea').attr('sort',newVal);
                $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.datepicker').mouseenter(pickDate);
                $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea').change(addRowScopeChange);
                $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child .delete a').click(deleteRowScopeChange);
                $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child button').click(changeScopeType);
                $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').change(changeScopeTotal);
                autosize($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea'));

            } else {
                    if ($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangeDate').val() == '' && 
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea.ChangeItem').val() == '' && 
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').val() == '') {

                } else {

                    var oldValue = $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child:visible input').attr('sort');
                    if (oldValue >= 1) {
                        var newVal = parseFloat(oldValue) + 1;
                       
                    } else {
                         var newVal = parseFloat(0) + 1;
                    }

                    $cloneBlankRow = $('#scopeChangeModal .scopeChangeItemTable tbody tr:first').clone().css('display', '');
                    $('#scopeChangeModal .scopeChangeItemTable tbody').append($cloneBlankRow);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child td textarea').attr('sort',newVal);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.datepicker').mouseenter(pickDate);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input, #scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea').change(addRowScopeChange);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child .delete a').click(deleteRowScopeChange);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child button').click(changeScopeType);
                    $('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child input.ChangePrice').change(changeScopeTotal);
                    autosize($('#scopeChangeModal .scopeChangeItemTable tbody > tr:last-child textarea'));
                }
            }

        };


        var deleteRowScopeChange = function () {

            if ($(this).parent().parent().hasClass('dbRow')) {
                console.log('dbRow');
                $(this).parent().parent().find('input').attr('delete','delete');
                $(this).parent().parent().css('display','none');

                if ($('#scopeChangeModal .scopeChangeItemTable tbody').children(':visible').length == 0)
                    addRowScopeChange();
            } else {
                $(this).parent().parent().remove();

                if ($('#scopeChangeModal .scopeChangeItemTable tbody').children().length == 1) {
                    addRowScopeChange();
                }
                
                // if ($('#scopeChangeModal .scopeChangeItemTable tbody').children(':visible').length == 0)
                //     addRowScopeChange();
            }
        };

        var changeScopeType = function() {
            $(this).parent().find('button').removeClass('active');
            $(this).addClass('active');

            if ($(this).attr('type') == 'credit') {
                var value = $(this).parent().parent().parent().find('input.ChangePrice').val();
                var firstValue = value.slice(0,1);

                if (firstValue != '-') {
                    value = Number(value);
                    var newValue = 0 - value;
                    newValue = parseFloat(newValue).toFixed(2);
                   
                    $(this).parent().parent().parent().find('input.ChangePrice').val(newValue);
                    $(this).parent().parent().parent().find('input.ChangePrice').trigger('change');
                }
                
            } else if ($(this).attr('type') == 'charge') {
                var value = $(this).parent().parent().parent().find('input.ChangePrice').val();
                var firstValue = value.slice(0,1);

                if (firstValue == '-') {
                    value = Number(value);
                    var newValue = value * -1;
                    newValue = parseFloat(newValue).toFixed(2);
                    
                    $(this).parent().parent().parent().find('input.ChangePrice').val(newValue);
                    $(this).parent().parent().parent().find('input.ChangePrice').trigger('change');
                }
            }
        };

        var changeScopeTotal = function() {
            var changeTotal = 0;
            $('#scopeChangeModal .scopeChangeItemTable tbody > tr input.ChangePrice').each(function() {
                //console.log($(this).val());
                changeTotal += Number($(this).val());
            });

            function ReplaceNumberWithCommas(Total) {
                //Seperates the components of the number
                var n= Total.toString().split(".");
                //Comma-fies the first part
                n[0] = n[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                //Combines the two sections
                return n.join(".");
            }

            changeTotal = parseFloat(changeTotal).toFixed(2);

            var changeTotalFirst = changeTotal.slice(0,1);

            if (changeTotalFirst == '-') {
                var changeTypeDisplay = '(Credit Memo)';
                var changeTypeHidden = 'creditMemo';
            } else {
                var changeTypeDisplay = '(Invoice)';
                var changeTypeHidden = 'invoice';
            }

            $('#scopeChangeModal #hiddenChangeTotal').val(changeTotal);
            $('#scopeChangeModal #hiddenChangeType').val(changeTypeHidden);

            $('#scopeChangeModal .changeTotal').html('<strong>Total: $'+ReplaceNumberWithCommas(changeTotal)+'</strong> <span>'+changeTypeDisplay+'</span>');
        };

        var pickDate = function() {
            $(this).datepicker({ });
        };

        //Save Add On Items 
        var saveScopeChange = function() {   
            $('#loading-image').show();
            var evaluationID = $('#scopeChangeModal .scopeChangeItemTable').attr('id');
            var custom = $('#evaluationList .callout[id="'+evaluationID+'"]').attr('custom');

            if (custom == 'false') {
                custom = '';
            } else {
                custom = 1;
            }

            storeScopeChangeTableData();

            function storeScopeChangeTableData() {
                var scopeChangeTableData = new Array();
                $('#scopeChangeModal .scopeChangeItemTable tbody tr').each(function(row,tr){
                    scopeChangeTableData[row]={
                        "changeDelete":$(tr).find('td:eq(0)').find('input').attr('delete'),
                        "changeSort":$(tr).find('td:eq(0)').find('input').attr('sort'),
                        "changeID":$(tr).find('td:eq(0)').find('input[name="changeID"]').val(),
                        "changeDate":$(tr).find('td:eq(0)').find('input.ChangeDate').val(),
                        "changeItem":$(tr).find('td:eq(1)').find('textarea.ChangeItem').val(),
                        "changePrice":$(tr).find('td:eq(2)').find('input.ChangePrice').val(),
                        "changeType":$(tr).find('td:eq(3)').find('button.active').attr('type')
                    };
                });
                scopeChangeTableData.shift();
                var scopeChangeTableArray = scopeChangeTableData;

                var changeTotal = $('#scopeChangeModal #hiddenChangeTotal').val();
                var changeType = $('#scopeChangeModal #hiddenChangeType').val();
                // console.log(scopeChangeTableArray);
                
                $.ajax({
                    url: 'evaluation-scope-change-edit.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        evaluationID: evaluationID,
                        custom: custom,
                        quickbooksID: '<?php echo $quickbooksID; ?>',
                        scopeChange: scopeChangeTableArray,
                        changeTotal: changeTotal,
                        changeType: changeType
                    },
                    success: function(response) {
                        console.log(response);
                        if(response == 'true'){  
                            $('#loading-image').hide();
                            $('#scopeChangeModal').foundation('close');
                            $('#scopeChangeModal .scopeChangeItemTable tbody tr').not(':first').remove();
                        }   
                    }, error: function(jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }   
                }); 
                

            }

        };

        var addInvoiceTotalAmount = function() {
            //var value = parseFloat($(this).val());  
            //var updatedName = $(this).attr('name');
            var invoiceTotal = $('#bidTotal').text();
            var invoiceTotalFormat = invoiceTotal.replace(/,/g, '');
            invoiceTotalFormat = parseFloat(invoiceTotalFormat);

                var totalAmount = 0;
                $('#invoiceModal').find(".changeInvoiceAmount").each(function() {
                    var amount = $(this).val();

                    if (amount != '') {
                        var amountPercent = amount / invoiceTotalFormat * 100;
                        amountPercent = parseFloat(amountPercent).toFixed(2);

                        if ($(this).hasClass('default')) {
                            $(this).parent().parent().parent().parent().find('.changeInvoicePercent').val(amountPercent);
                        } else {
                            $(this).parent().parent().find('.changeInvoicePercent').val(amountPercent);
                        }

                        totalAmount += Number(amount); 
                    }
                    
                });

                totalAmount = parseFloat(totalAmount).toFixed(2);
                var newinvoiceTotal = invoiceTotalFormat - totalAmount;
                newinvoiceTotal = parseFloat(newinvoiceTotal).toFixed(2);

                $('#projectCompleteTotal').text(newinvoiceTotal);

                var totalPercent = 0;
                $('#invoiceModal').find(".changeInvoicePercent").each(function() {
                    var percent = $(this).val();

                    if (percent != '') {

                        totalPercent += Number(percent); 
                    }
                    
                });

                totalPercent = parseFloat(totalPercent).toFixed(2);
                var newinvoicePercent = 100 - totalPercent;
                newinvoicePercent = parseFloat(newinvoicePercent).toFixed(2);

                $('#invoiceSplitProjectComplete').text(newinvoicePercent);

        };


        var addInvoiceTotalPercent = function() {
            var invoiceTotal = $('#bidTotal').text();
            var invoiceTotalFormat = invoiceTotal.replace(/,/g, '');
            invoiceTotalFormat = parseFloat(invoiceTotalFormat);

            var totalPercent = 0;
            $('#invoiceModal').find(".changeInvoicePercent").each(function() {
                var percent = $(this).val();

                if (percent != '') {

                    var percentDecimal = percent / 100;

                    var amountPercent = invoiceTotalFormat * percentDecimal;
                    amountPercent = parseFloat(amountPercent).toFixed(2);

                    if ($(this).hasClass('default')) {
                        $(this).parent().parent().parent().parent().find('.changeInvoiceAmount').val(amountPercent);
                    } else {
                        $(this).parent().parent().find('.changeInvoiceAmount').val(amountPercent);
                    }
                    totalPercent += Number(percent); 
                }
                
            });

            totalPercent = parseFloat(totalPercent).toFixed(2);
            var newinvoicePercent = 100 - totalPercent;
            newinvoicePercent = parseFloat(newinvoicePercent).toFixed(2);

            $('#invoiceSplitProjectComplete').text(newinvoicePercent);

            var totalAmount = 0;
            $('#invoiceModal').find(".changeInvoiceAmount").each(function() {
                var amount = $(this).val();

                if (amount != '') {
                    totalAmount += Number(amount); 
                }
                
            });

            totalAmount = parseFloat(totalAmount).toFixed(2);
            var newinvoiceTotal = invoiceTotalFormat - totalAmount;
            newinvoiceTotal = parseFloat(newinvoiceTotal).toFixed(2);

            $('#projectCompleteTotal').text(newinvoiceTotal);

        };


        var finalizeCustomEvaluation = function() {

            var idToEdit = $(this).parent().parent().parent().attr('id');

            $('#invoiceModal .invoiceTable').attr('id', idToEdit);

            $('#bidTotalModal').foundation('open');
        };

        
        var finalizeCustomBid = function() {
            $('#loading-image').show();

            function ReplaceNumberWithCommas(Total) {
                //Seperates the components of the number
                var n= Total.toString().split(".");
                //Comma-fies the first part
                n[0] = n[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                //Combines the two sections
                return n.join(".");
            }

            // var discountTotal = $('.discountTotal').text();
            // var bidTotal = response.toString();
            // bidTotal = Number(bidTotal - discountTotal);

            //bidTotalModal
            var customBidTotal = $('input[name="customBidTotal"]').val();

            customBidTotal = customBidTotal.replace(/\,/g,"");

            $('input[name="customBidTotal"]').val('');
            
            var customBidTotalFormat = parseFloat(customBidTotal).toFixed(2);
            $('#bidTotal').html(ReplaceNumberWithCommas(customBidTotalFormat));

            
            var bidAcceptPercent = parseFloat($('[name="invoiceSplitBidAcceptance"]').val()); 
            var bidAcceptanceTotal = bidAcceptPercent / 100 * customBidTotal;
            bidAcceptanceTotal = parseFloat(bidAcceptanceTotal).toFixed(2);
            $('[name="bidAcceptanceTotal"]').val(bidAcceptanceTotal);
            
            var projectCompletePercent = parseFloat($('#invoiceSplitProjectComplete').text()); 
            var projectCompleteTotal = projectCompletePercent / 100 * customBidTotal;
            projectCompleteTotal = parseFloat(projectCompleteTotal).toFixed(2);
            $('#projectCompleteTotal').text(projectCompleteTotal);

            if ('<?php echo $defaultInvoices;  ?>' > 2) {
                var defaultTotalInvoices = '<?php echo $defaultInvoices;  ?>' - 2;

                for (i = 0; i < defaultTotalInvoices; i++) {
                    var oldValue = $('.invoiceTable tbody > tr:last-child input').attr("sort");
                    var newVal = parseFloat(oldValue) + 1;

                    $cloneBlankRow = $('.invoiceTable tbody tr:first').clone().css('display', '');
                    $('.invoiceTable tbody').append($cloneBlankRow);
                    $('.invoiceTable tbody > tr:last-child td input').attr("sort", "" + (newVal) + "");
                    $('.invoiceTable tbody > tr:last-child td input.changeInvoiceAmount').change(addInvoiceTotalAmount);
                    $('.invoiceTable tbody > tr:last-child td input.changeInvoicePercent').change(addInvoiceTotalPercent);

                }
            }
                
            $(".invoiceCountInput .invoiceCount").val('<?php echo $defaultInvoices;  ?>');
          
        
            //populate the bid number in the invoice modal with the next available bid number
            $.ajax({
                url: 'getLastBidNumber.php',
                dataType: "json",
                    data: {
                        companyID: $('#companyID').attr('value')
                    },
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                success: function (response) {
                    if (!response){
                        console.log("error");
                    }
                    else{   
                        if (response[0].bidNumber != null) {
                            $('[name="bidNumber"]').val(parseInt(response[0].bidNumber) + 1);   
                        } else {
                            $('[name="bidNumber"]').val('');    
                        }
                                        
                    }

                    $('#loading-image').hide();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });

            if ('<?php echo $qbConnectionStatus;  ?>' == 'qb-disconnected') {
                $('#disconnectedError').addClass('is-visible');
                $('#invoiceApprove').prop('disabled', 'disabled');
            }

            //Open Invoice Modal
            $('#invoiceModal').foundation('open');

        };
    
        var removeInvoiceRowError = function(){
            $(this).parent().removeClass('is-invalid-label');
            $(this).removeClass('is-invalid-input');
            $(this).parent().find('.form-error').removeClass('is-visible');
        };

   
        var invoiceApproveCustomBid = function(){
            var bidNumberValidate;
            var percentageValidate = 1;
            var projectCompletePercentInteger = Number($('#invoiceSplitProjectComplete').text());
            var percentageTotal = 0;

            $('.changeInvoicePercent').not('[sort="0"]').each(function () {
                if ($(this).val() != ''){
                    percentageTotal += Number($(this).val());
                }
            });

            percentageTotal += projectCompletePercentInteger;

            //console.log(percentageTotal);

            if (percentageTotal < 100 || percentageTotal > 100 ){
                percentageValidate = 0;
                $('.changeInvoicePercent').addClass('is-invalid-input');
            }
            else{
                $('.changeInvoicePercent').removeClass('is-invalid-input');
            }

            if (parseInt($('#invoiceSplitProjectComplete').text()) < 1){
                $('#invoiceSplitProjectComplete').addClass('is-invalid-label');
                percentageValidate = 0;
            }
            else{
                $('#invoiceSplitProjectComplete').removeClass('is-invalid-label');
            }

            var bidAcceptanceName = $('[name="bidAcceptanceName"]').val().trim();
            var projectCompleteName = $('[name="projectCompleteName"]').val().trim();

            if (bidAcceptanceName !='' && projectCompleteName !=''){ 
                var evaluationID = $('#invoiceModal .invoiceTable').attr('id');
                var bidNumberInput = $('[name="bidNumber"]').val();

                if (bidNumberInput != ''){
                    $.ajax({
                        url: 'checkBidNumber.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "GET",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            bidNumber: bidNumberInput
                        },
                        success: function (response) {
                            if (!response){
                                $('.changeBidNumber').removeClass('is-invalid-input');
                                // $('.form-error').removeClass('is-visible');
                                $('#bidNumberError').removeClass('is-visible');
                                //storeInvoiceData();
                                bidNumberValidate = 1;
                                validateSendBid();
                            }
                            else{       
                                $('.changeBidNumber').addClass('is-invalid-input');
                                // $('.form-error').addClass('is-visible');
                                $('#bidNumberError').addClass('is-visible');
                                bidNumberValidate = 0;
                                validateSendBid();
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                    });         
                } 
                
            }

            function validateSendBid() {
                // console.log('bidNumberValidate '+bidNumberValidate);
                // console.log('percentageValidate '+percentageValidate);
                if (bidNumberValidate == 1 && percentageValidate == 1) {
                    if (bidNumberInput != ''){ 
                        // console.log('Store Invoice Data');
                        
                        if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                            storeInvoiceData();
                        }
                        else{
                            if ($('#noEmailRequiredStatus').text() == "1"){
                                var text = 'no email.';
                            }
                            if ($('#unsubscribedStatus').text() == "1"){
                                var text = 'unsubscribed from emails.';
                            }

                            $('#emailWontSendModal').foundation('open');
                            $('#emailWontSendModal p').text('Bid will not be sent because the customer has ' + text + ' Continue?');
                        }
                    } 
                    // else {
                    //  //console.log('Store Invoice Data No Bid');
                    //  storeInvoiceDataNoBidNumber();
                    // }
                }
            }

                
        };


        function storeInvoiceData() {
            var invoiceTableData = new Array();
            $('#invoiceModal .invoiceTable tbody tr').each(function(row,tr){
                invoiceTableData[row]={
                    "invoiceName":$(tr).find('td:eq(0)').find('input').val(),
                    "invoiceSort":$(tr).find('td:eq(0)').find('input').attr('sort'),
                    "invoiceSplit":$(tr).find('td:eq(1)').find('input').val(),
                    "invoiceAmount":$(tr).find('td:eq(2)').find('input').val()
                };
            });
            invoiceTableData.shift();
            var invoiceTableArray = invoiceTableData

            //console.log(invoiceTableArray);

            var evaluationID = $('#invoiceModal .invoiceTable').attr('id');
            var bidNumberInput = $('[name="bidNumber"]').val();
    
            $('#loading-image').show();
            $.ajax({
                url: 'send-bid.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    evaluationID: evaluationID,
                    bidNumber: bidNumberInput,
                    bidAcceptanceName: $('#invoiceModal [name="bidAcceptanceName"]').val(),
                    bidAcceptanceAmount: $('#invoiceModal [name="bidAcceptanceTotal"]').val(),
                    projectCompleteName: $('#invoiceModal [name="projectCompleteName"]').val(),
                    projectCompleteAmount: $('#invoiceModal #projectCompleteTotal').text(),
                    bidAcceptanceSplit: $('#invoiceModal [name="invoiceSplitBidAcceptance"]').val(),
                    projectCompleteSplit: $('#invoiceModal #invoiceSplitProjectComplete').text(),
                    bidSubTotal: '',
                    bidTotal: $('#bidTotal').text(),
                    invoiceArray: invoiceTableArray,
                    customEvaluation: 'true'

                },
                success: function (response) {
                    //console.log(response);
                    //Open Bend Sent Modal
                    if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                        $('#bidSentModal').foundation('open');
                    }

                    $('#invoiceModal .invoiceTable tbody tr').not(':first').remove();

                    $('#invoiceModal .invoiceTable').attr('id', '');

                    $('input[name="invoiceSplitBidAcceptance"]').val('<?php echo $invoiceSplitBidAcceptance;  ?>');
                    $('input[name="bidAcceptanceTotal"]').val('');

                    $('#invoiceSplitProjectComplete').text('<?php echo $invoiceSplitProjectComplete;  ?>');
                    $('#projectCompleteTotal').text('');

                    $('#evaluationList').empty();

                    //Get Project Evaluations
                    projectEvaluations();

                    // //Get Billing info
                    // populateBillingInfo();
                    $('#loading-image').hide();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        }
   

        //Resend Customer Bid Email from Evaluation/Bid Tab
        var resendBidEmailCustomer = function() {
            var idToResend = $(this).parent().parent().parent().attr('id');
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'resend-bid.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        idToResend: idToResend
                    },
                    success: function (response) {
                        if (response == 'true') {
                            $('#loading-image').hide();

                            $('#emailSentModal h3').text('Bid Email Resent');
                            $('#emailSentModal p.modalContent').html('Your bid has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Resend Customer Bid Email from History Tab
        var resendBidEmail = function() {
            var idToResend = $(this).parent().parent().attr('id');
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'resend-bid.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        idToResend: idToResend
                    },
                    success: function (response) {
                        if (response == 'true') {
                            $('#loading-image').hide();
                            $('#emailSentModal h3').text('Bid Email Resent');
                            $('#emailSentModal p.modalContent').html('Your bid has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Resend Bid Accept Email from History Tab
        var resendBidAcceptedEmail = function() {
            var idToResend = $(this).parent().parent().attr('id');
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'bid-accept-email.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        id: idToResend,
                        email: 'send',
                        resend: 'resend'
                    },
                    success: function (response) {
                        if (response == 'true') {
                            $('#loading-image').hide();
                            $('#emailSentModal h3').text('Bid Accept Email Resent');
                            $('#emailSentModal p.modalContent').html('The bid accept email has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Resend Bid Reject Email from History Tab
        var resendBidRejectedEmail = function() {
            var idToResend = $(this).parent().parent().attr('id');
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'bid-reject-email.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        id: idToResend,
                        resend: 'resend'
                    },
                    success: function (response) {
                        if (response == 'true') {
                            $('#loading-image').hide();
                            $('#emailSentModal h3').text('Bid Reject Email Resent');
                            $('#emailSentModal p.modalContent').html('The bid reject email has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Resend Evaluation Email from History Tab
        var resendEvaluationEmail = function() {
            var idToResend = $(this).parent().parent().attr('id');
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'resend-schedule.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        idToResend: idToResend,
                        type: 'evaluation'
                    },
                    success: function (response) {
                        if (response == 'true') {
                            $('#loading-image').hide();
                            $('#emailSentModal h3').text('Evaluation Email Resent');
                            $('#emailSentModal p.modalContent').html('The evaluation email has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');

                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Resend Installation Email from History Tab
        var resendInstallationEmail = function() {
            var idToResend = $(this).parent().parent().attr('id');
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'resend-schedule.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        idToResend: idToResend,
                        type: 'installation'
                    },
                    success: function (response) {
                        if (response == 'true') {
                            $('#loading-image').hide();
                            $('#emailSentModal h3').text('Installation Email Resent');
                            $('#emailSentModal p.modalContent').html('The installation email has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Send Customer Final Report
        var sendFinalReport = function() {
            var idToSend = $(this).parent().parent().parent().attr('id');

            if ($(this).parent().parent().parent().attr('custom') == 'true') {
                var custom = 'true';
            } else {
                var custom = '';
            }
            //console.log(idToResend);
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'final-email.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        projectID: '<?php echo $projectID;  ?>',
                        evaluationID: idToSend,
                        email: 'send',
                        custom: custom
                    },
                    success: function (response) {
                        if (response == 'true') {
                            //$('#loading-image').hide();
                            $.ajax({
                                url: 'finalReportSent.php',
                                dataType: "json",
                                contentType: 'application/json',
                                type: "POST",
                                contentType: "application/x-www-form-urlencoded",
                                data: {
                                    evaluationID: idToSend,
                                    finalReportSentByID: '<?php echo $userID;  ?>'
                                },
                                success: function (response) {
                                    if (response == 'true') {
                                        $('#evaluationList').empty();

                                        //Get Project Evaluations
                                        projectEvaluations();

                                        projectHistory();

                                        $('#loading-image').hide();
                                        $('#emailSentModal h3').text('Final Report Sent');
                                        $('#emailSentModal p.modalContent').html('Your final report has been sent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                                        $('#emailSentModal').foundation('open');
                                    }
                               }, error: function (jqXHR, textStatus, errorThrown) {
                                    console.log(textStatus, errorThrown);
                                    console.log(jqXHR.responseText);
                                }     
                            });
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        //Resend Final Report
        var resendFinalReportEmail = function(){
            var idToResend = $(this).parent().parent().attr('id');
            //console.log(idToResend);
           if ($('#noEmailRequiredStatus').text() == "0" && $('#unsubscribedStatus').text() == "0"){
                $('#loading-image').show();
                $.ajax({
                    url: 'final-email.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        projectID: '<?php echo $projectID;  ?>',
                        evaluationID: idToResend,
                        email: 'send'
                    },
                    success: function (response) {
                        if (response == 'true') {
                           
                            $('#loading-image').hide();
                            $('#emailSentModal h3').text('Final Report Resent');
                            $('#emailSentModal p.modalContent').html('Your final report has been resent to <?php echo $firstNameDisplay;  ?> <?php echo $lastNameDisplay;  ?> at <?php echo $email;  ?>.');
                            $('#emailSentModal').foundation('open');
                               
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };


        //Edit Evaluation Name
        var editEvaluationName = function(){
            var idToEdit = $(this).parent().parent().parent().parent().parent().attr('id');
            $('#editEvaluationNameModal #idToEdit').val(idToEdit);

            $.ajax({
                url: 'getEvaluation.php',
                dataType: "json",
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    evaluationID: idToEdit
                },
                success: function (response) {
                    if (response != '') {
                       //console.log(response);
                        $('#editEvaluationNameModal input[name="evaluationDescription"]').val(response.evaluationDescription);
                    }

                    $('#editEvaluationNameModal').foundation('open');

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });

        };

        //Save Evaluation Name
        var saveEvaluationName = function(){
            var idToEdit = $('#editEvaluationNameModal #idToEdit').val();
            var evaluationDescription = $('#editEvaluationNameModal input[name="evaluationDescription"]').val();
            //console.log(idToEdit);
           
           if (evaluationDescription == '') {
                $('#editEvaluationNameModal input[name="evaluationDescription"]').parent().addClass('is-invalid-label');
                $('#editEvaluationNameModal input[name="evaluationDescription"]').addClass('is-invalid-input');
                $('#editEvaluationNameModal input[name="evaluationDescription"]').parent().find('.form-error').addClass('is-visible');

           } else {
                $('#editEvaluationNameModal input[name="evaluationDescription"]').parent().removeClass('is-invalid-label');
                $('#editEvaluationNameModal input[name="evaluationDescription"]').removeClass('is-invalid-input');
                $('#editEvaluationNameModal input[name="evaluationDescription"]').parent().find('.form-error').removeClass('is-visible');

                $('#loading-image').show();
                $.ajax({
                    url: 'evaluation-edit-name.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        evaluationID: idToEdit,
                        evaluationDescription: evaluationDescription
                    },
                    success: function (response) {
                        if (response == 'true') {
                        
                            $('#'+idToEdit+'.callout').find('h5 span').eq(0).text(evaluationDescription +' Evaluation');

                            // $('#evaluationList').empty();

                            // //Get Project Evaluations
                            // projectEvaluations();

                            $('#loading-image').hide();
                            $('#editEvaluationNameModal').foundation('close');
                               
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };


        var closeEditEvaluationModal = function(){
            $('#editEvaluationNameModal #idToEdit').val('');
            $('#editEvaluationNameModal input[name="evaluationDescription"]').val('');

            $('#editEvaluationNameModal').foundation('close');
        };

        var addNote = function(){
            $('#addNoteModal').foundation('open');
        };

        var addNewNote = function(){
            var noteText = $('#addNoteModal textarea[name="note"]').val();
            var projectID = $('#projectID').val();

            if ($('#addNoteModal input[name="isPinnedAdd"]').is(':checked')) {
                var isPinned = 1;
            } else {
                var isPinned = 0;
            }
            

            if (noteText == '') {
                $('#addNoteModal textarea[name="note"]').parent().addClass('is-invalid-label');
                $('#addNoteModal textarea[name="note"]').addClass('is-invalid-input');
                $('#addNoteModal textarea[name="note"]').parent().find('.form-error').addClass('is-visible');

            } else {
                $('#loading-image').show();

                var noteTag = null;

                $.ajax({
                    url: 'note-add.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        projectID: projectID,
                        noteText: noteText, 
                        isPinned: isPinned, 
                        noteTag: noteTag
                    },
                    success: function (response) {  
                        if (response == 'true') {
                            $('#addNoteModal textarea[name="note"]').val('');
                            $('#addNoteModal input[name="isPinnedAdd"]').prop('checked', false);

                            $('#projectNotes.pinnedNotes').empty();
                            $('#projectNotes.nonPinnedNotes').empty();
                            $('#projectTabNotes').empty();

                            projectNotes();

                            $('#loading-image').hide();

                            $('#addNoteModal').foundation('close');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        var closeAddNoteModal = function(){
            $('#addNoteModal textarea[name="note"]').val('');
            $('#addNoteModal input[name="isPinnedAdd"]').prop('checked', false);

            $('#addNoteModal').foundation('close');
        };

        var editNote = function(){
            $('#loading-image').show();

            var idToEdit = $(this).parent().parent().parent().parent().attr('id');
            $('#editNoteModal #idToEdit').val(idToEdit);

            var projectID = $('#projectID').val();

            $.ajax({
                url: 'getNote.php',
                dataType: "json",
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    noteID: idToEdit, 
                    projectID: projectID
                },
                success: function (response) {  
                    if (!response == '') {
                        $.each(response, function (i, item) {

                            $('#editNoteModal textarea[name="note"]').val(decodeEntities(item.note));

                            if (item.isPinned == 1) {
                                $('#editNoteModal [name="isPinnedEdit"]').prop('checked', true);
                            } else {
                                $('#editNoteModal [name="isPinnedEdit"]').prop('checked', false);
                            }

                            $('#editNoteModal').foundation('open');

                            var ta = document.querySelector('#editNoteModal textarea[name="note"]');
                            autosize.update(ta);

                            $('#loading-image').hide();
                            
                        });
                    }

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });

        };

        var pinNote = function(){
            $('#loading-image').show();

            var idToEdit = $(this).parent().parent().parent().parent().attr('id');
            var projectID = $('#projectID').val();

            if ($(this).hasClass('on')){
                isPinned = 0;
            } else if ($(this).hasClass('off')) {
                isPinned = 1;
            }

            //console.log(isPinned);

            $.ajax({
                url: 'note-edit-pin.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    noteID: idToEdit, 
                    projectID: projectID,
                    isPinned: isPinned
                },
                success: function (response) {
                    if (response == 'true') {
                        $('#projectNotes.pinnedNotes').empty();
                        $('#projectNotes.nonPinnedNotes').empty();
                        $('#projectTabNotes').empty();

                        projectNotes();

                        $('#loading-image').hide();
                    }

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });

        };

        var saveEditNote = function(){
            var idToEdit = $('#editNoteModal #idToEdit').val();
            var projectID = $('#projectID').val();
            var noteText = $('#editNoteModal textarea[name="note"]').val();

            if ($('#editNoteModal input[name="isPinnedEdit"]').is(':checked')) {
                var isPinned = 1;
            } else {
                var isPinned = 0;
            }
            
            if (noteText == '') {
                $('#editNoteModal textarea[name="note"]').parent().addClass('is-invalid-label');
                $('#editNoteModal textarea[name="note"]').addClass('is-invalid-input');
                $('#editNoteModal textarea[name="note"]').parent().find('.form-error').addClass('is-visible');

            } else {
                $('#loading-image').show();

                $.ajax({
                    url: 'note-edit.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        noteID: idToEdit,
                        projectID: projectID,
                        noteText: noteText, 
                        isPinned: isPinned
                    },
                    success: function (response) {  
                        if (response == 'true') {
                            $('#editNoteModal #idToEdit').val('');
                            $('#editNoteModal textarea[name="note"]').val('');
                            $('#editNoteModal input[name="isPinnedEdit"]').prop('checked', false);

                            $('#projectNotes.pinnedNotes').empty();
                            $('#projectNotes.nonPinnedNotes').empty();
                            $('#projectTabNotes').empty();

                            projectNotes();

                            $('#loading-image').hide();

                            $('#editNoteModal').foundation('close');
                        }

                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }

                });
            }
        };

        var closeEditNoteModal = function(){
            $('#editNoteModal #idToEdit').val('');
            $('#editNoteModal textarea[name="note"]').val('');
            $('#editNoteModal input[name="isPinnedEdit"]').prop('checked', false);

            $('#editNoteModal').foundation('close');
        };

        var deleteNote = function(){
            var idToDelete = $('#editNoteModal #idToEdit').val();
            $('#deleteNoteModal #idToDelete').val(idToDelete);

            $('#deleteNoteModal').foundation('open');
        };

        var yesDeleteNote = function(){
            $('#loading-image').show();

            var idToDelete = $('#deleteNoteModal #idToDelete').val();
            var projectID = $('#projectID').val();

            $.ajax({
                url: 'note-delete.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    noteID: idToDelete,
                    projectID: projectID
                },
                success: function (response) {  
                    if (response == 'true') {
                        $('#deleteNoteModal #idToDelete').val('');

                        $('#projectNotes.pinnedNotes').empty();
                        $('#projectNotes.nonPinnedNotes').empty();
                        $('#projectTabNotes').empty();

                        projectNotes();

                        $('#loading-image').hide();

                        $('#deleteNoteModal').foundation('close');
                    }

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });
        };

        var closeDeleteNoteModal = function(){
            $('#deleteNoteModal #idToDelete').val('');

            $('#deleteNoteModal').foundation('close');
        };

        //Display Calendar
        var filterCalendar = function (defaultView) {

            //$('#scheduleModalDD select > option').not(':first').remove();
            var date = $('input#currentDate').val();

            $('#calendar').fullCalendar('destroy');
            $('#calendar').fullCalendar('render');

            $('#calendar').fullCalendar({
                header: {
                    left: '',
                    center: '',
                    right: ''
                },
                views: {
                    timelineDay: {
                        buttonText: 'Daily',
                        titleFormat: 'dddd MMMM D, YYYY'
                    },
                    agendaWeek: {
                        buttonText: 'Weekly',
                        itleFormat: 'MMMM D' //[ YYYY]{ '&#8212;' MMMM D YYYY}"
                    },
                    month: {
                        buttonText: 'Monthly',
                        titleFormat: 'MMMM YYYY'
                    }
                },
                slotDuration: '00:15:00',
                slotLabelFormat: 'hA',
                scrollTime: '08:00:00',
                defaultView: defaultView,
                aspectRatio: 1.8,
                defaultDate: date,
                fixedWeekCount: false,
                selectable: true,
                selectHelper: false,
                unselectAuto: false,
                editable: false,
                eventLimit: true, // allow "more" link when too many events
                overlap: false,
                eventOverlap: false,
                eventColor: '#f6f7fb',
                businessHours: {
                    start: '8:00',
                    end: '17:00',
                    dow: [0, 1, 2, 3, 4, 5, 6]
                },
                resourceLabelText: ' ',
                resources: {
                    url: 'getResources.php',
                    data: {
                        filter: $("select#filterResources option:selected").val()
                    },
                    success: function (response) {
                        //$('#script-warning').show();
                        //console.log(response);
                        $('#scheduleModalDD select').empty();
                        $.each(response, function (i, item) {
                            $('#scheduleModalDD select').append('<option value="' + item.id + '">' + item.title + '</option>');
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                },
                dayClick: function (date, jsEvent, view) {
                    var date = date.format();
                    var coordinates = jsEvent.pageX + ',' + jsEvent.pageY;
                    var view = view.name;

                    if (view != 'timelineDay') {
                        $('#weeklyView, #monthlyView').removeClass('active');
                        $('#dailyView').addClass('active');
                        $('#calendar').fullCalendar('changeView', 'timelineDay');
                        $('#calendar').fullCalendar('gotoDate', date);
                    }
                },
                select: function (start, end, jsEvent, view, resource) {
                    var view = view.name;

                    // console.log("view " + view);
                    if (view == 'timelineDay') {

                        //Check if event exists already
                        // if ($('input[name="tempID"]').val() =='') {

                            //Render Event
                            var eventData;
                            var firstName = $('#firstName').text();
                            var lastName = $('#lastName').text();
                            var eventType = $('#eventType').val();

                            eventData = {
                                title: firstName + ' ' + lastName + ' ' + eventType,
                                start: start,
                                end: end,
                                resourceId: resource.id,
                                address: $('#address').text(),
                                city: $('#city').text(),
                                state: $('#state').text(),
                                zip: $('#zip').text()
                            };

                            $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true


                            //Get Temporary Event ID
                            var clientEvents = $('#calendar').fullCalendar('clientEvents');
                            var lastEvent = clientEvents[clientEvents.length - 1];
                            var lastId = lastEvent._id;

                            //Open Add Event Modal
                            $('#addEvent').foundation('open');


                            //Populate Modal with Data from Select Event
                            if ($('input[name="projectScheduleID"]').val() == '') {
                                     if (eventType == 'Evaluation') {
                                    $('#addEvent #modalTitle').text('Schedule Evaluation');
                                        if('<?php echo $firstName; ?>'!=""){
                                        $('#addEvent p.lead').text('Add Appointment For <?php echo $firstName; ?> <?php echo $lastName; ?>');
                                        }
                                            else{
                                         $('#addEvent p.lead').text('Add Appointment');
                                            }
                                    $('#addEvent p.lead').text('Add Appointment For <?php echo $firstName; ?> <?php echo $lastName; ?>');
                                    $('#addEvent .scheduledTitle').text('Salesperson');

                                } else if (eventType == 'Installation') {
                                    $('#addEvent #modalTitle').text('Schedule Installation');
                                    if('<?php echo $firstName; ?>'!=""){
                                    $('#addEvent p.lead').text('Add Installation For <?php echo $firstName; ?> <?php echo $lastName; ?>');
                                    }else{
                                    $('#addEvent p.lead').text('Add Appointment');
                                        }
                                    $('#addEvent .scheduledTitle').text('Installer');
                                }
                                }
                             else {
                                if (eventType == 'Evaluation') {
                                    $('#addEvent #modalTitle').text('Reschedule Evaluation');
                                     if('<?php echo $firstName; ?>'!=""){
                                    $('#addEvent p.lead').text('Update Appointment For <?php echo $firstName; ?> <?php echo $lastName; ?>');
                                        }else{
                                    $('#addEvent p.lead').text('Update Appointment'); 
                                        }
                                    $('#addEvent .scheduledTitle').text('Salesperson');

                                } else if (eventType == 'Installation') {
                                    $('#addEvent #modalTitle').text('Reschedule Installation');
                                   if('<?php echo $firstName; ?>'!=''){ 
                                    $('#addEvent p.lead').text('Update Installation For <?php echo $firstName; ?> <?php echo $lastName; ?>');
                                        }else{
                                     $('#addEvent p.lead').text('Update Installation');
                                        }
                                    $('#addEvent .scheduledTitle').text('Installer');
                                }
                                }
                            

                            
                            //set Start Date & Time
                            var startDate = moment(eventData.start).format("MM/DD/YYYY");
                            var startTime = moment(eventData.start).format("HH:mm");
                            var startTimeAMPM = moment(eventData.start).format("h : mm A");
                            var startTimeString = startTime.toString();

                            var StartTimeOptions ={
                                        now: startTimeString,
                                        twentyFour: false,  //Display 24 hour format, defaults to false
                                        upArrow: 'wickedpicker__controls__control-up',  //The up arrow class selector to use, for custom CSS
                                        downArrow: 'wickedpicker__controls__control-down', //The down arrow class selector to use, for custom CSS
                                        close: 'wickedpicker__close', //The close class selector to use, for custom CSS
                                        hoverState: 'hover-state', //The hover state class to use, for custom CSS
                                        title: "Select a time", //The Wickedpicker's title,
                                        showSeconds: false, //Whether or not to show seconds,
                                        secondsInterval: 1, //Change interval for seconds, defaults to 1,
                                        minutesInterval: 5, //Change interval for minutes, defaults to 1
                                        beforeShow: null, //A function to be called before the Wickedpicker is shown
                                        show: function(){
                                            var modal = $('input[name="scheduledStartTime"]').closest('#addEvent');
                                            var datePicker = $('body').find('.wickedpicker');
                                                if(!modal.length) {
                                                    $(datePicker).css('z-index', 'auto');
                                                    return;
                                                }
                                            var zIndexModal = $(modal).css('z-index');
                                                $(datePicker).css('z-index', zIndexModal + 1);
                                            }, //A function to be called when the Wickedpicker is shown
                                        clearable: false //Make the picker's input clearable (has clickable "x")
                                    };

                                    

                            //set End Date & Time
                            var endDate = moment(eventData.end).format("MM/DD/YYYY");
                            var endTime = moment(eventData.end).format("HH:mm");  
                            var endTimeAMPM = moment(eventData.end).format("h : mm A");
                            var endTimeString = endTime.toString();
                                    var EndTimeOptions ={
                                    now: endTimeString,
                                    twentyFour: false,  //Display 24 hour format, defaults to false
                                    upArrow: 'wickedpicker__controls__control-up',  //The up arrow class selector to use, for custom CSS
                                    downArrow: 'wickedpicker__controls__control-down', //The down arrow class selector to use, for custom CSS
                                    close: 'wickedpicker__close', //The close class selector to use, for custom CSS
                                    hoverState: 'hover-state', //The hover state class to use, for custom CSS
                                    showSeconds: false, //Whether or not to show seconds,
                                    secondsInterval: 1, //Change interval for seconds, defaults to 1,
                                    minutesInterval: 5, //Change interval for minutes, defaults to 1
                                    beforeShow: null, //A function to be called before the Wickedpicker is shown
                                    show: function(){
                                            var modal = $('input[name="scheduledEndTime"]').closest('#addEvent');
                                            var datePicker = $('body').find('.wickedpicker');
                                                if(!modal.length) {
                                                    $(datePicker).css('z-index', 'auto');
                                                    return;
                                                }
                                            var zIndexModal = $(modal).css('z-index');
                                                $(datePicker).css('z-index', zIndexModal + 1);
                                            }, //A function to be called when the Wickedpicker is shown
                                    clearable: false, //Make the picker's input clearable (has clickable "x")
                                    };


                                if(/iPhone|iPad|iPod/i.test(navigator.userAgent) ){
                                    $('input[name="scheduledStartTime"]').val(startTime);
                                    $('input[name="scheduledEndTime"]').val(endTime);
                                }else{

                                    $('#scheduledStartTime').wickedpicker(StartTimeOptions);
                                    $('#scheduledStartTime').val(startTimeAMPM);
                        
                                    $('#scheduledEndTime').wickedpicker(EndTimeOptions);            
                                    $('input[name="scheduledEndTime"]').val(endTimeAMPM);
                                }

                              $('input[name="scheduledStartDate"]').val(startDate);
                              $('input[name="scheduledEndDate"]').val(endDate);

                            //salesperson info
                            $('select[name="salesperson"]').find("option[value='" + resource.id + "']").prop('selected', true);
                            $('input[name="tempID"]').val(lastId);
                        
                            if (new Date($('input[name="scheduledStartDate"]').val()) < today) {
                                if ($('.callout.small.alert').length < 1){
                                    $('#addEvent').append('<div class="callout small alert"><p>Please note that one of the selected dates is in the past.</p></div>');
                                }
                            }    

                    }
                },
                events: function (start, end, timezone, callback) {
                    var start = moment(start).format("YYYY/MM/DD");
                    var end = moment(end).format("YYYY/MM/DD");

                    getEvents(start, end, timezone, callback);
                },
                //		eventClick: function(calEvent, jsEvent, view) {
                //				if (calEvent.length) {
                //					$.ajax({
                //						url: 'getEventDetail.php',
                //						dataType: "json",
                //						contentType: 'application/json',
                //						type: "GET",
                //						contentType: "application/x-www-form-urlencoded",
                //						data: {
                //							eventID: calEvent.id,
                //							eventType: calEvent.eventType
                //						},
                //						success: function(response) {
                //							//console.log(response);
                //							$.each(response, function (i, item) {
                //
                //								if (calEvent.eventType == '1') {
                //									$('#viewEvent').append('<h2 id="modalTitle">'+item.firstName+ ' ' +item.lastName+' ' +item.scheduleType+'</h2><p>' +item.scheduled+'<br/>Start: ' +item.start+'<br/>End: ' +item.end+' </p><p>' +item.address+ '<br/>' +item.city+ ', ' +item.state+ ' ' +item.zip+ '<br/>' +item.phoneNumber+ '<br/>' +item.email+ '<br/><a href="project-management.php?pid=' +item.projectID+ '">View Project</a><br/><br/>Scheduled by: ' +item.scheduledByFirstName+ ' ' +item.scheduledByLastName+ ' on ' +item.scheduledOn+ '</p><button class="close-button" data-close aria-label="Close reveal" type="button"><span aria-hidden="true">&times;</span></button>');
                //								} else {
                //									$('#viewEvent').append('<h2 id="modalTitle">'+item.scheduledFirstName+ ' ' +item.scheduledLastName+' ' +item.scheduleType+'</h2><p>Start: ' +item.start+'<br/>End: ' +item.end+' </p><p>Scheduled by: ' +item.scheduledByFirstName+ ' ' +item.scheduledByLastName+ ' on ' +item.scheduledOn+ '</p><button class="close-button" data-close aria-label="Close reveal" type="button"><span aria-hidden="true">&times;</span></button>');
                //								}
                //							});
                //						}, error: function(jqXHR, textStatus, errorThrown) {
                //							console.log(textStatus, errorThrown);
                //							console.log(jqXHR.responseText);
                //						}
                //
                //					});
                //
                //					$('#viewEvent').foundation('open');
                //					$('#viewEvent').on('closed.zf.reveal', function(){
                //                		$('#viewEvent').empty();
                //					});
                //				} else {
                //					$('input.evaluationData, select.evaluationData').removeClass('changed')
                //
                //						$('#addEvent').foundation('open');
                //				}
                //
                //    		},
                eventRender: function (event, element) {
                    if (event.rendering == 'background') {
                        element.append(event.title);
                    }

                    //Decode customer name on calendar
                    var name = (element.find('.fc-title').text());
                    element.find('.fc-title').text(decodeEntities(name));

                    if (event.start == null || event.end == null) return;
                    event.end.local();
                    event.start.local();

                    //var startDate = new Date(event.start._d)
                    //var newStartDate = $.datepicker.formatDate("MM dd, yy", startDate);

                    //var endDate = new Date(event.end._d)
                    //var newEndDate = $.datepicker.formatDate("MM dd, yy", endDate);


                    var view = $('#calendar').fullCalendar('getView');
                    var eventToReschedule = $('input[name="projectScheduleID"]').val();
                                 
                    if (view.name === 'timelineDay') {
                        if (event.scheduleType == 'Installation') {
                            element.find('.fc-title').append('<br/><span class="fc-title-type">Installation: ' + $.datepicker.formatDate("MM dd, yy", event.start._d) + ' - ' + (event.end.format('hh:mm:ss a') == '12:00:00 am' ? $.datepicker.formatDate("MM dd, yy", event.end.add(-1, 'second')._d) : $.datepicker.formatDate("MM dd, yy", event.end._d)) + '</span>');
                        element.css('padding', '.2rem');
                        element.find('.fc-title').prepend('<div style="width: .3rem;background-color:' + event.calendarBgColor + ';height: 2.1rem;float: left;margin-left: 3px;"></div>');
                        }
                        if (event.scheduleType == 'Evaluation'){
                            element.find('.fc-title').append('<br/><span class="fc-title-type">Evaluation</span>');
                            element.find('.fc-title').append('<br/><span class="fc-title-address">' + event.address + '</span><br/><span class="fc-title-city">' + event.city + ", " + event.state + ' ' + event.zip + '</span>');
                        }

                                 if (event.id == eventToReschedule) {
                                    element.find('.fc-title').parents("a").css("background-color","#CDE9FA");
                                    }      
                    }

                    else if (view.name === 'agendaWeek') {
                        if (event.allDay == '1') {
                            element.find('.fc-title').append('<span class="fc-title-address"> ' + event.address + ', ' + event.city + ", " + event.state + ' ' + event.zip + '</span>');
                            element.find('.fc-title').prepend('<div style="width: .3rem;background-color:' + event.calendarBgColor + ';height: 2.3rem;float: left;margin-left: 3px;margin-right: 3px;"></div>');
                            if (event.scheduleType == 'Installation') 
                                element.find('.fc-title').append('<br/><span class="fc-title-type">Installation: ' + $.datepicker.formatDate("MM dd, yy", event.start._d) + ' - ' + (event.end.format('hh:mm:ss a') == '12:00:00 am' ? $.datepicker.formatDate("MM dd, yy", event.end.add(-1, 'second')._d) : $.datepicker.formatDate("MM dd, yy", event.end._d)) + '</span>');
                            if (event.scheduleType == 'Evaluation') 
                                element.find('.fc-title').append('<br/><span class="fc-title-type">Evaluation</span>');

                        } else {
                            if (event.scheduleType == 'Installation')
                             element.find('.fc-title').append('<br/><span class="fc-title-type">Installation: ' + $.datepicker.formatDate("MM dd, yy", event.start._d) + ' - ' + (event.end.format('hh:mm:ss a') == '12:00:00 am' ? $.datepicker.formatDate("MM dd, yy", event.end.add(-1, 'second')._d) : $.datepicker.formatDate("MM dd, yy", event.end._d)) + '</span>');
                            if (event.scheduleType == 'Evaluation') 
                                element.find('.fc-title').append('<br/><span class="fc-title-type">Evaluation</span>');
                            element.find('.fc-title').append('<br/><span class="fc-title-address">' + event.address + '</span><br/><span class="fc-title-city">' + event.city + ", " + event.state + ' ' + event.zip + '</span>');
                            element.find('.fc-time').prepend('<div style="width: .3rem;background-color:' + event.calendarBgColor + ';height: 5.3rem;float: left;margin-right: 5px;"></div>');
                        }
                                    
                                    if (event.id == eventToReschedule) {
                                        element.find('.fc-title').parents("a").css("background-color","#CDE9FA");
                                    }      
                    }

                    else if (view.name === 'month') {
                        if (event.allDay == '1') {
                            element.find('.fc-title').append('<span class="fc-title-address"> ' + event.address + ', ' + event.city + ", " + event.state + ' ' + event.zip + '</span>');
                        }
                        element.find('.fc-title').prepend('<div style="width: .3rem;background-color:' + event.calendarBgColor + ';height: 2.3rem;float: left;margin-left: 3px;margin-right: 3px;"></div>');
                        if (event.scheduleType == 'Installation') 
                            element.find('.fc-title').append('<br/><span class="fc-title-type">Installation: ' + $.datepicker.formatDate("MM dd, yy", event.start._d) + ' - ' + (event.end.format('hh:mm:ss a') == '12:00:00 am' ? $.datepicker.formatDate("MM dd, yy", event.end.add(-1, 'second')._d) : $.datepicker.formatDate("MM dd, yy", event.end._d)) + '</span>');
                        if (event.scheduleType == 'Evaluation') 
                        {
    
                             /*   var eventToReschedule = $('input[name="projectScheduleID"]').val();
                                 if (event.id == eventToReschedule) {
                                     element.find('.fc-title').parent().parent().css("background-color","#74c8fc");
                                    }*/
                                  element.find('.fc-title').append('<br/><span class="fc-title-type">Evaluation</span>');
                            
                        }
                           if (event.id == eventToReschedule) {
                                    element.find('.fc-title').parents("a").css("background-color","#CDE9FA");
                                    }                        
                       
                    }
                    
                                

                     
                },
                eventAfterAllRender: function (view) {
                    if ($('.fc-toolbar').length > 0) {
                        if (view.name === 'timelineDay') {
                            //if ($('#calendarMap').length > 0) {
                            //    if (!$('#calendarMap').is('.fc-view-container *')) {
                            $('#calendarMap').remove();
                            $('.fc-view-container').before('<div id="calendarMap"></div>');
                            //    }
                            //    else $('#calendarMap').empty();
                            //}
                            //else $('.fc-view-container').before('<div id="calendarMap"></div>');
                            initializeMap();
                        }
                        else $('#calendarMap').remove();
                    }
                },
                viewRender: function (view, element) {
                    var moment = $('#calendar').fullCalendar('getDate');
                    var momentFormat = moment.format();

                    $('#currentDate').val(momentFormat);


                    if (view.name === 'timelineDay') {
                        var momentFormat = moment.format('dddd MMMM D, YYYY');
                        $('#calendarTitle').text(momentFormat);

                        $('.fc-expander-space').remove();

                        //$(element).height(auto);
                        $('#calendar').fullCalendar('option', 'contentHeight', 'auto');

                        //if ($('#calendarMap').length > 0) $('#calendarMap').empty();
                        //else $('.fc-view-container').before('<div id="calendarMap"></div>');

                        //initializeMap();

                    } else if (view.name === 'agendaWeek') {
                        //var momentFormat = moment.format('MMMM D');
                        var viewStart = view.intervalStart.format('MMMM D');
                        var viewEnd = view.intervalEnd.format('MMMM D YYYY');

                        var newdate = new Date(viewEnd);
                        newdate.setDate(newdate.getDate() - 1); // minus the date
                        var viewEndNew = new Date(newdate);
                        var viewEndNewFormat = $.datepicker.formatDate("MM d", viewEndNew);

                        $('#calendarTitle').text(viewStart + ' - ' + viewEndNewFormat);

                        $('#calendar').fullCalendar('option', 'contentHeight', '');
                        $('#calendarMap').remove();
                    } else if (view.name === 'month') {
                        var momentFormat = moment.format('MMMM YYYY');
                        $('#calendarTitle').text(momentFormat);

                        $('#calendar').fullCalendar('option', 'contentHeight', '');
                        $('#calendarMap').remove();
                    }
                },
                resourceRender: function (resourceObj, labelTds, bodyTds) {
                    var role = resourceObj.installation == "1" ? "Installation" : "";
                    if (resourceObj.sales == "1") {
                        if (role.length > 0) role += ", ";
                        role += "Sales";
                    }
                    labelTds.find('.fc-cell-content').append($('<span class="fc-cell-role"></span>').text(role));

                    $('#calendar').find('tr[data-resource-id="' + resourceObj.id + '"] .fc-cell-content').before('<div style="width: .3rem;background-color:' + resourceObj.calendarBgColor + ';height: 4.2rem;float: left;margin-left: 3px;margin-top: 0.4rem;"></div>');

                    //Decode name on calendar
                    var title = $('#calendar').find('tr[data-resource-id="' + resourceObj.id + '"] .fc-cell-content .fc-cell-text').text();
                    $('#calendar').find('tr[data-resource-id="' + resourceObj.id + '"] .fc-cell-content .fc-cell-text').text(decodeEntities(title));
                }
            });

        };

        //Get Events in Current View
        var getEvents = function (start, end, timezone, callback) {
            $('#loading-image').show();
            $.ajax({
                url: 'getEvents.php',
                dataType: 'json',
                data: {
                    filter: $("select#filterResources option:selected").val(),
                    start: start, //moment(start).format("YYYY/MM/DD"),
                    end: end//moment(end).format("YYYY/MM/DD")
                },
                success: function (doc) {
                    $('#loading-image').hide();
                    if ($('.fc-toolbar').length > 0) {
                        var events = eval(doc);
                        callback(events);
                    }
                    else {
                        //console.log(doc);
                        setMapLocations(doc, start, end);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        };

        var completeInstallation = function (projectScheduleID, completed) {
            $('#loading-image').show();
            $.ajax({
                url: 'completeInstallation.php',
                dataType: "json",
                contentType: 'application/json',
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectScheduleID: projectScheduleID,
                    completed: completed
                },
                success: function (response) {
                    $('#loading-image').hide();

                    //Update Schedule
                    $('#scheduleEvaluationButton').empty();
                    $('#evaluationSchedule').empty();
                    $('#scheduleInstallationButton').empty();
                    $('#installationSchedule').empty();
                    $('#generalEvaluationSchedule').empty();
                    $('#generalInstallationSchedule').empty();
                    $('input[name="projectScheduleID"]').val('');
                    projectSchedule();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }
            });
        };

        //Display Project Schedule
        var projectSchedule = function () {
            $.ajax({
                url: 'getProjectEvents.php',
                dataType: "json",
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: $('#projectID').attr('value')
                },
                success: function (response) {
                    //Response is NOT Null
                    if (!response == '') {

                        var isEvaluationDate = false;
                        var isInstallationDate = false;

                        $.each(response, function (i, item) {

                            if (item.scheduleType == 'Evaluation') {

                                evalNewApptDisplay = '';
                                evalRescheduleDisplay = '';
                                evalCancelDisplay = '';
                                if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                    evalNewApptDisplay = '<button class="button scheduleEvaluation" style="float:right;margin-left:1rem;">New Appointment</button>';
                                    evalRescheduleDisplay = '<button class="button rescheduleEvaluation" style="float:right;margin-left:1rem;" href="' + item.projectScheduleID + '">Reschedule</button>';
                                    evalCancelDisplay = '<button class="button secondary cancelEventButton" style="float:right;" href="' + item.projectScheduleID + '">Cancel</button>';
                                }

                                if (item.scheduleType == 'Evaluation' && item.cancelledByUserID != null) {
                                    $('#evaluationSchedule').append('<div class="medium-12 columns no-pad"><div class="callout primary"><p class="no-margin">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</p><p class="no-margin" style="line-height:1;"><span style="font-size:.7rem;">Scheduled by: ' + item.scheduledByFirstName + ' ' + item.scheduledByLastName + ' on ' + item.scheduledOn + '</span><br/><span style="font-size:.7rem;">Cancelled by: ' + item.cancelledFirstName + ' ' + item.cancelledLastName + ' on ' + item.cancelledDate + '</span></p></div></div>');
                                    //$('#generalEvaluationSchedule').append('Evaluation: <a href="#schedule">Schedule Evaluation Date</a>');
                                    //$('#scheduleEvaluationButton').append('<button id="scheduleEvaluation" style="float:right;margin-bottom:.5rem;">Schedule</button>');
                                    isEvaluationDate = false;
                                }

                                else if (item.scheduleType == 'Evaluation' && item.cancelledByUserID == null) {
                                    $('#evaluationSchedule').append('<div class="medium-12 columns no-pad"><div class="callout primary"><p class="no-margin">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</p><p class="no-margin" style="line-height:1;"><span style="font-size:.7rem;">Scheduled by: ' + item.scheduledByFirstName + ' ' + item.scheduledByLastName + ' on ' + item.scheduledOn + '</span></p><p style="height: 2.3rem;">' + evalNewApptDisplay + '' + evalRescheduleDisplay + '' + evalCancelDisplay + '</p></div></div>');
                                    $('#generalEvaluationSchedule').append('Evaluation: <a id="getSchedule">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</a><br/>');
                                    isEvaluationDate = true;
                                    $('#scheduleEvaluationButton').html('');
                                }
                            }

                            if (item.scheduleType == 'Installation') {

                                installNewApptDisplay = '';
                                installRescheduleDisplay = '';
                                installCancelDisplay = '';
                                installCompleteDisplay = '';
                                if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $installation;  ?>' == 1) {
                                    installNewApptDisplay = '<button class="button scheduleInstallation" style="float:right;margin-left:1rem;">Follow Up</button>';
                                    installRescheduleDisplay = '<button class="button rescheduleInstallation" style="float:right;margin-left:1rem;" href="' + item.projectScheduleID + '">Change Installation</button>';
                                    installCancelDisplay = '<button class="button secondary cancelEventButton" style="float:right;" href="' + item.projectScheduleID + '">Cancel</button>';
                                    installCompleteDisplay = '<button class="button installationComplete" style="float:right;margin-left:1rem;" href="' + item.projectScheduleID + '">Installation Complete</button>';
                                }

                                if (item.scheduleType == 'Installation' && item.cancelledByUserID != null) {
                                    $('#installationSchedule').append('<div class="medium-12 columns no-pad"><div class="callout primary"><p class="no-margin">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</p><p class="no-margin" style="line-height:1;"><span style="font-size:.7rem;">Scheduled by: ' + item.scheduledByFirstName + ' ' + item.scheduledByLastName + ' on ' + item.scheduledOn + '</span><br/><span style="font-size:.7rem;">Cancelled by: ' + item.cancelledFirstName + ' ' + item.cancelledLastName + ' on ' + item.cancelledDate + '</span></p></div></div>');
                                    isInstallationDate = false;
                                }

                                else if (item.scheduleType == 'Installation' && item.cancelledByUserID == null) {
                                    if (item.installationComplete == null){
                                        $('#installationSchedule').append('<div class="medium-12 columns no-pad"><div class="callout primary"><p class="no-margin">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</p><p class="no-margin" style="line-height:1;"><span style="font-size:.7rem;">Scheduled by: ' + item.scheduledByFirstName + ' ' + item.scheduledByLastName + ' on ' + item.scheduledOn + '</span></p><p style="height: 2.3rem;">' + installNewApptDisplay + '' + installRescheduleDisplay + '' + installCompleteDisplay + '' + installCancelDisplay + '</p></div></div>');
                                    }
                                    else{
                                        installCompleteDisplay = '<button class="button undoInstallationComplete" style="float:right;margin-left:1rem;" href="' + item.projectScheduleID + '">Undo Installation Complete</button>';
                                        $('#installationSchedule').append('<div class="medium-12 columns no-pad"><div class="callout primary"><p class="no-margin">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</p><p class="no-margin" style="line-height:1;"><span style="font-size:.7rem;">Scheduled by: ' + item.scheduledByFirstName + ' ' + item.scheduledByLastName + ' on ' + item.scheduledOn + '</span></p><p class="no-margin" style="line-height:1;"><span style="font-size:.7rem;">Completed by: ' + item.completedFirstName + ' ' + item.completedLastName + ' on ' + item.installationCompleteRecordedDT + '</span></p><p style="height: 2.3rem;">' + installNewApptDisplay + '' + installCompleteDisplay + '</p></div></div>');
                                    }

                                    $('#generalInstallationSchedule').append('Installation: <a id="installGetSchedule">' + item.scheduledStart + ' with ' + item.scheduledFirstName + ' ' + item.scheduledLastName + '</a><br/>');
                                    isInstallationDate = true;
                                    $('#scheduleInstallationButton').html('');
                                }
                            }
                        });

                        if (isEvaluationDate == false) {
                            $('#generalEvaluationSchedule').append('Evaluation: <a href="#getSchedule">Schedule Evaluation Date</a>');
                            if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                $('#scheduleEvaluationButton').append('<button class="button scheduleEvaluation" style="float:right;margin-bottom:.5rem;">Schedule</button>');
                            }
                        }



                        if (isInstallationDate == false) {
                                        // console.log(" isInstallationdate is false 2408: " + $('#bidAccepted').text() );
                            if ($('#bidAccepted').text() == 1) {
                                if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $installation;  ?>' == 1) {
                                    $('#scheduleInstallationButton').append('<button class="button scheduleInstallation" style="float:right;margin-top:.5rem;">Schedule</button>');

                                    $('#generalInstallationSchedule').append('Installation: <a id="installGetSchedule">Schedule Installation Date</a><br>');
                                    

                                    // $('#generalInstallationSchedule').append('Installation: <a id="getSchedule"> ' + '</a><br/>');

                                    //bug fix FXLRATR-366
                                    // $('#generalInstallationSchedule').append('Installation: <a id="getSchedule">Schedule Installation Date' + '</a></br>');

                                }
                            } else {
                                $('#generalInstallationSchedule').append('Installation: <span style="font-size:.7rem;font-style:italic;color:#999999;">Pending Bid Acceptance</span>');
                                $('#installationSchedule').html('<div class="medium-12 columns" style="padding-left:0;padding-right:0;"><span style="font-size:.7rem;font-style:italic;color:#999999;">Pending Bid Acceptance</span></div>');
                            }
                        }

                        //Response is Null
                    } else {
                        // $('#generalEvaluationSchedule').append('Evaluation: <a href="#getSchedule">Schedule Evaluation Date</a>');

                        $('#generalEvaluationSchedule').append('Schedule Evaluation: <a id="getSchedule">  Schedule Evaluation' + '</a><br/>');


                        if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                            $('#scheduleEvaluationButton').append('<button class="button scheduleEvaluation" style="float:right;margin-bottom:.5rem;">Schedule</button>');
                        }

                        if ($('#bidAccepted').text() == 1) {
                            if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1) {
                                $('#scheduleInstallationButton').append('<button class="button scheduleInstallation" style="float:right;margin-top:.5rem;">Schedule</button>');

                                $('#generalInstallationSchedule').append('Installation: <a id="installGetSchedule">Schedule Installation Date</a><br>');

                            }
                        } else {
                            $('#installationSchedule').append('<div class="medium-12 columns no-pad"><span style="font-size:.7rem;font-style:italic;color:#999999;">Pending Bid Acceptance</span></div>');

                            $('#generalInstallationSchedule').append('Installation: <span style="font-size:.7rem;font-style:italic;color:#999999;">Pending Bid Acceptance</span>');
                        }

                    }

                    //Go to Schedule Tab
                    $("#getSchedule").click(function () {
                        $('[data-tabs]').eq(0).foundation('selectTab', $('#schedule'));
                        $('#scheduleMap').show();

                        if ($('#scheduleMap #calendarMap').length <= 0) {
                            $('#scheduleMap').append('<div id="calendarMap"></div>');
                               initializeMap();
                           }

                    });

                    //go to schedule tab from installation
                    $('#installGetSchedule').click(function(){

                        $('#loading-image').show();

                        $('[data-tabs]').eq(0).foundation('selectTab', $('#schedule'));
                        $('#scheduleMap').show();
                        
                        if ($('#scheduleMap #calendarMap').length <= 0) {
                            $('#scheduleMap').append('<div id="calendarMap"></div>');
                               initializeMap();
                           }
                        $('#loading-image').hide();

                    });

                    //Select Evaluation from Filter and Load Calendar
                    $('.scheduleEvaluation').click(function () {
                        $('#weeklyView, #dailyView').removeClass('active');
                        $('#monthlyView').addClass('active'); 
                        $('#scheduleList, #scheduleMap').hide();
                        $('#scheduleCalendar').show();
                        $('#cancelSchedule').append('<button id="cancelScheduleButton" class="button" style="float: right;">Back to Schedule</button>');
                        $('select#filterResources option[value="sales"]').prop('selected', true);
                        $('#eventType').val('Evaluation');

                        //Cancel Adding New Appointment/Installation
                        $('#cancelScheduleButton').click(function () {
                            $('input[name="projectScheduleID"]').val('');
                            $('#scheduleList, #scheduleMap').show();
                            $('#scheduleCalendar').hide();
                            $('#cancelScheduleButton').remove();
                            $('#calendar').empty();
                            if ($('#scheduleMap #calendarMap').length <= 0) {
                                $('#scheduleMap').append('<div id="calendarMap"></div>');
                                initializeMap();
                            }
                        });

                    });
                    $('.scheduleEvaluation').click(function () {
                        filterCalendar('month');
                    });


                    //Select Installation from Filter and Load Calendar
                    $('.scheduleInstallation').click(function () {
                        $('#weeklyView, #dailyView').removeClass('active');
                        $('#monthlyView').addClass('active'); 
                        $('#scheduleList, #scheduleMap').hide();
                        $('#scheduleCalendar').show();
                        $('#cancelSchedule').append('<button id="cancelScheduleButton" class="button" style="float: right;">Back to Schedule</button>');
                        $('select#filterResources option[value="installation"]').prop('selected', true);
                        $('#eventType').val('Installation');

                        //Cancel Adding New Appointment/Installation
                        $('#cancelScheduleButton').click(function () {
                            $('input[name="projectScheduleID"]').val('');

                            $('#cancelScheduleButton').remove();
                            $('#calendar').empty();
                            if ($('#scheduleMap #calendarMap').length <= 0) {
                                $('#scheduleMap').append('<div id="calendarMap"></div>');

                            }
                            initializeMap();
                        });
                    });
                    $('.scheduleInstallation').click(function () {
                        filterCalendar('month');
                    });

                    $('.cancelEventButton').click(function () {
                        var idToCancel = $(this).attr('href');

                        //Open Cancel Event Modal
                        $('#cancelEvent').foundation('open');

                        //Cancel Confirm Yes
                        $('#cancelConfirmYes').click(function () {

                            $.ajax({
                                url: 'event-cancel.php',
                                dataType: "json",
                                contentType: 'application/json',
                                type: "POST",
                                contentType: "application/x-www-form-urlencoded",
                                data: {
                                    projectScheduleID: idToCancel,
                                    projectID: $('#projectID').attr('value')
                                },
                                success: function (response) {
                                    if (response == 'true') {
                                        //Remove Calendar and Display Map
                                        $('#scheduleEvaluationButton').empty();
                                        $('#evaluationSchedule').empty();
                                        $('#scheduleInstallationButton').empty();
                                        $('#installationSchedule').empty();
                                        $('#generalEvaluationSchedule').empty();
                                        $('#generalInstallationSchedule').empty();

                                        $('#scheduleList, #scheduleMap').show();
                                        $('#scheduleCalendar').hide();
                                        $('#cancelScheduleButton').remove();
                                        $('#calendar').empty();
                                        if ($('#scheduleMap #calendarMap').length <= 0) {
                                            $('#scheduleMap').append('<div id="calendarMap"></div>');

                                        }
                                        initializeMap();

                                        //Get New Project Schedule
                                        projectSchedule();

                                        $('#cancelEvent').foundation('close');
                                    }
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    console.log(textStatus, errorThrown);
                                    console.log(jqXHR.responseText);
                                }
                            });

                        });

                        //Cancel Confirm No
                        $('#cancelConfirmNo').click(function () {
                            $('#cancelEvent').foundation('close');
                        });

                    });


                    //Reschedule Evaluation
                    $('.rescheduleEvaluation').click(function () {
                        $('#weeklyView, #dailyView').removeClass('active');
                        $('#monthlyView').addClass('active'); 
                        var idToEdit = $(this).attr('href');
                        $('input[name="projectScheduleID"]').val(idToEdit);

                        $('#scheduleList, #scheduleMap').hide();
                        $('#scheduleCalendar').show();
                        $('#cancelSchedule').append('<button id="cancelScheduleButton" class="button" style="float: right;">Back to Schedule</button>');
                        $('select#filterResources option[value="sales"]').prop('selected', true);
                        $('#eventType').val('Evaluation');

                        //Cancel Adding New Appointment/Installation
                        $('#cancelScheduleButton').click(function () {
                            $('input[name="projectScheduleID"]').val('');

                            $('#scheduleList, #scheduleMap').show();
                            $('#scheduleCalendar').hide();
                            $('#cancelScheduleButton').remove();
                            $('#calendar').empty();
                            if ($('#scheduleMap #calendarMap').length <= 0) {
                                $('#scheduleMap').append('<div id="calendarMap"></div>');
                            }
                            initializeMap();
                        });

                    });
                    $('.rescheduleEvaluation').click(function () {
                        filterCalendar('month');
                    });

                    //Reschedule Installation
                    $('.rescheduleInstallation').click(function () {
                        $('#weeklyView, #dailyView').removeClass('active');
                         $('#montly').removeClass('active');

                        var idToEdit = $(this).attr('href');
                        $('input[name="projectScheduleID"]').val(idToEdit);

                        $('#scheduleList, #scheduleMap').hide();
                        $('#scheduleCalendar').show();
                        $('#cancelSchedule').append('<button id="cancelScheduleButton" class="button" style="float: right;">Back to Schedule</button>');
                        $('select#filterResources option[value="installation"]').prop('selected', true);
                        $('#eventType').val('Installation');

                        //Cancel Adding New Appointment/Installation
                        $('#cancelScheduleButton').click(function () {
                            $('input[name="projectScheduleID"]').val('');

                            $('#scheduleList, #scheduleMap').css('display', '');
                            $('#scheduleCalendar').css('display', 'none');
                            $('#cancelScheduleButton').remove();
                            $('#calendar').empty();
                            if ($('#scheduleMap #calendarMap').length <= 0) {
                                $('#scheduleMap').append('<div id="calendarMap"></div>');
                            }
                            initializeMap();
                        });
                    });
                    $('.rescheduleInstallation').click(function () {
                        filterCalendar('month');
                    });

                    //Complete Installation
                    $('.installationComplete').click(function () {
                        var idToEdit = $(this).attr('href');
                        completeInstallation(idToEdit, 1);
                    });

                    //Installation Not Complete
                    $('.undoInstallationComplete').click(function () {
                        var idToEdit = $(this).attr('href');
                        completeInstallation(idToEdit, 0);
                    });

                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }

            });
        };

        //Display Project Evaluations
        var projectEvaluations = function (onload) {
            //Remove Evaluation Names from Copy Modal Dropdown
            $('#currentEvaluationNames option').not(':first').remove();

            $.ajax({
                url: 'getProjectEvaluations.php',
                dataType: "json",
                contentType: 'application/json',
                type: "GET",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    projectID: $('#projectID').attr('value')
                },
                success: function (response) {
                    //console.log(response);

                    if (!response == '') {

                        $.each(response, function (i, item) {
                            //Add Evaluation Names to Copy Dropdown
                            $('#currentEvaluationNames').append('<option value="' + this.evaluationID + '">' + this.evaluationDescription + '</option>');

                            var evaluationCreatedDisplay = '';
                            var evaluationLastUpdatedDisplay = '';
                            var bidFirstSentDisplay = '';
                            var bidLastSentDisplay = '';
                            var bidLastViewedDisplay = '';
                            var evaluationCancelledDisplay = '';
                            var evaluationFinalizedDisplay = '';
                            var bidAcceptedDisplay = '';
                            var bidRejectedDisplay = '';
                            var editEvaluationDisplay = '';
                            var viewEvaluationDisplay = '';
                            var bidSummaryDisplay = '';
                            var evaluationCancelDisplay = '';
                            var copyEvaluationDisplay = '';
                            var status = '';
                            var resendBidEmailDisplay = '';
                            var evaluationReportDisplay = '';
                            var evaluationReportPhotos = '';
                            var viewBidDisplay = '';
                            var scopeChangeDisplay = '';
                            var finalizeCustomDisplay = '';
                            var sendFinalReportDisplay = '';
                            var finalReportDisplay = '';
                            var finalReportSentDisplay = '';
                            var contractDisplay = '';
                            var customEvaluationDisplay = '';


                              if (this.bidAccepted != null) {
                                    // bidAcceptedDisplay = 'Bid Accepted By Customer <span>' + this.bidAccepted + '</span><br/>';
                                    // status = 'Bid Accepted';
                                    // console.log(" bidaccepted 2694: " + this.bidAccepted);

                                    $('#bidAccepted').text('1');

                                    // if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                    //     scopeChangeDisplay = '<a id="scopeChange" class="button expanded">Add-On Items</a>';
                                    // }
                                    
                                } //FXLRTR-366

                            if (this.customEvaluation == null) {
                                customEvaluationDisplay = 'custom="false"';
                                contractDisplay = '<li><a target="_blank" href="download-contract.php?eid=' + this.evaluationID + '">Download Contract</a></li>';

                                if (this.evaluationCreated != null) {
                                    evaluationCreatedDisplay = '	Started <span>' + this.evaluationCreated + ' by ' + this.evalCreatedByFirstName + ' ' + this.evalCreatedByLastName + '</span><br/>';
                                    status = 'Evaluation In Progress';
                                }

                                if (this.bidFirstSent == null) {
                                    contractDisplay = '';
                                    if (this.evaluationCancelled == null) {
                                        if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                            editEvaluationDisplay = '<a class="button expanded" href="evaluation-wizard.php?eid=' + this.evaluationID + '">Edit Evaluation</a>';
                                        }

                                        if (this.evaluationFinalized != null) {
                                            if ('<?php echo $primary;  ?>' == 1 || '<?php echo $bidCreation;  ?>' == 1 || '<?php echo $bidVerification;  ?>' == 1) {
                                                bidSummaryDisplay = '<a class="button expanded" href="bid-summary.php?eid=' + this.evaluationID + '">Bid Summary</a>';
                                            }
                                        }
                                    }
                                } else {
                                    if (this.evaluationCancelled == null) {
                                        resendBidEmailDisplay = '<a id="resendBidEmailCustomer" name="resendBidEmailCustomer" class="button expanded">Resend Bid Email</a>';
                                        //resendBidEmailDisplay = '<a href="bid-accept-email.php?id=' + this.bidID + '&email=send&resend=yes" class="button expanded">Resend Bid Email</a>';
                                    }

                                    evaluationReportDisplay = '<li><a target="_blank" href="evaluation-report.php?eid=' + this.evaluationID + '&custom=no">Evaluation Report</a></li>';


                                    if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                        viewBidDisplay = '<li><a target="_blank" href="bid-accept-email.php?id=' + this.bidID + '&contractor=true">View Bid</a></li>';
                                    }

                                }

                                //viewEvaluationDisplay = '<a class="button expanded" href="evaluation-view.php?eid=' + this.evaluationID + '">View Evaluation</a>';

                                if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                    copyEvaluationDisplay = '<a id="copyEvaluationOpen" class="button expanded">Copy Evaluation</a>';

                                    if (this.bidAccepted != null) {

                                        finalReportDisplay = '<li><a target="_blank" href="final-email.php?projectID=<?php echo $projectID;  ?>&evaluationID='+this.evaluationID+'">Final Report</a></li>';

                                        if (this.finalReportSent == null) {
                                             sendFinalReportDisplay = '<a id="sendFinalReport" name="sendFinalReport" class="button expanded">Send Final Report</a>';

                                        } else {
                                            finalReportSentDisplay = 'Final Report Sent <span>' + this.finalReportSent + ' by ' + this.finalReportSentFirstName + ' ' + this.finalReportSentLastName + '</span><br/>';
                                        }
                                       
                                    }
                                  
                                }

                            } else {
                                customEvaluationDisplay = 'custom="true"';
                                contractDisplay = '<li><a target="_blank" href="download-contract.php?eid=' + this.evaluationID + '&custom=1">Download Contract</a></li>';
                                if (this.evaluationCreated != null) {
                                    evaluationCreatedDisplay = 'Uploaded <span>' + this.evaluationCreated + ' by ' + this.evalCreatedByFirstName + ' ' + this.evalCreatedByLastName + '</span><br/>';
                                    status = 'Evaluation In Progress';
                                }

                                if (this.bidFirstSent == null) {
                                    contractDisplay = '';
                                    if (this.evaluationCancelled == null) {
                                        if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                            //editEvaluationDisplay = '<a class="button expanded" href="">Edit Evaluation</a>';

                                            finalizeCustomDisplay = '<a class="button expanded" id="finalizeCustom">Finalize Bid</a>';
                                        }

                                        // if (this.evaluationFinalized != null) {
                                        //     if ('<?php echo $primary;  ?>' == 1 || '<?php echo $bidCreation;  ?>' == 1 || '<?php echo $bidVerification;  ?>' == 1) {
                                        //         bidSummaryDisplay = '<a class="button expanded" href="custom-bid-summary.php?eid=' + this.evaluationID + '">Bid Summary</a>';
                                        //     }
                                        // }
                                    }

                                } else {
                                    if (this.evaluationCancelled == null) {
                                        resendBidEmailDisplay = '<a id="resendBidEmailCustomer" name="resendBidEmailCustomer" class="button expanded">Resend Bid Email</a>';
                                        //resendBidEmailDisplay = '<a href="bid-accept-email.php?id=' + this.bidID + '&email=send&resend=yes" class="button expanded">Resend Bid Email</a>';
                                    }
                                               
                                    viewBidDisplay = '<li><a target="_blank" href="image.php?type=evaldoc&cid=<?php echo $companyID;  ?>&pid=<?php echo $projectID;  ?>&eid=' + this.evaluationID + '&name=' + this.customEvaluation + '">View Bid</a></li>';
                                    
                                }

                                viewEvaluationDisplay = '<a class="button expanded" target="_blank" href="image.php?type=evaldoc&cid=<?php echo $companyID;  ?>&pid=<?php echo $projectID;  ?>&eid=' + this.evaluationID + '&name=' + this.customEvaluation + '">View Evaluation</a>';

                                if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                    copyEvaluationDisplay = '<a id="copyCustomEvaluationOpen" class="button expanded">Copy Evaluation</a>';

                                    if (this.bidAccepted != null) {

                                        finalReportDisplay = '<li><a target="_blank" href="final-email.php?projectID=<?php echo $projectID;  ?>&evaluationID='+this.evaluationID+'&custom=true">Final Report</a></li>';

                                        if (this.finalReportSent == null) {
                                             sendFinalReportDisplay = '<a id="sendFinalReport" name="sendFinalReport" class="button expanded">Send Final Report</a>';

                                        } else {
                                            finalReportSentDisplay = 'Final Report Sent <span>' + this.finalReportSent + ' by ' + this.finalReportSentFirstName + ' ' + this.finalReportSentLastName + '</span><br/>';
                                        }
                                       
                                    }
                                }

                            }

                            if (this.evaluationFinalized != null) {
                                evaluationFinalizedDisplay = 'Evaluation Finalized <span>' + this.evaluationFinalized + ' by ' + this.evaluationFinalizedFirstName + ' ' + this.evaluationFinalizedLastName + '</span><br/>';
                                status = 'Evaluation Finalized';
                            }

                            if (this.bidFirstSent != null) {
                                bidFirstSentDisplay = 'Bid Sent <span>' + this.bidFirstSent + ' by ' + this.bidFirstSentFirstName + ' ' + this.bidFirstSentLastName + '</span><br/>';
                                status = 'Bid Sent to Customer';
                            }

                            if (this.evaluationLastUpdated != null) {
                                evaluationLastUpdatedDisplay = '	Last Edited <span>' + this.evaluationLastUpdated + ' by ' + this.evalLastUpdatedFirstName + ' ' + this.evalLastUpdatedLastName + '</span><br/>';
                            }

                            if (this.bidLastSent != null) {
                                bidLastSentDisplay = 'Bid Reminder Sent <span>' + this.bidLastSent + '</span><br/>';
                            }

                            if (this.bidLastViewed != null) {
                                bidLastViewedDisplay = 'Bid Last Viewed By Customer <span>' + this.bidLastViewed + '</span><br/>';
                            }

                            if (this.evaluationCancelled != null) {
                                evaluationCancelledDisplay = 'Bid Cancelled <span>' + this.evaluationCancelled + ' by ' + this.evalCancelledFirstName + ' ' + this.evalCancelledLastName + '</span><br/>';
                                contractDisplay = '';
                                status = 'Bid Cancelled';
                            } else {

                                if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                    evaluationCancelDisplay = '<a id="cancelEvaluationOpen" class="button expanded">Cancel Bid</a>';
                                }

                                if (this.bidAccepted != null) {
                                    bidAcceptedDisplay = 'Bid Accepted By Customer <span>' + this.bidAccepted + '</span><br/>';
                                    status = 'Bid Accepted';
                                    $('#bidAccepted').text('1');

                                    if ('<?php echo $primary;  ?>' == 1 || '<?php echo $projectManagement;  ?>' == 1 || '<?php echo $sales;  ?>' == 1) {
                                        scopeChangeDisplay = '<a id="scopeChange" class="button expanded">Scope of Work Change</a>';

                                    }
                                    
                                } 

                                else if (this.bidRejected != null) {
                                    bidRejectedDisplay = 'Bid Rejected By Customer <span>' + this.bidRejected + '</span><br/>';
                                    status = 'Bid Rejected';
                                }

                                else {
                                    if (this.bidFirstSent != null) {
                                        bidAcceptedDisplay = '<a target="_blank" href="view-bid.php?id=' + this.bidID + '">Accept Bid</a><br/>';
                                    }
                                }
                            }


                            $('#evaluationList').append('<div class="callout primary" id="' + this.evaluationID + '" bidID="' + this.bidID + '" '+customEvaluationDisplay+'><div class="row expanded"><div class="medium-6 columns" style="margin-bottom:.5rem;"><h5 style="margin:0;"><span>' + this.evaluationDescription + ' Evaluation</span> <span style="font-size: .9rem;font-style: italic;"><a id="editEvaluationName">Edit</a></span></h5></div><div class="medium-6 columns text-right" style="margin-bottom:.5rem;"><p><span>' + status + '</span></p></div></div><div class="row expanded"><div class="medium-5 columns" style="border-right:1px dotted #cbcacf;"><p>' + evaluationCreatedDisplay + ' ' + evaluationLastUpdatedDisplay + ' ' + evaluationFinalizedDisplay + ' ' + bidFirstSentDisplay + ' ' + bidLastSentDisplay + ' ' + bidLastViewedDisplay + ' ' + evaluationCancelledDisplay + ' ' + bidAcceptedDisplay + ' ' + bidRejectedDisplay + ''+finalReportSentDisplay+'</p></div><div class="medium-5 columns" style="border-right:1px dotted #cbcacf"><p evaldocs class="no-margin">Documents</p><ul class="evalList">' + evaluationReportDisplay + ' ' + viewBidDisplay + '' + finalReportDisplay + '' + contractDisplay + '</ul></div><div class="medium-2 columns text-center">' + editEvaluationDisplay + ' ' + viewEvaluationDisplay + ' ' + bidSummaryDisplay + ' ' + copyEvaluationDisplay + ' ' + resendBidEmailDisplay + ' ' + scopeChangeDisplay + ' ' + finalizeCustomDisplay + ' ' + evaluationCancelDisplay + ''+sendFinalReportDisplay+'</div></div></div>');

                            var eid = this.evaluationID;
                            $.ajax({
                                url: 'getAllPhotos.php',
                                dataType: "json",
                                contentType: 'application/json',
                                type: "POST",
                                contentType: "application/x-www-form-urlencoded",
                                data: {
                                    evaluationID: eid
                                },
                                success: function (response) {
                                    if (!response){
                                        }
                                    else{
                                        evaluationReportPhotos = '<li><a target="_blank" href="evaluation-report-photos.php?eid=' + eid + '">Evaluation Photos</a></li>';
                                        $('#evaluationList [id="'+ eid +'"] .evalList').append(evaluationReportPhotos);
                                        }
                                    }
                                });
                            $.ajax({
                                url: 'getDrawing.php',
                                dataType: "json",
                                contentType: 'application/json',
                                type: "POST",
                                contentType: "application/x-www-form-urlencoded",
                                data: {
                                    evaluationID: eid
                                },
                                success: function (response) {
                                    if (!response){
                                        }
                                    else{
                                        evaluationDrawing = '<li><a target="_blank" href="image.php?type=evaldrawing&cid=<?php echo $companyID;  ?>&pid=<?php echo $projectID;  ?>&name='+ response.evaluationDrawing +'&eid=' + eid + '">Evaluation Drawing</a></li>';
                                        $('#evaluationList [id="'+ eid +'"] .evalList').append(evaluationDrawing);
                                        }
                                    }
                                });
                            
                            // //With Documents
                            // $('#evaluationList').append('<div class="callout primary" id="' + this.evaluationID + '"><div class="row expanded"><div class="medium-6 columns" style="margin-bottom:.5rem;"><h5 style="margin:0;">' + this.evaluationDescription + ' Evaluation</h5></div><div class="medium-6 columns text-right" style="margin-bottom:.5rem;"><p><span>' + status + '</span></p></div></div><div class="row expanded"><div class="medium-5 columns" style="border-right:1px dotted #cbcacf;"><p>' + evaluationCreatedDisplay + ' ' + evaluationLastUpdatedDisplay + ' ' + evaluationFinalizedDisplay + ' ' + bidFirstSentDisplay + ' ' + bidLastSentDisplay + ' ' + bidLastViewedDisplay + ' ' + evaluationCancelledDisplay + ' ' + bidAcceptedDisplay + ' ' + bidRejectedDisplay + '</p></div><div class="medium-5 columns" style="border-right:1px dotted #cbcacf"><p class="no-margin">Documents</p><ul><li><a href="#button">Document 1</a></li><li><a href="#button">Bid</a></li><li><a href="#button">Contract</a> <span>Executed 3/21/16</span><br/></li><li><a href="#button">Invoice</a></li></ul></div><div class="medium-2 columns text-center">' + editEvaluationDisplay + ' ' + viewEvaluationDisplay + ' ' + bidSummaryDisplay + ' ' + copyEvaluationDisplay + ' ' + evaluationCancelDisplay + '</div></div></div>');

                            $('#' + this.evaluationID + ' #cancelEvaluationOpen').click(openCancelModal);

                            $('#' + this.evaluationID + ' #copyEvaluationOpen').click(openCopyModal);

                            $('#' + this.evaluationID + ' #copyCustomEvaluationOpen').click(openCustomCopyModal);

                            $('#' + this.evaluationID + ' #resendBidEmailCustomer').click(resendBidEmailCustomer);

                            $('#' + this.evaluationID + ' #scopeChange').click(scopeChange);

                            $('#' + this.evaluationID + ' #finalizeCustom').click(finalizeCustomEvaluation);

                            $('#' + this.evaluationID + ' #sendFinalReport').click(sendFinalReport);

                            $('#' + this.evaluationID + ' #editEvaluationName').click(editEvaluationName);

                            //Disable Resend Button
                            if ('<?php echo $noEmailRequired; ?>' == 1 || '<?php echo $unsubscribed; ?>' == 1){
                                $('[name="resendBidEmailCustomer"]').addClass('disabled');
                                $('[name="sendFinalReport"]').addClass('disabled');
                            }

                        });
                            

                    } else {
                        //Remove Copy Existing Evaluation from Modal If No Evaluations Exist
                        $('#newEvaluationModal div:first').remove();
                    }

                        if (onload=='true'){
                            projectSchedule();
                            onload='false';
                        }
                }, error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                    console.log(jqXHR.responseText);
                }


            });
    };


    //Display Project History
    var projectHistory = function () {
        //Remove Current History Display 
        $('#projectHistory').empty();

        $.ajax({
            url: 'getProjectHistory.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            data: {
                projectID: $('#projectID').attr('value')
            },
            success: function (response) {
                //console.log(response);

                if (!response == '') {
                    $.each(response, function (i, item) {

                        if (this.historyType == 'project') {
                            $('#projectHistory').append('<div class="callout primary history"><p>' + this.projectType + '<br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p></div>');
                        } else if (this.historyType == 'evaluation') {
                            if (this.evalType == 'Bid First Sent') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.id + '"><p>' + this.description + ' - ' + this.evalType + '<br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p><p style="height: 2.3rem;"><button id="resendBidEmail" name="resendBidEmail" class="button" style="float:right;" href="111">Resend Email</button></p></div>');
                                    $('.history#' + this.id + ' #resendBidEmail').click(resendBidEmail);

                            } else if (this.evalType == 'Bid Accepted') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.bidID + '"><p>' + this.description + ' - ' + this.evalType + '<br /><span style="font-size:.7rem;">' + this.date + ' by Customer</span></p><p style="height: 2.3rem;"><button id="resendBidAcceptedEmail" name="resendBidAcceptedEmail" class="button" style="float:right;" href="111">Resend Email</button></p></div>');
                                    $('.history#' + this.bidID + ' #resendBidAcceptedEmail').click(resendBidAcceptedEmail);

                            } else if (this.evalType == 'Bid Rejected') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.bidID + '"><p>' + this.description + ' - ' + this.evalType + '<br /><span style="font-size:.7rem;">' + this.date + ' by Customer</span></p><p style="height: 2.3rem;"><button id="resendBidRejectedEmail" name="resendBidRejectedEmail" class="button" style="float:right;" href="111">Resend Email</button></p></div>');
                                   $('.history#' + this.bidID + ' #resendBidRejectedEmail').click(resendBidRejectedEmail);

                            } else if (this.evalType == 'Final Report Sent') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.id + '"><p>' + this.description + ' - ' + this.evalType + '<br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p><p style="height: 2.3rem;"><button id="resendFinalReportEmail" name="resendFinalReportEmail" class="button" style="float:right;" href="111">Resend Email</button></p></div>');
                                   $('.history#' + this.id + ' #resendFinalReportEmail').click(resendFinalReportEmail);

                            } else if (this.evalType == 'Invoice Last Sent') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.id + '"><p>' + this.description + ' - ' + this.invoiceName + ' Invoice<br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p><p style="height: 2.3rem;"><a target="_blank" class="button" style="float:right;" href="invoice.php?custom=' + this.custom + '&eid=' + this.id + '&invoice='+this.invoiceType+'&email=send">Resend Invoice</a></p></div>');

                            } else {
                                $('#projectHistory').append('<div class="callout primary history"><p>' + this.description + ' - ' + this.evalType + '<br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p></div>');
                            }
                           
                        } else if (this.historyType == 'schedule') {
                            if (this.type == 'Evaluation') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.id + '"><p>' + this.type + ' Scheduled<br /><span>Start: ' + this.startDate + '<br/>End: ' + this.endDate + '</span><br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p><p style="height: 2.3rem;"><button id="resendEvaluationEmail" name="resendEvaluationEmail"class="button" style="float:right;" href="111">Resend Email</button></p></div>');
                                    $('.history#' + this.id + ' #resendEvaluationEmail').click(resendEvaluationEmail);
                                   
                            } else if (this.type == 'Installation') {
                                $('#projectHistory').append('<div class="callout primary history" id="' + this.id + '"><p>' + this.type + ' Scheduled<br /><span>Start: ' + this.startDate + '<br/>End: ' + this.endDate + '</span><br /><span style="font-size:.7rem;">' + this.date + ' by ' + this.firstName + ' ' + this.lastName + '</span></p><p style="height: 2.3rem;"><button id="resendInstallationEmail" name="resendInstallationEmail"class="button" style="float:right;" href="111">Resend Email</button></p></div>');
                                   $('.history#' + this.id + ' #resendInstallationEmail').click(resendInstallationEmail);

                            }
                        }
                        

                    });   
                    //Disable Resend Buttons
                    if ('<?php echo $noEmailRequired; ?>' == 1 || '<?php echo $unsubscribed; ?>' == 1){
                        $('[name=resendBidEmail]').addClass('disabled');
                        $('[name=resendBidAcceptedEmail]').addClass('disabled');
                        $('[name=resendBidRejectedEmail]').addClass('disabled');
                        $('[name=resendFinalReportEmail]').addClass('disabled');
                        $('[name=resendEvaluationEmail]').addClass('disabled');
                        $('[name=resendInstallationEmail]').addClass('disabled');
                    }  
                }
            }, error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log(jqXHR.responseText);
            }

        });
    };


    //Display Project Notes
    var projectNotes = function () {
        // //Remove Current Notes Display 
        // $('#projectNotes.pinnedNotes').empty();
        // $('#projectNotes.nonPinnedNotes').empty();

        $.ajax({
            url: 'getProjectNotes.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            data: {
                projectID: $('#projectID').attr('value')
            },
            success: function (response) {
                //console.log(response);
                if (!response == '') {
                    $.each(response, function (i, item) {
                        var noteTag = '';

                        if (item.noteEdited != null){
                            noteAddedDisplay = '<span style="font-size:.7rem;">Edited by '+item.noteEditedFirstName+' '+item.noteEditedLastName+' on '+item.noteEdited+'</span>';
                        } else {
                             noteAddedDisplay = '<span style="font-size:.7rem;">Added by '+item.noteAddedFirstName+' '+item.noteAddedLastName+' on '+item.noteAdded+'</span>';
                        }

                        if (item.noteTag == 'PC') {
                            noteTag = '<span style="font-style:normal">Project Created - </span>';
                        } else if (item.noteTag == 'E') {
                            noteTag = '<span style="font-style:normal">'+item.evaluationDescription+' Evaluation - </span>';
                        }


                        if (item.isPinned == '1'){
                            $('#projectNotes.pinnedNotes').append('<div class="callout primary note" style="padding: .25rem .25rem .25rem .75rem;" id="'+item.noteID+'"><div class="row expanded"><div class="medium-9 columns"><p style="margin-top: .5rem;">'+item.note+'</p><p style="margin-bottom: 0;">'+noteTag+''+noteAddedDisplay+'</p></div><div class="medium-3 columns"><p style="margin-bottom:2rem;"><button class="pinNote on" style="float:right;"></button></p><p style="margin-bottom: 0;margin-right: .4rem;"><button class="button editNote" style="float:right;margin-bottom: 0rem;">Edit</button></p></div></div></div>');

                            $('#projectTabNotes').append('<div class="callout primary note" style="padding: .25rem .25rem .25rem .75rem;" id="'+item.noteID+'"><div class="row expanded"><div class="medium-12 columns"><p style="margin-top: .5rem;">'+item.note+'</p><p style="margin-bottom: 0;">'+noteTag+''+noteAddedDisplay+'</p></div></div></div></div>');

                            $('.note#'+item.noteID+' button.editNote').click(editNote);
                            $('.note#'+item.noteID+' button.pinNote').click(pinNote);
                        } else {
                            $('#projectNotes.nonPinnedNotes').append('<div class="callout primary note" style="padding: .25rem .25rem .25rem .75rem;" id="'+item.noteID+'"><div class="row expanded"><div class="medium-9 columns"><p style="margin-top: .5rem;">'+item.note+'</p><p style="margin-bottom: 0;">'+noteTag+''+noteAddedDisplay+'</p></div><div class="medium-3 columns"><p style="margin-bottom:2rem;"><button class="pinNote off" style="float:right;"></button></p><p style="margin-bottom: 0;margin-right: .4rem;"><button class="button editNote" style="float:right;margin-bottom: 0rem;">Edit</button></p></div></div></div>');
                            $('.note#'+item.noteID+' button.editNote').click(editNote);
                            $('.note#'+item.noteID+' button.pinNote').click(pinNote);

                        }
                    });  

                    if ($('#projectTabNotes .callout').length > 0){
                        $('#projectTabNotes').parent().show();
                        $('#projectNoteDivider').show();
                    } else {
                        $('#projectTabNotes').parent().hide();
                        $('#projectNoteDivider').hide();
                    }
                } else {
                    $('#projectTabNotes').parent().hide();
                    $('#projectNoteDivider').hide();
                }
            }, error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log(jqXHR.responseText);
            }

        });
    };

    var addPhoneRow = function () {

        //oldRow = $('#phoneTable').find('tbody > tr:last-child input.isPrimary').attr('value');
        //var newRow = parseFloat(oldRow) + 1;

        $cloneBlankRow = $('#phoneTable').find('tbody tr:first').clone().css('display', '');
        $('#phoneTable').find('tbody').append($cloneBlankRow);
        $('#phoneTable').find('tbody > tr:last-child input.isPrimary').change(isPrimaryCheck);
        $('#phoneTable').find('tbody > tr:last-child .delete > a').click(deletePhoneRow);

        $('#userPhoneTable').find('tbody > tr:last-child input.Phone').mask('(000) 000-0000');

        if ($('#phoneTable input.isPrimary:checked').length <= 0) {
            $('#phoneTable tbody tr:nth-child(2) td.primary input.isPrimary').prop('checked', true);
        }
    };

    var setLatLng = function(mapset){
        if(map.location){   
            $('#latitude').text(map.location.lat);
            $('#longitude').text(map.location.lng);
        }
    };

    var addContacts = function () {
        var projectID = $('#projectID').val();
        $('#loading-image').show();
        $.ajax({
            url: 'getProjectEmails.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            data: {
                projectID: projectID
            },  
            success: function(response) {
                if (response != null){
                    $.each(response, function (i, item) {

                        $cloneRow = $('#addContactsModal #emailTable tbody tr:first').clone().css('display', '');

                        $cloneRow.addClass('dbRow');

                        $cloneRow.find('[name="contactEmail"]').val(item.email);

                        $cloneRow.find('[name="contactEmail"]').attr('sort', item.projectEmailID);

                        if (item.name != null){
                            $cloneRow.find('[name="name"]').val(item.name);
                        }

                        $('#addContactsModal #emailTable tbody').append($cloneRow);
                        $('#addContactsModal #emailTable tbody > tr:last-child a ').click(deleteEmailRow);
                
                        $('#addContactsModal').foundation('open');
                        $('#loading-image').hide();
                  });
                }
                else {
                    addEmailRow();
                    $('#addContactsModal').foundation('open');
                    $('#loading-image').hide();
                }
            }
        });
    };

    var addEmailRow = function () {
        $cloneBlankRow = $('#emailTable').find('tbody tr:first').clone().css('display', '');
        $('#emailTable').find('tbody').append($cloneBlankRow);
        $('#emailTable').find('tbody > tr:last-child a').click(deleteEmailRow);
    };

    var deleteEmailRow = function () {
        if ($(this).parent().parent().hasClass('dbRow')) {
            $(this).parent().parent().find('[name="contactEmail"]').attr('deleted','deleted');
            $(this).parent().parent().css('display','none');

            if ($('#emailTable tbody').children().length == 1){
                $('small.contactEmail').removeClass('is-visible');
                $('small.contactName').removeClass('is-visible');
            }
        } 
        else {
            $(this).parent().parent().remove();

            if ($('#emailTable tbody').children().length == 1){
                $('small.contactEmail').removeClass('is-visible');
                $('small.contactName').removeClass('is-visible');
            }
        }
    };

    var updateProjectContacts = function () {
        var projectID = $('#projectID').val();
        $('#loading-image').show();
        $.ajax({
            url: 'getProjectEmails.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            data: {
                projectID: projectID
            },  
            success: function(response) {
                if (response != null){
                    var additionalContacts = '';
                    var additionalContactsDisplay = '';
                    $.each(response, function (i, item) {
                        var email = item.email;
                        var name = item.name;

                        if (name != null){
                            additionalContacts += name + ': <a href="mailto: ' + email + '">' + email + '</a><br/>';
                        }
                        else {
                            additionalContacts += '<a href="mailto: ' + email + '">' + email + '</a><br/>';
                        }
                    });
                    additionalContactsDisplay = '<p id="additionalContacts"><strong>Project Contacts</strong><br>' + additionalContacts + '</p>';
                    $('#additionalContacts').remove();
                    $('#contactInfoProject').after(additionalContactsDisplay);
                }
                else {
                    additionalContactsDisplay = '<p id="additionalContacts" style="display:none;"><strong>Project Contacts</strong><br></p>';
                    $('#additionalContacts').remove();
                    $('#contactInfoProject').after(additionalContactsDisplay);
                }
                $('#loading-image').hide();
            }
        });
    };

    var closeProjectContacts = function () {
        $('#addContactsModal #emailTable tbody tr').not(':first').remove();

        $('small.contactEmail').removeClass('is-visible');
        $('small.contactName').removeClass('is-visible');
       
        $('#addContactsModal').foundation('close');
    };

    var saveProjectContacts = function () {

        $('#emailTable tbody tr:visible [name="contactEmail"]').each(function () {
            var email = $(this).val()
            if (email == '' || !isEmail(email)) {
                $(this).parent().addClass('is-invalid-label');
                $(this).addClass('is-invalid-input');
                $(this).parent().find('.form-error').addClass('is-visible');
                $('small.contactEmail').addClass('is-visible');
            } else {
                $(this).parent().removeClass('is-invalid-label');
                $(this).removeClass('is-invalid-input');
                $(this).parent().find('.form-error').removeClass('is-visible');
                $('small.contactEmail').removeClass('is-visible');
            }
        });

        $('#emailTable tbody tr:visible [name="name"]').each(function () {
            var name = $(this).val().trim()
            if (name == '') {
                $(this).parent().addClass('is-invalid-label');
                $(this).addClass('is-invalid-input');
                $(this).parent().find('.form-error').addClass('is-visible');
                $('small.contactName').addClass('is-visible');
            } else {
                $(this).parent().removeClass('is-invalid-label');
                $(this).removeClass('is-invalid-input');
                $(this).parent().find('.form-error').removeClass('is-visible');
                $('small.contactName').removeClass('is-visible');
            }
        });

        if (!$('small.contactEmail').hasClass('is-visible') && !$('small.contactName').hasClass('is-visible')) {

            storeEmailTableData();

            function storeEmailTableData() {
                var emailTableData = new Array();
                $('#emailTable tbody tr').each(function(row,tr){
                    var name = $(tr).find('td:eq(0)').find('[name="name"]').val().trim();
                    var deleted = $(tr).find('td:eq(1)').find('[name="contactEmail"]').attr('deleted');
                    if (name == ''){
                        name = null;
                    }
                    if (deleted === undefined){
                        deleted = null;
                    }
                    emailTableData[row]={
                        "deleted": deleted,
                        "projectEmailID": $(tr).find('td:eq(1)').find('[name="contactEmail"]').attr('sort'),
                        "email": $(tr).find('td:eq(1)').find('[name="contactEmail"]').val(),
                        "name": name
                    };
                });
                emailTableData.shift();
                var emailTableArray = emailTableData;

                if (emailTableArray.length > 0){
                    $('loading-image').show();
                    $.ajax({
                        url: 'editProjectEmails.php',
                        dataType: "json",
                        contentType: 'application/json',
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            projectID: $('#projectID').attr('value'),
                            emailArray: emailTableArray,
                        },
                        success: function(response) {
                            $('#addContactsModal #emailTable tbody tr').not(':first').remove();

                            $('small.contactEmail').removeClass('is-visible');
                            $('small.contactName').removeClass('is-visible');
                           
                            $('#addContactsModal').foundation('close');

                            $('#addContactsSuccessModal').foundation('open');

                            updateProjectContacts();

                            $('loading-image').hide();
                    
                        }, error: function(jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                            console.log(jqXHR.responseText);
                        }
                            
                    }); 
                }
                else {
                    $('#addContactsModal #emailTable tbody tr').not(':first').remove();

                    $('small.contactEmail').removeClass('is-visible');
                    $('small.contactName').removeClass('is-visible');
                   
                    $('#addContactsModal').foundation('close');

                    $('#addContactsSuccessModal').foundation('open');

                    updateProjectContacts();

                    $('loading-image').hide();
                } 
            }
        }
    };

    var isEmail = function(email) {
        return email.indexOf('@') > 0 && email.indexOf('.') > 0;
    };

    var deletePhoneRow = function () {
        if ($(this).parent().parent().hasClass('dbRow')) {
            $(this).parent().parent().find('select').attr('delete','delete');
            $(this).parent().parent().css('display','none');

             if ($(this).parent().parent().find('input.isPrimary').is(':checked'))
                $('#phoneTable tbody tr:visible').eq(0).find('td.primary input.isPrimary').prop('checked', true);

            if ($('#phoneTable tbody').children().length == 1)
                addPhoneRow();
        } 
        else {
            $(this).parent().parent().remove();

            if ($(this).parent().parent().find('input.isPrimary').is(':checked'))
                $('#phoneTable tbody tr:visible').eq(0).find('td.primary input.isPrimary').prop('checked', true);

            //$("div a.action:visible").eq(0).addClass("first");

            if ($('#phoneTable tbody').children().length == 1)
               addPhoneRow();
        }
    };

    var isPrimaryCheck = function () {

        $('#phoneTable').find('input.isPrimary').prop('checked', false);
        $(this).prop('checked', true);

    };

    var updateCustomerInfo = function(){
        //Get Customer Info
        $.ajax({
            url: 'getProject.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            data: {
                    projectID: $('#projectID').attr('value')
            },
            success: function(response) {
                var NameDisplay = 'Name: '+decodeEntities(response.firstName) +' '+decodeEntities(response.lastName)+'<br/>';
                $('#projectName').html('<strong>Project</strong><br/>' + decodeEntities(response.projectDescription) + '<br/>');
                $('#projectSalesperson').show();
                $('#projectSalesperson').html('<strong>Salesperson</strong><br/>' + decodeEntities(response.salespersonFirstName) + ' ' + decodeEntities(response.salespersonLastName));
                $('[class="project-title"').text(decodeEntities(response.firstName) + ' ' + decodeEntities(response.lastName) + ' - ' + decodeEntities(response.projectDescription));
                updateCustomerContactInfo(response.customerID, response.email, response.unsubscribed, response.noEmailRequired);
                updateLatLong($('#latitude').text(), $('#longitude').text(), 'false');

                $('#unsubscribedStatus').text(response.unsubscribed);
                $('#noEmailRequiredStatus').text(response.noEmailRequired);

                if (response.noEmailRequired == 1 || response.unsubscribed == 1){
                    $('[name="resendBidEmailCustomer"]').addClass('disabled');
                    $('[name="sendFinalReport"]').addClass('disabled');
                    $('[name=resendBidEmail]').addClass('disabled');
                    $('[name=resendBidAcceptedEmail]').addClass('disabled');
                    $('[name=resendBidRejectedEmail]').addClass('disabled');
                    $('[name=resendFinalReportEmail]').addClass('disabled');
                    $('[name=resendEvaluationEmail]').addClass('disabled');
                    $('[name=resendInstallationEmail]').addClass('disabled');
                }
                else{
                    $('[name="resendBidEmailCustomer"]').removeClass('disabled');
                    $('[name="sendFinalReport"]').removeClass('disabled');
                    $('[name=resendBidEmail]').removeClass('disabled');
                    $('[name=resendBidAcceptedEmail]').removeClass('disabled');
                    $('[name=resendBidRejectedEmail]').removeClass('disabled');
                    $('[name=resendFinalReportEmail]').removeClass('disabled');
                    $('[name=resendEvaluationEmail]').removeClass('disabled');
                    $('[name=resendInstallationEmail]').removeClass('disabled');
                }
                 $('#contactInfoProject').html('<strong>Contact Information</strong><br />'+ NameDisplay );
                
            }, error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log(jqXHR.responseText);
            }
                
        });     
    };

    var updateCustomerContactInfo = function(customerID, email, unsubscribed, noEmailRequired){
        var phoneDisplay = '';
        var primary = '';
                $.ajax({
                    url: 'getCustomerPhone.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        customerID: customerID
                    },  
                    success: function(response) {
                        $.each(response, function (i, item) {
                            if (item.isPrimary == 1){
                                primary = '<span>primary</span>';
                            } else {
                                primary = '';
                            }

                            phoneDisplay += decodeEntities(item.phoneDescription) + ': ' + item.phoneNumber + ' ' + primary + '<br/>';
                        });
                        var unsubscribedText = '';
                        if (unsubscribed == 1) {
                            unsubscribedText = ' <span>unsubscribed</span>';
                        } else {
                            unsubscribedText = '';
                        }
                        if (noEmailRequired == 1) {
                            unsubscribedText = ' <span>no email</span>';
                        }
                        var emailDisplay = 'Email: <a href="' + email + '">' + email + '</a>' + unsubscribedText;
                        $('#contactInfoProject').append(phoneDisplay, emailDisplay );
                        $('#contactInfoCustomer').html('<strong>Contact Information</strong><br />' + phoneDisplay+ emailDisplay );

                    }, error: function(jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                        
               });  
    };

    var editCustomer = function() {
        //Get Customer Info
        $.ajax({
            url: 'getProject.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            data: {
                    projectID: $('#projectID').attr('value')
            },
            success: function(response) {
                var existingReferral = response.referralMarketingTypeID;
                if (existingReferral != null){
                    $('#referralDropdown').find('option[value="' + existingReferral + '"]').prop('selected', true);
                }

                $('#editCustomerModal input[name="firstName"]').val(decodeEntities(response.firstName));
                $('#editCustomerModal input[name="lastName"]').val(decodeEntities(response.lastName));
                $('#editCustomerModal input[name="address"]').val(decodeEntities(response.address));
                $('#editCustomerModal input[name="address2"]').val(decodeEntities(response.address2));
                $('#editCustomerModal input[name="city"]').val(decodeEntities(response.city));

                if ($('#editCustomerModal select[name="state"]').has('option[value="' + response.state + '"]').length > 0)
                    $('#editCustomerModal select[name="state"] > option[value="' + response.state + '"]').prop('selected', true);

                $('#editCustomerModal select[name="state"]').val(response.state);
                $('#editCustomerModal input[name="zip"]').val(response.zip);
                $('#editCustomerModal input[name="email"]').val(response.email);
                $('#editCustomerModal input[name="projectDescription"]').val(decodeEntities(response.projectDescription));

                if (response.unsubscribed == '1') {
                    $('#editCustomerModal input[name="unsubscribed"]').prop('checked', true);
                } else {
                    $('#editCustomerModal input[name="unsubscribed"]').prop('checked', false);
                }

                if (response.noEmailRequired == '1') {
                    $('#editCustomerModal input[name="noEmailRequired"]').prop('checked', true);
                    $('#editCustomerModal input[name="email"]').prop('disabled', true);
                    $('#editCustomerModal input[name="email"]').val('');
                } else {
                    $('#editCustomerModal input[name="noEmailRequired"]').prop('checked', false);
                    $('#editCustomerModal input[name="email"]').prop('disabled', false);
                }

                if ($('#editCustomerModal select[name="projectSalesperson"]').has('option[value="' + response.projectSalesperson + '"]').length > 0)
                    $('#editCustomerModal select[name="projectSalesperson"] > option[value="' + response.projectSalesperson + '"]').prop('selected', true);
        
                var customerID = response.customerID;

                //On Success Get Customer Phone 
                $.ajax({
                    url: 'getCustomerPhone.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "GET",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        customerID: customerID
                    },  
                    success: function(response) {
                        //console.log(response);
                        $.each(response, function (i, item) {

                            $cloneRow = $('#editCustomerModal .phoneTable tbody tr:first').clone().css('display', '');

                            $cloneRow.addClass('dbRow');

                            if ($cloneRow.find('select.Description').has('option[value="' + item.phoneDescription + '"]').length > 0)
                                $cloneRow.find('select.Description > option[value="' + item.phoneDescription + '"]').prop('selected', true);

                            $cloneRow.find('input.Phone').val(item.phoneNumber);
                          
                             if (item.isPrimary == '1') {
                                $cloneRow.find('input.isPrimary').prop('checked', true);
                            } else {
                                $cloneRow.find('input.isPrimary').prop('checked', false);
                            }
                                

                            $cloneRow.find('select.Description').attr('sort', item.customerPhoneID);
                            $cloneRow.find('input.Phone').attr('sort', item.customerPhoneID);
                            $cloneRow.find('input.isPrimary').attr('sort', item.customerPhoneID);


                            $('#editCustomerModal .phoneTable tbody').append($cloneRow);
                            $('#editCustomerModal .phoneTable tbody > tr:last-child input.isPrimary ').click(isPrimaryCheck);
                            $('#editCustomerModal .phoneTable tbody > tr:last-child a ').click(deletePhoneRow);
                    


                      });

                        //On Success Display Modal
                        $('#editCustomerModal').foundation('open');
                            
                    }, error: function(jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                        
               });     
                    
            }, error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log(jqXHR.responseText);
            }
                
        });     


    };

    var closeEditCustomer = function() {
        $('#editCustomerModal #phoneTable tbody tr').not(':first').remove();

        $('#editCustomerModal input[name="firstName"]').val('');
        $('#editCustomerModal input[name="lastName"]').val('');
        $('#editCustomerModal input[name="address"]').val('');
        $('#editCustomerModal input[name="address2"]').val('');
        $('#editCustomerModal input[name="city"]').val('');
        $('#editCustomerModal select[name="state"]').val('');
        $('#editCustomerModal input[name="zip"]').val('');
        $('#editCustomerModal input[name="email"]').val('');
        $('#editCustomerModal input[name="projectDescription"]').val('');
        $('#referralDropdown').find('option[value="0"]').prop('selected', true);

        $('small.fullPhone').removeClass('is-visible');
        $('small.onePhone').removeClass('is-visible');
        $('small.primary').removeClass('is-visible');
       
        $('#editCustomerModal').foundation('close');

    };

    var saveEditCustomer = function() {

        $('#editCustomerModal input.customerRequired, #editCustomerModal select.customerRequired').each(function () {

             if ($(this).val() == '') {
                $(this).parent().addClass('is-invalid-label');
                $(this).addClass('is-invalid-input');
                $(this).parent().find('.form-error').addClass('is-visible');
            } else {
                $(this).parent().removeClass('is-invalid-label');
                $(this).removeClass('is-invalid-input');
                $(this).parent().find('.form-error').removeClass('is-visible');
            }

        });

        
        if ($('#phoneTable tbody tr:visible').length > 0) {
            $('small.onePhone').removeClass('is-visible');

            $('#phoneTable tbody tr:visible').each(function(){
                if ($(this).find('td input.Phone').val() == '' || $(this).find('td select.Description').val() == '') {
                    $('small.fullPhone').addClass('is-visible');
                } else {
                    if ($(this).find('td input.Phone').val().length < 14) {
                         $('small.fullPhone').addClass('is-visible');
                    } else {
                        $('small.fullPhone').removeClass('is-visible');
                    }
                }
            }); 
        } else {
            $('small.onePhone').addClass('is-visible');
        }

        if ($('#phoneTable .isPrimary:checked').length < 1) {
            $('small.primary').addClass('is-visible');
            
        } else {
            if ($('#phoneTable .isPrimary:checked').is(':visible')) {
                $('small.primary').removeClass('is-visible');
            } else {
                $('small.primary').addClass('is-visible');
            }
        }


        if (!$('#editCustomerModal input[name="firstName"]').parent().hasClass('is-invalid-label') &&
            !$('#editCustomerModal input[name="lastName"]').parent().hasClass('is-invalid-label') && 
            !$('#editCustomerModal input[name="address"]').parent().hasClass('is-invalid-label') && 
            !$('#editCustomerModal input[name="address2"]').parent().hasClass('is-invalid-label') && 
            !$('#editCustomerModal input[name="city"]').parent().hasClass('is-invalid-label') &&
            !$('#editCustomerModal select[name="state"]').parent().hasClass('is-invalid-label') &&
            !$('#editCustomerModal input[name="zip"]').parent().hasClass('is-invalid-label') &&
            !$('#editCustomerModal input[name="email"]').parent().hasClass('is-invalid-label') &&
            !$('#editCustomerModal input[name="projectDescription"]').parent().hasClass('is-invalid-label') &&
            !$('small.onePhone').hasClass('is-visible') &&
            !$('small.fullPhone').hasClass('is-visible') &&
            !$('small.primary').hasClass('is-visible')
            ) {

            var firstName = $('#editCustomerModal input[name="firstName"]').val();
            var lastName = $('#editCustomerModal input[name="lastName"]').val();
            var address = $('#editCustomerModal input[name="address"]').val();
            var address2 = $('#editCustomerModal input[name="address2"]').val();
            var city = $('#editCustomerModal input[name="city"]').val();
            var state = $('#editCustomerModal select[name="state"]').val();
            var zip = $('#editCustomerModal input[name="zip"]').val();
            var email = $('#editCustomerModal input[name="email"]').val();
            var projectDescription = $('#editCustomerModal input[name="projectDescription"]').val();
            var projectSalesperson = $('#editCustomerModal select[name="projectSalesperson"]').val();
            var noEmailRequired = 0;
            var unsubscribed = 0;
            var referralMarketingTypeID = $('#referralDropdown option:selected').val();

            if(referralMarketingTypeID == 0){
                referralMarketingTypeID = null;
            }

            if ($('#editCustomerModal input[name="noEmailRequired"]:checked').length > 0){
                noEmailRequired = 1;
            }

            if ($('#editCustomerModal input[name="unsubscribed"]:checked').length > 0){
                unsubscribed = 1;
            }

            storePhoneTableData();

            function storePhoneTableData() {
                var phoneTableData = new Array();
                $('#phoneTable tbody tr').each(function(row,tr){
                    phoneTableData[row]={
                        "phoneDelete":$(tr).find('td:eq(0)').find('select').attr('delete'),
                        "customerPhoneID":$(tr).find('td:eq(0)').find('select').attr('sort'),
                        "phoneDescription":$(tr).find('td:eq(0)').find('select').val(),
                        "phoneNumber":$(tr).find('td:eq(1)').find('input').val(),
                        "isPrimary":$(tr).find('td:eq(2)').find('input:checked').val()
                    };
                });
                phoneTableData.shift();
                var phoneTableArray = phoneTableData;
               
                $('loading-image').show();
                $.ajax({
                    url: 'customer-edit-project.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        customerID: $('#customerID').text(),
                        propertyID: $('#propertyID').text(),
                        projectID: $('#projectID').attr('value'),
                        firstName: firstName,
                        lastName: lastName,
                        address: address,
                        address2: address2,
                        city: city,
                        state: state,
                        zip: zip,
                        email: email,
                        projectDescription: projectDescription,
                        projectSalesperson: projectSalesperson,
                        referralMarketingTypeID: referralMarketingTypeID,
                        phoneArray: phoneTableArray,
                        noEmailRequired: noEmailRequired,
                        unsubscribed: unsubscribed,
                    },
                    success: function(response) {
                        // console.log(response);
                        if (response == 'true') {
                            $('#phoneTable tbody tr').not(':first').remove();

                            $('#editCustomerModal input[name="firstName"]').val('');
                            $('#editCustomerModal input[name="lastName"]').val('');
                            $('#editCustomerModal input[name="address"]').val('');
                            $('#editCustomerModal input[name="address2"]').val('');
                            $('#editCustomerModal input[name="city"]').val('');
                            $('#editCustomerModal select[name="state"]').val('');
                            $('#editCustomerModal input[name="zip"]').val('');
                            $('#editCustomerModal input[name="email"]').val('');
                            $('#editCustomerModal input[name="projectDescription"]').val('');
                            $('#editCustomerModal select[name="projectSalesperson"]').val('');
                            $('#referralDropdown').find('option[value="0"]').prop('selected', true);

                            $('#editCustomerModal').foundation('close');
                            $('#editCustomerSuccessModal').foundation('open');

                            $('#address').text(address);
                            $('#address2').text(address2);
                            $('#city').text(city);
                            $('#state').text(state);
                            $('#zip').text(zip);

                            updateCustomerInfo();
                            map.MapAddress(address, city, state, zip, 'useAddress', setLatLng);
                            updateCustomerInfo();
                            $('loading-image').hide();

                        } else {

                            $('#editCustomerErrorModal p.error-text').text(response);
                            $('#editCustomerErrorModal').foundation('open');
                        }
                
                    }, error: function(jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                        
                });     

            }
        }
    };

    var getMarketingTypes = function () {
        $('#loading-image').show();
        $.ajax({
            url: 'getMarketingTypes.php',
            dataType: "json",
            contentType: 'application/json',
            type: "GET",
            contentType: "application/x-www-form-urlencoded",
            success: function (response) {
                var index = 0;
                if (response != null) {
                    $.each(response, function (i, item) {
                        index = i +1;
                        if (item.parentMarketingTypeID == null){ //source
                            $('#referralDropdown').append('<option class="source" value="' + item.marketingTypeID + '">' + item.marketingTypeName + '</option>');
                        }
                        else{ //subsource
                            $('.source[value="' + item.parentMarketingTypeID + '"]').after('<option class="subsource" value="' + item.marketingTypeID + '">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + item.marketingTypeName + '</option>');
                        }
                    });
                }
                $('#loading-image').hide();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log(jqXHR.responseText);
            }
        });
    };




    </script>
    <script>
        var map, pano;
        function initMap(reinit) {
            var propLatLng = { lat: parseFloat($('#latitude').text()), lng: parseFloat($('#longitude').text()) };
            if (isNaN(propLatLng.lat) || isNaN(propLatLng.lng) || (propLatLng.lat == 0 && propLatLng.lng == 0)) {
                $('#propertyLocationMap').show();
                $('#propertyLocationStreetview').hide();
                $('#viewStreetView').removeClass('active');
                $('#viewMap').addClass('active');

                map = new MapSet(document.getElementById('propertyLocationMap'), "<?php echo $companyLatitude; ?>", "<?php echo $companyLongitude; ?>"); //FXLRATR-258.
                map.MapAddress($('#address').text(), $('#city').text(), $('#state').text(), $('#zip').text(), 'useAddress', null);
            }
            else if ((map == null || reinit) && $('#propertyLocationMap').css('display') != 'none') {
                map = new MapSet(document.getElementById('propertyLocationMap'), "<?php echo $companyLatitude; ?>", "<?php echo $companyLongitude; ?>"); //FXLRATR-258.
                map.MapLocation($('#latitude').text(), $('#longitude').text(), $('#address').text());
            }
            if (pano == null && $('#propertyLocationStreetview').css('display') != 'none') {
                // initialize a new panorama API object and point to the element with ID streetview as container
                pano = new google.maps.StreetViewPanorama(document.getElementById('propertyLocationStreetview'), {
                    position: propLatLng,
                });
                // initialize a new streetviewService object
                var service = new google.maps.StreetViewService;
                // call the "getPanoramaByLocation" function of the Streetview Services to return the closest streetview position for the entered coordinates
                service.getPanoramaByLocation(pano.getPosition(), 50, function (panoData) {
                    //console.log(panoData);
                    // if the function returned a result
                    if (panoData != null) {
                        // the GPS coordinates of the streetview camera position
                        var panoCenter = panoData.location.latLng;
                        //console.log('panoCenter ' + panoCenter);
                        var currentLocation = new google.maps.LatLng(parseFloat($('#latitude').text()), parseFloat($('#longitude').text()));
                        //console.log('currentLocation ' + currentLocation);
                        // this is where the magic happens!
                        // the "computeHeading" function calculates the heading with the two GPS coordinates entered as parameters
                        var heading = google.maps.geometry.spherical.computeHeading(panoCenter, currentLocation);
                        //console.log('heading ' + heading);
                        // now we know the heading (camera direction, elevation, zoom, etc) set this as parameters to the panorama object
                        var pov = pano.getPov();
                        pov.heading = heading;
                        pano.setPov(pov);
                        //console.log(pov);
                        //map.setStreetView(pano);
                    } else {
                        $('#propertyLocationStreetview').empty().attr('style', '').append('<div>No streetview available</div>');//.append('<img src="images/streeview-unavailable.jpg" />');
                        if (map == null) {
                            $('#propertyLocationMap').show();
                            $('#propertyLocationStreetview').hide();
                            $('#viewStreetView').removeClass('active');
                            $('#viewMap').addClass('active');
                            initMap();
                        }
                    }
                });
            }
        }

        var useAddress = function (a, c, s, z, lat, lng) {
            $('#address').text(a);
            $('#city').text(c);
            $('#state').text(s);
            $('#zip').text(z);
            $('#latitude').text(lat);
            $('#longitude').text(lng);
            updateLatLong(lat, lng, 'true');
            initMap(true);
        }

        var updateLatLong = function(lat, lng, changeAddress){
                var address = $('#address').text();
                var address2 = $('#address2').text();
                var city = $('#city').text();
                var state = $('#state').text();
                var zip = $('#zip').text();

                $.ajax({
                    url: 'customer-edit-lat-long.php',
                    dataType: "json",
                    contentType: 'application/json',
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        customerID: $('#customerID').text(),
                        propertyID: $('#propertyID').text(),
                        address: address,
                        address2: address2,
                        city: city,
                        state: state,
                        zip: zip,
                        lat: lat,
                        long: lng,
                        changeAddress: changeAddress,
                    },
                    success: function (response) {
                        response = response[0];
                        var ownerAddress = response.ownerAddress;

                        if (ownerAddress != address ) {
                            $('#ownerAddressDisplay').html('<p id="ownerAddressDisplay"><strong>Address - Billing</strong><br/>' + response.ownerAddress +' '+ response.ownerAddress2 +'<br/>' + response.ownerCity +', ' + response.ownerState +' ' + response.ownerZip + '<br/></p>');
                            $('#addressDisplay').html('<p id="addressDisplay"><strong>Address - Property</strong><br/>' + address +' ' + address2 +'<br/>' + city +', ' + state +' ' + zip + '<br/></p>');
                            $('#ownerAddressDisplay').show();
                        } else {
                            $('#addressDisplay').html('<p id="addressDisplay"><strong>Address</strong><br/>' + address + ' ' + address2 + '<br/>' + city + ', ' + state + ' ' + zip +'<br/></p>');
                            $('#ownerAddressDisplay').hide();
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                });
        }

        var fitBounds = function (map, marker) {
            var bounds = new google.maps.LatLngBounds();
            var isAddressSet = false;
            if (marker != null && $.isArray(marker) && marker.length > 0) {
                for (var i = 0; i < marker.length; i++) {
                    bounds.extend(marker[i].position);
                    isAddressSet = true;
                }
            }
            else if (marker != null) {
                bounds.extend(marker.position);
                isAddressSet = true;
            }
            if (isAddressSet) {
                map.fitBounds(bounds);
            }
            if (map.getZoom() > 16) map.setZoom(16);
            var listener = google.maps.event.addListener(map, 'idle', function () {
                if (map.getZoom() > 16 && !map.initialZoom) {
                    map.setZoom(16);
                    map.initialZoom = true;
                }
                google.maps.event.removeListener(listener);
            });
        };

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVYIV3RYj9RJGqLjZNgA7-Dhwt5pTJrT0&callback=initMap" async defer></script>
    <style>
        #propertyLocationMap, #propertyLocationStreetview {
            height: 320px;
            border: 1px solid #000;
        }

        #calendarMap {
            height: 320px;
            border: 1px solid #000;
            padding: 1px 1px 1px 1px;
        }
    </style>
</head>
<body>
    <?php  include_once 'header.html'  ?>
    <div id="loading-image" class="loadingImage">
        <img src="images/ajax-loader.gif" />
    </div>
    <div class="row expanded first-row" style="background-color:#f6f7fb;">
        <div class="medium-12 columns">
            <div class="medium-12 columns">
                <h1 class="project-title"><?php echo $firstName; ?> <?php echo $lastName; ?> - <?php echo $projectDescription; ?></h1>
            </div>
        </div>
    </div>
    <div class="row expanded" style="background-color:#2089cb;">
        <div class="medium-12 columns">
            <!--<div class="row expanded">
                <div style="background: #0D477A;" class="columns">Project Setup</div>
                <div style="background: #1c72ab;" class="columns">Schedule Appointment</div>
            <div style="background: #1c72ab;" class="columns">Submitted Repair Plan</div>
                <div style="background: #1c72ab;" class="columns">Bid to Customer</div>
              <div style="background: #1c72ab;" class="columns">Approved Bid/Contract Sent</div>
              <div style="background: #1c72ab;" class="columns">Scheduled Installation</div>
              <div style="background: #1c72ab;" class="columns">Installation In Progress</div>
              <div style="background: #1c72ab;" class="columns">Project Completed</div>
              <div style="background: #1c72ab;" class="columns">Final Report Sent</div>
            </div>  	-->
            <div class="progress-bar">
                <div class="first <?php echo $projectSetupActive; ?>">Project Setup</div>
                <div class="middle second <?php echo $scheduledAppointmentActive; ?>">Schedule Appointment</div>
                <div class="middle third <?php echo $submittedRepairActive; ?>">Submitted Repair Plan</div>
                <div class="middle fourth <?php echo $bidSentActive; ?>">Bid to Customer</div>
                <div class="middle fifth <?php echo $bidAcceptedActive; ?>">Accepted Bid/Contract Sent</div>
                <div class="middle sixth <?php echo $scheduledInstallationActive; ?>">Scheduled Installation</div>
                <div class="middle seventh <?php echo $installationInProgressActive; ?>">Installation In Progress</div>
                <div id="projectComplete" class="middle eighth <?php echo $projectCompletedActive; ?>">Project Completed</div>
                <div class="last <?php echo $finalReportActive; ?>">Final Report Sent</div>
            </div>
        </div>
    </div>
    <div class="row expanded" style="margin-bottom: 4rem;">
        <div class="medium-12 columns no-pad">
            <ul class="tabs" data-tabs id="project-tabs">
            <li style="width:<?php echo $tabWidth ?>"  id="to-customer" style=""><a href="customer-management.php?cid=<?php echo $customerID; ?>&pid=<?php echo $projectID;  ?>"> Customer</a></li>
                <li style="width:<?php echo $tabWidth ?>" id="generalTab" class="tabs-title is-active"><a href="#general" aria-selected="true">Project</a></li>
                <li style="width:<?php echo $tabWidth ?>" id="scheduleTab" class="tabs-title"><a href="#schedule">Schedule</a></li>
                <li style="width:<?php echo $tabWidth ?>;" class="tabs-title"><a style="padding: 1.25rem .5rem;" href="#evaluation">Evaluation & Bids</a></li>
                <?php echo $billingTabDisplay ?>
                <li style="width:<?php echo $tabWidth ?>" class="tabs-title"><a href="#notes">Notes</a></li>
                <li style="width:<?php echo $tabWidth ?>" class="tabs-title"><a href="#history">History</a></li>
            </ul>
            <div class="tabs-content" data-tabs-content="project-tabs">                
            <div class="tabs-panel" id="customer">
                    <div class="medium-12 columns">
                        <div class="row expanded">
                            <div class="medium-3 columns" style="padding-left:2rem;">
                                <p>
                                    <strong>Address - Billing</strong><br>
                                    <?php echo $ownerAddress;  ?> <?php echo $ownerAddress2;  ?><br/>
                                    <?php echo $ownerCity;  ?>, <?php echo $ownerState;  ?> <?php echo $ownerZip;  ?>
                                </p>
                                <p id="contactInfoCustomer" style="margin-bottom: 2rem;">
                                    <strong>Contact Information</strong><br/>
                                    <?php echo $phoneDisplay;  ?>
                                    Email: <a href="mailto:<?php echo $email;  ?>"><?php echo $email;  ?></a><?php echo $unsubscribedText;  ?>
                                </p>
                               <!--  <p>
                                     <button class="button">Edit Info</button>
                                </p>   -->      
                            </div>
                            <div class="medium-9 columns" style="border-left: 1px dotted #cbcacf;padding-left: 2rem;padding-right: 2rem;">
                                <div class="row expanded">
                                    <div class="medium-10 columns"> 
                                       <h4>Properties</h4>
                                    </div>
                                    <div class="medium-2 columns" style="margin-top:0.5rem"> 
                                        <a href="customer-add.php?cid=<?php echo $customerID;  ?>" class="button xtiny" style="float:right;">Add Property</a>
                                    </div>
                                    <div class="medium-12 columns">
                                         <?php echo $propertyDisplay;  ?>
                                    </div>
                                </div>
                            </div> 
                        </div>  
                     </div>
                </div>
                <div class="tabs-panel is-active" id="general">
                       <!--  <a href="customer-management.php?cid=<?php echo $customerID; ?>&pid=<?php echo $projectID;  ?>" >< Back To Customer</a> -->
                        <div class="row expanded">
                        <div class="medium-8 columns" style="border-right: 1px dotted #cbcacf;">
                            <div class="row expanded">
                                <div class="medium-7 columns">
                                    <div id="propertyLocationMap" style="display: none;"></div>
                                    <div id="propertyLocationStreetview"></div>
                                    <div class="button-group text-center" style="margin-top: 1rem;">
                                        <a id="viewStreetView" class="button bar left active">Streetview</a>
                                        <a id="viewMap" class="button bar right">Map</a>
                                    </div>
                                </div>
                                <div class="medium-5 columns">
                                    <p id="projectName">
                                        <strong>Project</strong><br>
                                        <?php echo $projectDescription; ?>
                                        <?php echo $projectCancelledDisplay; ?>
                                    </p>
                                    <?php echo $salespersonDisplay; ?>
                                    <?php echo $addressDisplay;  ?>
                                    <p id="contactInfoProject">
                                        <strong>Contact Information</strong><br />
                                        Name: <?php echo $firstName; ?> <?php echo $lastName; ?><br/>
                                        <?php echo $phoneDisplay;  ?>
                                        Email: <a href="mailto:<?php echo $email;  ?>"><?php echo $email;  ?><?php echo $unsubscribedText;  ?></a>
                                    </p>
                                    <?php echo $additionalContactsDisplay; ?>
                                    <p>
                                        <?php echo $customerEditDisplay;  ?>
                                        <?php echo $addContactsButtonDisplay; ?>
                                    </p>
                                </div>
                            </div>
                            <div class="row expanded" style="display: none;">
                                <div class="medium-12 columns">
                                    <p>
                                        <strong>Pinned Notes</strong><br>
                                    </p>
                                </div>
                                <div id="projectTabNotes" class="medium-12 columns">

                                </div>
                            </div>
                        </div>
                        <div class="medium-4 columns" style="padding-left: 2rem;">
                            <div class="medium-12 columns">
                                <strong>Schedule</strong>
                                <ul class="no-bullet">
                                    <li id="generalEvaluationSchedule"></li>
                                    <li id="generalInstallationSchedule"></li>
                                </ul>
                                <div id="generalDocuments">
                                </div>
                                <div class="row" style="margin-bottom:1rem;">
                                    <div class="medium-6 columns text-center"><a id="openProjectDocumentsModal" class="button expanded">Upload Document</a></div>
                                </div>
                                <div id="generalBilling">
                                </div>
                                <p id="projectButtons" style="margin-top: 2rem;">
                                    <?php echo $projectButtons;  ?>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div id="uploadDocument" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Upload Project Document</h2>
                        <div class="row">
                            <div class="medium-9 columns">
                                <label>
                                    Document Description <small>required</small>
                                    <input type="text" name="documentDescription" value="" />
                                    <small class="form-error">Description is required.</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns" style="margin-bottom:1rem;">
                                <label>
                                    Upload Document <small>required</small>
                                    <input type="file" name="document" />
                                    <small class="form-error">Description is required.</small>
                                </label>
                            </div>
                            <div class="medium-12 columns">
                                <button id="addDocument" class="button">Upload</button>
                                <button class="button secondary" id="cancelDocument">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tabs-panel" id="schedule">
                    <div class="row expanded">
                        <div class="medium-12 columns">
                            <div id="cancelSchedule"></div>
                        </div>
                    </div>
                    <div class="row expanded">
                        <div id="scheduleList" class="medium-8 columns">
                            <div class="medium-12 columns">
                                <div class="row expanded">
                                    <div class="medium-6 columns no-pad">
                                        <h5 style="margin:0;color: #333333;margin-bottom:.5rem;">Evaluation</h5>
                                    </div>
                                    <div id="scheduleEvaluationButton" class="medium-6 columns no-pad"></div>
                                </div>
                                <div class="row expanded" id="evaluationSchedule">
                                </div>
                            </div>
                            <hr>
                            <div class="medium-12 columns">
                                <div class="row expanded">
                                    <div class="medium-6 columns no-pad">
                                        <h5 style="margin:.5rem 0;color: #333333;">Installation</h5>
                                    </div>
                                    <div id="scheduleInstallationButton" class="medium-6 columns no-pad"></div>
                                </div>
                                <div class="row expanded" id="installationSchedule">
                                </div>
                            </div>
                        </div>
                        <div id="scheduleMap" class="medium-4 columns"></div>
                    </div>
                    <div class="row expanded">
                        <div id="scheduleCalendar" class="medium-12 columns" style="display:none;">
                            <div class="row expanded dashboard-filter-bar">
                                <div class="medium-3 columns">
                                    <div id="filterSelect"></div>
                                </div>
                                <div class="medium-1 columns">
                                    <a id="today" class="button today" style="">Today</a>
                                </div>
                                <div class="medium-5 columns" style="margin-top: 1rem;">
                                    <div class="row expanded">
                                        <div class="medium-2 columns no-pad">
                                            <div id="previous" class="arrow-left"></div>
                                        </div>
                                        <div class="medium-8 columns no-pad text-center">
                                            <span id="calendarTitle">Friday, April 22, 2016</span>
                                        </div>
                                        <div class="medium-2 columns no-pad">
                                            <div id="next" class="arrow-right"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="medium-3 columns">
                                    <div class="button-group text-right">
                                        <a id="monthlyView" class="button view view-left active">Monthly</a>
                                        <a id="weeklyView" class="button view view-center">Weekly</a>
                                        <a id="dailyView" class="button view view-right">Daily</a>
                                    </div>
                                </div>
                            </div>
                            <div class="row expanded">
                                <div class="medium-12 columns no-pad">
                                    <div id="calendar"></div>
                                    <div id="addEvent" class="reveal small" data-reveal data-close-on-esc="false" data-close-on-click="false">
                                        <h2 id="modalTitle"></h2>
                                        <p class="lead"></p>
                                        <div class="row">
                                            <div class="medium-12 columns">
                                                <label class="scheduledTitle"></label>
                                            </div>
                                            <div class="medium-5 columns" id="scheduleModalDD">
                                                <select class="evaluationData" name="salesperson">
                                                    <option value="">--</option>
                                                </select>
                                            </div>
                                            <div class="medium-7 columns"></div>
                                        </div>
                                        <div class="row">
                                            <div class="medium-12 columns">
                                                <label>Start Time</label>
                                            </div>

                                            <div class="medium-4 columns">
                                                <input id="scheduledStartDate" style="margin-bottom: .2rem;" class="evaluationData datepickerFrom date" type="text" name="scheduledStartDate" />
                                                <small class="form-error" id="startDateErr">Please select a scheduled start date</small>
                                            </div>

                                            <div class="medium-4 columns">
                                                <input id="scheduledStartTime" style="margin-bottom: .2rem;" class="evaluationData timepicker" type="text" name="scheduledStartTime" />
                                                <small class="form-error" id="startTimeErr">Please enter a scheduled start time</small>
                                                <div id="scheduledStartTimeHidden" class="is-hidden"></div>
                                            </div>

                                            <div class="medium-3 columns">
                                                <input type="checkbox" name="scheduledStartTimeAllDay" value="1" /> All Day
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="medium-12 columns">
                                                <label>End Time</label>
                                            </div>
                                            <div class="medium-4 columns">
                                                <input id="scheduledEndDate" style="margin-bottom: .2rem;" class="evaluationData datepickerTo date" type="text" name="scheduledEndDate" />
                                                <small style="margin-bottom: .3rem;"class="form-error" id="endDateErr">Please select an end date</small>
                                            </div>
                                            <div class="medium-4 columns">
                                                <input id="scheduledEndTime"style="margin-bottom: .2rem;" class="evaluationData timepicker" type="text" name="scheduledEndTime" />
                                                <small style="margin-bottom: .3rem;" id="endTimeErr" class="form-error">Please enter an end time</small>

                                                <div id="scheduledEndTimeHidden" class="is-hidden"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="medium-12 columns">
                                                <input type="hidden" name="tempID" value="" />
                                                <input type="hidden" name="projectScheduleID" value="" />
                                                <p><a style="margin-top:1rem;" id="confirmAppointmentYes" class="button">Save</a> <a  style="margin-top:1rem;" id="confirmAppointmentNo" class="button secondary">Cancel</a></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="viewEvent" class="reveal" data-reveal></div>
                                    <div id="cancelEvent" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                                        <h2 id="modalTitle">Cancel</h2>
                                        <p>Are you sure you want to cancel this event?</p>
                                        <input type="hidden" name="tempID" value="" />
                                        <p><a id="cancelConfirmYes" class="button">Yes</a> <a id="cancelConfirmNo" class="button secondary">No</a></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tabs-panel" id="evaluation">
                    <div class="medium-12 columns">
                        <div class="row expanded">
                            <div class="medium-12 columns">
                                <?php echo $evaluationAddDisplay;  ?>
                            </div>
                        </div>
                    </div>
                    <div id="bidAccepted" class="is-hidden"></div>
                    <div id="evaluationList" class="medium-12 columns">
                    </div>
                    <div id="newEvaluationModal" class="reveal tiny" data-reveal>
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Create New Evaluation</h2>
                        <div class="row" style="margin-bottom:1rem;">
                            <div class="medium-12 columns text-center"><a data-open="copyEvaluationSelectModal" class="button expanded">Copy Existing</a></div>
                        </div>
                        <div class="row" style="margin-bottom:1rem;">
                            <div class="medium-12 columns text-center"><a id="openNewEvaluationModal" class="button expanded">Create New</a></div>
                        </div>
                        <div class="row" style="margin-bottom:1rem;">
                            <div class="medium-12 columns text-center"><a id="openCustomEvaluationModal" class="button expanded">Upload File</a></div>
                        </div>
                        <button class="close-button" data-close aria-label="Close modal" type="button">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div id="uploadEvaluation" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Upload Evaluation</h2>
                        <div class="row">
                            <div class="medium-9 columns" style="margin-bottom: 1rem;">
                                <label>
                                    Evaluation Description <small>required</small>
                                    <input style="margin-bottom: 0" type="text" name="evaluationDescription" value="" />
                                    <small class="form-error">Description is required.</small>
                                    <small>(Note: Shows to Customer)</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns" style="margin-bottom:1rem;">
                                <label>
                                    Upload Document <small>required</small>
                                    <input type="file" name="customEvaluation" />
                                    <small class="form-error">Description is required.</small>
                                </label>
                            </div>
                            <div class="medium-12 columns">
                                <button id="addCustomEvaluation" class="button">Upload</button>
                                <button class="button secondary" id="cancelCustomEvaluation">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="newEvaluation" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">New Evaluation</h2>
                        <div class="row align-center">
                            <div class="medium-10 columns" style="margin-bottom: 1rem;">
                                <label>
                                    Evaluation Description <small>required</small>
                                    <input style="margin-bottom: 0" type="text" name="evaluationDescription" value="" />
                                    <small class="form-error">Description is required.</small>
                                    <small>(Note: Shows to Customer)</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <button id="startNewEvaluation" class="button">Start</button>
                                <button class="button secondary" id="closeNewEvaluationModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="cancelEvaluationModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Cancel Bid</h2>
                        <div class="row align-center">
                            <p>Are you sure you want to cancel this bid?</p>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <input type="hidden" id="idToCancel" name="idToCancel" value="" />
                                <button id="cancelEvaluation" class="button">Ok</button>
                                <button class="button secondary" id="closeCancelEvaluationModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="copyEvaluationModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Copy Evaluation</h2>
                        <div class="row align-center">
                            <div class="medium-10 columns" style="margin-bottom: 1rem;">
                                <label>
                                    Evaluation Description <small>required</small>
                                    <input style="margin-bottom: 0" type="text" name="evaluationDescription" />
                                    <small class="form-error">Description is required.</small>
                                    <small>(Note: Shows to Customer)</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <input type="hidden" id="idToCopy" name="idToCopy" value="" />
                                <button id="startCopiedEvaluation" class="button">Start</button>
                                <button class="button secondary" id="closeCopiedEvaluationModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="copyCustomEvaluationModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Copy Custom Evaluation</h2>
                        <div class="row align-center">
                            <div class="medium-10 columns" style="margin-bottom: 1rem;">
                                <label>
                                    Evaluation Description <small>required</small>
                                    <input style="margin-bottom: 0" type="text" name="evaluationDescription" />
                                    <small class="form-error">Description is required.</small>
                                    <small>(Note: Shows to Customer)</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <input type="hidden" id="idToCopy" name="idToCopy" value="" />
                                <button id="startCustomCopiedEvaluation" class="button">Start</button>
                                <button class="button secondary" id="closeCopiedCustomEvaluationModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="copyEvaluationSelectModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Copy Evaluation</h2>
                        <div class="row align-center">
                            <div class="medium-10 columns" style="margin-bottom: 1rem;">
                                <label>
                                    Evaluation to Copy <small>required</small>
                                    <select id="currentEvaluationNames">
                                        <option value=""></option>
                                    </select>
                                    <small class="form-error">Evaluation to copy is required.</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <button id="selectCopyEvaluationSelectModal" class="button">Continue</button>
                                <button class="button secondary" id="closeCopyEvaluationSelectModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="editEvaluationNameModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1.5rem;">Edit Evaluation</h2>
                        <div class="row align-center">
                            <div class="medium-10 columns" style="margin-bottom: 1rem;">
                                <label>
                                    Evaluation Description <small>required</small>
                                    <input style="margin-bottom: 0" type="text" name="evaluationDescription" />
                                    <small style=" margin-top: .25rem;" class="form-error">Description is required.</small>
                                    <small>(Note: Shows to Customer)</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <input type="hidden" id="idToEdit" name="idToEdit" value="" />
                                <button id="saveEvaluationName" class="button">Save</button>
                                <button class="button secondary" id="closeEditEvaluationModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="tiny reveal" id="emailSentModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h3 class="text-center"></h3>
                        <div class="row">
                            <div class="medium-12 columns">
                                <p class="text-center no-margin modalContent"></p>
                                <p class="text-center no-margin" style="margin-top:1rem;">
                                    <button class="button" data-close>OK</button>
                                </p> 
                            </div>
                        </div>
                    </div>
                    <div class="reveal large" id="scopeChangeModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h3>Scope of Work Change</h3>
                        <div class="row">
                            <div class="medium-12 columns no-pad">
                                <table class="evaluationTable scopeChangeItemTable" cellpadding="0" cellspacing="0">
                                    <thead>
                                        <tr>    
                                            <th width="15%">Date</th>
                                            <th width="40%">Description</th>
                                            <th width="15%">Price</th>
                                             <th width="20%">Type</th>
                                            <th width="10%"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="display:none;">
                                            <td style="color:#36413e;text-align:center;">
                                                <input class="ChangeDate datepicker" sort="0" name="changeDate[]" type="text" value="" />
                                                 <input type="hidden" name="changeID" value="">
                                            </td>
                                            <td style="color:#36413e;text-align:center;">
                                                <textarea rows="1" style="margin: .8rem 0 0 0;" sort="0" class="ChangeItem" name="changeItem[]"></textarea>
                                            </td>
                                            <td style="color:#36413e;text-align:center;">
                                                <input class="ChangePrice" name="changePrice[]" sort="0" type="text" value="" />
                                            </td>
                                            <td>
                                                <div class="button-group text-center">
                                                    <button id="charge" class="button bar left active" style="padding: 0.5em .5em;" type="charge">Charge</button>
                                                    <button id="credit" class="button bar right" style="padding: 0.5em .5em;" type="credit">Credit</button>
                                                </div>
                                            </td>
                                           <!--  <div class="switch small">
                                                <input checked="" class="switch-input" id="mapSwitch" type="checkbox" name="mapSwitch">
                                                <label class="switch-paddle" for="mapSwitch">
                                                    <span class="switch-active" aria-hidden="true">+</span>
                                                    <span class="switch-inactive" aria-hidden="true">-</span>
                                                </label>
                                            </div> -->
                                            <td class="delete" style="color:#36413e;text-align:center;">
                                                <a class="deletePhone"><img src="images/icons/phone_delete.png" /></a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="medium-12 columns no-pad" style="border-top: 1px solid #b1b4bf;">
                                <div class="row">
                                    <div class="medium-6 columns no-pad">
                                        <br/>
                                    </div>
                                    <div class="medium-6 columns no-pad">
                                        <p class="changeTotal" style="margin-left: 3.5rem;margin-top: .5rem;color:#59595B;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns">
                                <input type="hidden" id="hiddenChangeTotal" value="">
                                <input type="hidden" id="hiddenChangeType" value="">
                                <button class="button" id="saveScopeChange">Save</button>  
                                <button class="button secondary" id="cancelScopeChange">Cancel</button>     
                           </div>
                        </div>
                    </div>
                    <div class="tiny reveal" id="bidTotalModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 style="text-align:center;margin-bottom:1.5rem;">Bid Total</h2>
                        <div class="row align-center">
                            <div class="medium-10 columns">
                                <label>
                                    Total <small>required</small>
                                    <input type="text" name="customBidTotal" />
                                    <small class="form-error">Total is required.</small>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <input type="hidden" id="idToCopy" name="idToCopy" value="" />
                                <button id="bidTotalNext" class="button">Next</button>
                                <button class="button secondary" id="cancelBidTotal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="small reveal" id="invoiceModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <div class="row" style="position: relative;">
                            <h3>Billing</h3>
                            <div class="medium-2 columns" style="position: absolute; right: 130px; top: 40%; transform: translate(0, -50%)">Bid #</div>
                            <div class="medium-2 columns no pad" style="position: absolute; right: 0rem;">
                                <input class="changeBidNumber number" type="text" value="" name="bidNumber">
                                <small id="bidNumberError" class="form-error">This bid number has already been used.</small>
                            </div>
                        </div>
                        <p>Set the invoice split percentages.</p>
                        <div class="row">
                            <div class="medium-6 columns">
                                <div class="row">
                                    <div class="small-12 columns">
                                        <div class="row no-pad">
                                            <div class="medium-2 columns no-pad-left">
                                                <a class="button xtiny counter numberInvoices">-</a>
                                            </div>
                                            <div class="medium-2 columns no-pad invoiceCountInput">
                                                <input onload="getValue(this)" class="invoiceCount Integer" style="text-align:center;" type="text" value="0" />
                                            </div>
                                            <div class="medium-2 columns no-pad-right">
                                                <a class="button xtiny counter numberInvoices">+</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>  
                            </div>
                            <div class="medium-3 columns">
                                <div class="row">
                                    <div class="medium-10 columns">
                                        <p class="text-center">Percentage</p>
                                    </div>
                                  <div class="medium-2 columns no-pad-left text-left"></div>
                                </div>
                            </div>
                            <div class="medium-3 columns">
                                <div class="row">
                                    <div class="medium-2 columns no-pad-right text-right"></div>
                                    <div class="medium-10 columns">
                                        <p class="text-center">Invoice Amount</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-6 columns">
                                <input class="required" type="text" value="Bid Acceptance" name="bidAcceptanceName" id="bidAcceptanceName"> <!-- removed 'disabled' FXLRATR 177-->
                                <small id="ba" class="form-error">You must include a name for 'Bid Acceptance'.</small>
                            </div>
                            <div class="medium-3 columns">
                                <div class="row">
                                    <div class="medium-10 columns">
                                        <input class="changeInvoicePercent default" type="text" value="<?php echo $invoiceSplitBidAcceptance; ?>" name="invoiceSplitBidAcceptance" />
                                    </div>
                                    <div class="medium-2 columns no-pad-left text-left">%</div>
                                </div>
                            </div>
                            <div class="medium-3 columns">
                                <div class="row">
                                    <div class="medium-2 columns no-pad-right text-right">$</div>
                                    <div class="medium-10 columns">
                                        <input class="changeInvoiceAmount default" type="text" value="1000.00" name="bidAcceptanceTotal" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns no-pad">
                                <table class="evaluationTable invoiceTable" cellpadding="0" cellspacing="0">
                                    <thead style="background:none;">
                                        <tr>
                                            <th style="text-align:left;color:#0a0a0a;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;" width="50%"></th>
                                            <th style="text-align:left;color:#0a0a0a;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;" width="25%"></th>
                                            <th style="text-align:left;color:#0a0a0a;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;" width="25%"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="display:none;">
                                            <td style="color:#36413e;text-align:center;padding: 0 .9rem;">
                                                <input sort="0" name="invoiceName[]" type="text" value="" placeholder="Invoice Name" />
                                            </td>
                                            <td style="color:#36413e;text-align:center;">
                                                <input sort="0" class="changeInvoicePercent" name="invoiceSplit[]" type="text" value="" placeholder="Invoice Split" />
                                            </td>
                                            <td style="color:#36413e;text-align:center;">
                                                <input sort="0" class="changeInvoiceAmount" name="invoiceAmount[]" type="text" value="" placeholder="Invoice Amount" />
                                            </td>
                                            <!-- <td style="color:#36413e;text-align:center;">
                                                <input class="invoiceNumber number" sort="0" name="invoiceNumber[]" type="text" value="" placeholder="Number" />
                                                <small id="duplicateInvoice" class="form-error">This is a duplicate invoice number.</small>
                                                <small id="existingInvoice" class="form-error">This invoice number has already been used.</small>
                                            </td> -->
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-6 columns">
                                <input class="required" type="text" value="Project Completion" name="projectCompleteName" id="projectCompleteName"> <!-- removed 'disabled' FXLRATR 177-->
                                <small id="projectCompletion" class="form-error">You must include a name for 'Project Completion'.</small>
                            </div>
                            <div class="medium-3 columns">
                                <div class="row">
                                    <div class="medium-10 columns">
                                        <p id="invoiceSplitProjectComplete" style="margin-left: .5rem;"><?php echo $invoiceSplitProjectComplete; ?></p>
                                    </div>
                                    <div class="medium-2 columns no-pad-left text-left">%</div>
                                </div>
                            </div>
                            <div class="medium-3 columns">
                                <div class="row">
                                    <div class="medium-2 columns no-pad-right text-right">$</div>
                                    <div class="medium-10 columns">
                                        <p id="projectCompleteTotal" style="margin-left: .5rem;">1000.00</p>
                                    </div>
                                </div>
                            </div>   
                        </div>
                        <div class="row" style="border-top:1px solid #000;">
                            <div class="medium-6 columns" style="margin-top: .5rem;">
                                <p class="lead">Total</p>
                            </div>
                            <div class="medium-3 columns" style="margin-top: .5rem;">
                                <p style="margin-left: .5rem;">100%</p>
                            </div>
                            <div class="medium-3 columns" style="margin-top: .5rem;">
                                <div class="row">
                                    <div class="medium-2 columns no-pad-right text-right">$</div>
                                    <div class="medium-10 columns">
                                        <p id="bidTotal" style="margin-left: .5rem;"></p>
                                    </div>
                                </div>
                            </div>  
                        </div>
                        <div class="row">
                            <div class="medium-12 columns">
                                <button class="button" id="invoiceApprove">Send Bid</button>  
                                <button class="button secondary" id="cancelInvoice">Cancel</button>     
                           </div>
                        </div>
                    </div>
                    <div class="tiny reveal" id="bidSentModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h3 class="text-center">Bid Sent</h3>
                        <div class="row">
                            <div class="medium-12 columns">
                                <p class="text-center no-margin">
                                    Your bid has been sent to <?php echo $firstName;  ?> <?php echo $lastName;  ?> at <?php echo $email;  ?>.
                                    <br/><br/>
                                    <button class="button" data-close>OK</button>
                                </p> 
                            </div>
                        </div>
                    </div>
                </div>
                <?php echo $billingDisplay ?>
                <div class="tabs-panel" id="notes"> 
                    <div class="row expanded">
                        <div class="medium-12 columns" style="margin-top:0.5rem">
                            <a id="newNote" class="button" style="float:right;margin-bottom: .7rem;">Add Note</a>
                        </div>
                    </div>
                    <div class="row expanded">
                        <div id="projectNotes" class="medium-12 columns pinnedNotes" style="padding-top: 1rem;">
                                
                        </div>
                        <div id="projectNoteDivider" class="medium-12 columns">
                            <hr/>
                        </div>
                        <div id="projectNotes" class="medium-12 columns nonPinnedNotes">
                            
                        </div>
                    </div>
                    <div id="addNoteModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1rem;">Add Note</h2>
                        <div class="row">
                            <div class="medium-12 columns">
                                <label>
                                    Note <small>required</small>
                                    <textarea style="background-color: #dff1fc" rows="3" id="textareaNote" name="note"></textarea>
                                    <small style=" margin-top: .25rem;" class="form-error">Note is required.</small>
                                </label>
                            </div>
                            <div class="medium-12 columns" style="margin-bottom: 1rem;">
                                <label>Pin Note <span data-tooltip aria-haspopup="true" class="has-tip top" data-disable-hover="false" tabindex="6" title="Pin note to the top of the note list and to the project tab."><img src="images/icons/info.png" /></span></label>
                                <div class="switch tiny">
                                    <input class="switch-input" id="isPinnedAdd" type="checkbox" name="isPinnedAdd" value="1">
                                    <label class="switch-paddle" for="isPinnedAdd"></label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns">
                                <button id="addNewNote" class="button">Add</button>
                                <button class="button secondary" id="closeAddNoteModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="editNoteModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1rem;">Edit Note</h2>
                        <div class="row">
                            <div class="medium-12 columns">
                                <label>
                                    Note <small>required</small>
                                    <textarea style="background-color: #dff1fc" id="textareaNote" name="note"></textarea>
                                    <small style=" margin-top: .25rem;" class="form-error">Note is required.</small>
                                </label>
                            </div>
                            <div class="medium-12 columns" style="margin-bottom: 1rem;">
                                <label>Pin Note <span data-tooltip aria-haspopup="true" class="has-tip top" data-disable-hover="false" tabindex="6" title="Pin note to the top of the note list and to the project tab."><img src="images/icons/info.png" /></span></label>
                                <div class="switch tiny">
                                    <input class="switch-input" id="isPinnedEdit" type="checkbox" name="isPinnedEdit" value="1">
                                    <label class="switch-paddle" for="isPinnedEdit"></label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns">
                                <input type="hidden" id="idToEdit" name="idToEdit" value="" />
                                <button id="saveNote" class="button">Save</button>
                                <button class="button secondary" id="closeEditNoteModal">Cancel</button>
                                <button style="float: right" class="button secondary" id="deleteNote">Delete</button>
                            </div>
                        </div>
                    </div>
                    <div id="deleteNoteModal" class="reveal tiny" data-reveal data-close-on-esc="false" data-close-on-click="false">
                        <h2 id="modalTitle" style="text-align:center;margin-bottom:1rem;">Delete Note</h2>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <p>Are you sure you want to delete this note?</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="medium-12 columns text-center">
                                <input type="hidden" id="idToDelete" name="idToDelete" value="" />
                                <button id="yesDeleteNote" class="button">Ok</button>
                                <button class="button secondary" id="closeDeleteNoteModal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tabs-panel" id="history">
                    <div id="projectHistory" class="medium-12 columns">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="reopenModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Reopen Project</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    Are you sure you want to reopen this project?
                    <br /><br />
                    <button class="button" id="yesReopenProject">OK</button>
                    <button class="button secondary" data-close>Cancel</button>
                </p>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="cancelModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Cancel Project</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    Are you sure you want to cancel this project? This will cancel any open appointments and evaluations.
                    <br /><br />
                    <button class="button" id="yesCancelProject">OK</button>
                    <button class="button secondary" data-close>Cancel</button>
                </p>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="projectCompleteModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Project Complete</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    Are you sure you want to mark this project as completed?
                    <br /><br />
                    <button class="button" id="yesCompleteProject">Yes</button>
                    <button class="button secondary" data-close>Cancel</button>
                </p>
            </div>
        </div>
    </div>
    <div class="reveal" id="editCustomerModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Edit Customer</h3>
        <div class="row">
            <div class="medium-6 columns">
                <label>First Name <small>required</small>
                    <input class="customerRequired" name="firstName" type="text" value="" />
                    <small class="form-error">First name is required.</small>
                </label>
            </div>
            <div class="medium-6 columns">
                <label>Last Name <small>required</small>
                    <input class="customerRequired" name="lastName" type="text" value="" />
                    <small class="form-error">Last name is required.</small>
                </label>
            </div>
        </div>
        <div class="row">
            <div class="medium-8 columns">
                <label>Property Address <small>required</small>
                    <input class="customerRequired" name="address" type="text" value="" />
                    <small class="form-error">Address is required.</small>
                </label>
            </div>
        </div>
        <div class="row">
            <div class="medium-8 columns">
                <label>Property Address 2 <small>(Apt, Suite, Unit)</small>
                    <input name="address2" type="text" value="" />
                </label>
            </div>
        </div>
        <div class="row">
            <div class="medium-4 columns">
                <label>City <small>required</small>
                    <input class="customerRequired" name="city" type="text" value="" />
                    <small class="form-error">City is required.</small>
                </label>
            </div>
            <div class="medium-4 columns">
                <label>State <small>required</small>
                    <select class="customerRequired" name="state">
                        <?php echo $stateOptions;  ?>
                    </select>
                    <small class="form-error">State is required.</small>
                </label>
            </div>
            <div class="medium-3 columns">
                <label>Zip <small>required</small>
                    <input class="customerRequired" name="zip" type="text" value="" />
                    <small class="form-error">Zip is required.</small>
                </label>
            </div>
        </div>
        <div class="row">
            <div class="medium-8 columns">
                <label>Email <small>required</small>
                    <input class="customerRequired" name="email" type="text" value="" />
                    <small class="form-error">Email is required.</small>
                </label>
            </div>
            <div class="medium-2 columns">
                <label>No Email</label>
                <input name="noEmailRequired" type="checkbox" style="margin-left: 1.1rem; margin-top: 0.7rem">
            </div>
            <div class="medium-2 columns">
                <label>Unsubscribe</label>
                <input name="unsubscribed" type="checkbox" style="margin-left: 1.9rem; margin-top: 0.7rem"">
            </div>
        </div>
        <div class="row">
            <div class="large-9 columns">
                <table id="phoneTable" class="phoneTable" cellpadding="0" cellspacing="0">
                    <thead style="background:none;">
                        <tr>
                            <th width="30%" style="text-align:left;color:#ffffff;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;"><label>Phone</label></th>
                            <th width="40%" style="text-align:center;color:#ffffff;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;"></th>
                            <th width="15%" style="text-align:center;color:#000000;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;">Primary</th>
                            <th width="15%" style="text-align:center;color:#000000;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;">
                             <a class="addPhone"><img src="images/icons/phone_add.png" /></a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="display:none;">
                            <td class="description" style="color:#36413e;text-align:center;">
                                <select class="Description no-margin" sort="" name="description[]">
                                    <option></option>
                                    <option value="Cell">Cell</option>
                                    <option value="Home">Home</option>
                                    <option value="Work">Work</option>
                                    <option value="Other">Other</option>
                                </select>
                            </td>
                            <td class="phoneNumber" style="color:#36413e;">
                                <input class="Phone no-margin phone" sort="" name="phone[]" type="text" value="" />
                            </td>
                            <td class="primary" style="color:#36413e;text-align:center;">
                                <input class="isPrimary no-margin" sort="" name="isPrimary[]" type="checkbox" value="1" />
                            </td>
                            <td class="delete" style="color:#36413e;text-align:center;">
                                <a class="deletePhone"><img src="images/icons/phone_delete.png" /></a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <small style="margin-left: .5rem;" class="error-match onePhone">At least one phone is required.</small> 
                <small style="margin-left: .5rem;" class="error-match fullPhone">Description and complete phone number are required.</small>
                <small style="margin-left: .5rem;" class="error-match primary">Please mark one phone number as primary.</small> 
            </div>
        </div>
        <div class="row">
            <div class="medium-8 columns">
                <label>Project Description (House, Garage, etc.) <small>required</small>
                    <input class="customerRequired" name="projectDescription" type="text" value="" />
                    <small class="form-error">Description is required.</small>
                </label>
            </div>
        </div>
        <div class="row">
            <div class="medium-8 columns">
                <label>
                    Project Salesperson
                    <select name="projectSalesperson">
                        <option value=""></option>
                    </select>
                </label>
            </div>
        </div>
        <div class="row">
            <div class="medium-8 columns">
                <label for="referralDropdown">How did you hear about us?</label>
                    <select id="referralDropdown" name="referralDropdown" type="text" value="">
                        <option value="0">Select one</option>
                    </select>
            </div>
            <br>
            <div class="large-5 columns"></div>
        </div>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    <button class="button" id="saveEditCustomerModal">Save</button> 
                    <button class="button secondary" id="closeEditCustomerModal">Cancel</button>
                </p>
            </div>
        </div>
        <div id="fetchedEmail" class="is-hidden"><?php echo $email; ?></div>
    </div>
    <div class="tiny reveal" id="editCustomerErrorModal" data-reveal>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center error-text" style="margin-top: 1rem;"></p>    
                <p class="text-center no-margin">
                    <button data-open="editCustomerModal" class="button">OK</button>
                </p> 
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="editCustomerSuccessModal" data-reveal>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    This project has been udpated!
                    <br/><br/>
                    <button class="button" data-close>OK</button>
                </p> 
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="projectCompleteSuccessModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Project Complete</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    This project is complete.
                    <br/><br/>
                    <button class="button" data-close>OK</button>
                </p> 
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="emailWontSendModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Email Will Not Send</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                </p> 
            </div>
            <div class="medium-12 columns text-center">
                <br/>
                <button class="button" id="continueWithoutEmail">Yes</button>
                <button class="button" id="cancelContinueWithoutEmail">Cancel</button>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="emailWontSendModalSchedule" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Email Will Not Send</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                </p> 
            </div>
            <div class="medium-12 columns text-center">
                <br/>
                <button class="button" id="continueWithoutEmailSchedule">Yes</button>
                <button class="button" id="dontContinueWithoutEmail">Cancel</button>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="deleteProjectDocumentModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Delete Project Document</h3>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    Are you sure you want to delete this document? This action is not reversible. 
                    <br /><br />
                    <button class="button" id="yesDeleteDocument">Yes</button>
                    <button class="button secondary" data-close>Cancel</button>
                    <input type="hidden" id="idToDelete" name="idToDelete" value=""/>
                    <input type="hidden" id="fileName" name="fileName" value=""/>
                    <input type="hidden" id="fileDescription" name="fileDescription" value=""/>
                </p>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="deleteSuccessModal" data-reveal>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin" id="modalMessage">
                    Your file has been deleted.
                    <br/><br/>
                </p> 
                <p class="text-center no-margin">
                    <br/>
                    <button class="button" data-close>OK</button>
                </p>
            </div>
        </div>
    </div>
    <div class="tiny reveal" id="addContactsModal" data-reveal data-close-on-esc="false" data-close-on-click="false">
        <h3 class="text-center">Project Contacts</h3>
        <p class="text-center no-margin">
            <small>Project contacts will be CC'ed on all emails that are sent for this project.</small>
        </p>
        <br/>
            <div class="row">
                <div class="large-12 columns text-center">
                    <table id="emailTable" class="emailTable" cellpadding="0" cellspacing="0">
                        <thead style="background:none;">
                            <tr>
                                <th width="45%" style="text-align:left;color:#000000;line-height: .5rem;border-bottom:0;padding:0.4rem 0rem 0.4rem 0.7rem;font-weight: normal;font-size: 0.875rem;">Name <span data-tooltip aria-haspopup="true" class="has-tip top" data-disable-hover="false" tabindex="6" title="This is the name that the email will be addressed to."><img src="images/icons/info.png" /></span></th>
                                <th width="45%" style="text-align:left;color:#000000;line-height: .5rem;border-bottom:0;padding:0.4rem 0rem 0.4rem 0.7rem;font-weight: normal;font-size: 0.875rem;">Email</th>
                                 <th width="10%" style="text-align:center;color:#000000;line-height: .5rem;border-bottom:0;padding:0rem 0.4rem;">
                                 <a class="addEmail"><img src="images/icons/phone_add.png" /></a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="display:none;">
                                <td style="color:#36413e;border-bottom:0;">
                                    <input name="name" class="no-margin" type="text" value="" maxlength ="70"/>
                                </td>
                                <td style="color:#36413e;text-align:center;border-bottom:0;">
                                    <input name="contactEmail" class="no-margin" type="text" value="" sort="" maxlength ="100"/>
                                </td>
                                <td class="delete" style="color:#36413e;text-align:center;border-bottom:0;">
                                    <a class="deleteEmail"><img src="images/icons/phone_delete.png" /></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="row">
                        <div class="medium-5 columns text-center">
                            <small style="text-align: left;padding-left: 0.7rem;" class="error-match contactName">A name is required.</small>
                        </div>
                        <div class="medium-5 columns text-center">
                            <small style="text-align: left;padding-left: 1rem;" class="error-match contactEmail">A valid email is required.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="medium-12 columns text-center">
                <br/>
                <button class="button" id="saveProjectContacts">Save</button>
                <button class="button secondary" id="closeProjectContacts">Cancel</button>
            </div>
    </div>
    <div class="tiny reveal" id="addContactsSuccessModal" data-reveal>
        <div class="row">
            <div class="medium-12 columns">
                <p class="text-center no-margin">
                    The project contacts have been updated.
                    <br/><br/>
                    <button class="button" data-close>OK</button>
                </p> 
            </div>
        </div>
    </div>
    <input id="projectID" type="hidden" name="projectID" value="<?php echo $projectID;  ?>" />
    <input id="currentDate" type="hidden" name="currentDate" value="<?php echo $todaysDateDefault;  ?>" />
    <input id="eventType" type="hidden" name="eventType" value="" />
    <div id="customerID" class="is-hidden"><?php echo $customerID; ?></div>
    <div id="propertyID" class="is-hidden"><?php echo $thisPropertyID; ?></div>
    <div id="firstName" class="is-hidden"><?php echo $firstName; ?></div>
    <div id="lastName" class="is-hidden"><?php echo $lastName; ?></div>
    <div id="address" class="is-hidden"><?php echo $address; ?></div>
    <div id="address2" class="is-hidden"><?php echo $address2; ?></div>
    <div id="city" class="is-hidden"><?php echo $city; ?></div>
    <div id="state" class="is-hidden"><?php echo $state; ?></div>
    <div id="zip" class="is-hidden"><?php echo $zip; ?></div>
    <div id="latitude" class="is-hidden"><?php echo $latitude;  ?></div>
    <div id="longitude" class="is-hidden"><?php echo $longitude;  ?></div>
    <div id="unsubscribedStatus" class="is-hidden"><?php echo $unsubscribed;  ?></div>
    <div id="noEmailRequiredStatus" class="is-hidden"><?php echo $noEmailRequired;  ?></div>
    <?php  include_once 'setup-modal.html'  ?>
    <?php  include_once 'footer.html'  ?>


    <script src="js/foundation.min.js"></script>
    <script>
        $(document).foundation();
    </script>
    <script type="text/javascript" src="js/jquery.mask.min.js"></script>
    <script type="text/javascript">
        $(function () {
            $('.Phone').mask('(000) 000-0000');
            // $('.date').mask('11/11/1111');
            $('.number').mask('00000000000');
            // $('.time').mask('Hh:Mm Pp',
            //    {
            //        'translation': {
            //            H: { pattern: /[0-1]/ },
            //            h: { pattern: /[0-9]/ },
            //            M: { pattern: /[0-5]/ },
            //            m: { pattern: /[0-9]/ },
            //            P: { pattern: /[AaPp]/ },
            //            p: { pattern: /[Mm]/ }
            //        }
               // });
        });
    </script>
    <script src='js/autosize.min.js'></script>
    <script>
        autosize(document.querySelectorAll('textarea'));
    </script>
</body>
</html>